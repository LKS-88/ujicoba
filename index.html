<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APLIKASI KASIR SUPERMARKET</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary: #007bff; /* Warna biru untuk supermarket */
            --primary-light: #cce5ff;
            --secondary: #0056b3;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #343a40;
            --gray: #6c757d;
            --white: #ffffff;
            --shadow-sm: 0 0.15rem 0.35rem rgba(0,0,0,0.1);
            --shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
            --rounded-sm: 0.35rem;
            --rounded: 0.75rem;
            --rounded-lg: 1rem;
            --donation: #6f42c1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: #f0f2f5;
            color: #212529;
            line-height: 1.5;
            touch-action: manipulation;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 12px;
        }

        /* Header Styles */
        .app-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--white);
            padding: 12px 16px;
            border-radius: var(--rounded);
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-title-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-logo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--white);
            padding: 5px;
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: var(--primary);
        }

        .app-title {
            font-size: 1.4rem;
            font-weight: 600;
        }

        .header-info {
            text-align: right;
            font-size: 0.9rem;
        }

        .header-info p {
            margin: 2px 0;
        }
        
        /* [BARU] Shift Status Styles */
        #shiftStatusContainer {
            background-color: rgba(255,255,255,0.2);
            padding: 5px 8px;
            border-radius: 20px;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
        }
        #shiftStatusBadge {
            font-weight: 500;
        }
        #shiftStatusBadge.active {
            color: #aeffae;
        }
        #shiftActionBtn {
            padding: 3px 8px;
            font-size: 0.75rem;
            width: auto !important;
            border-radius: 15px;
        }
        /* Akhir dari [BARU] */

        /* Main Content Layout */
        .app-content {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* Panel Styles */
        .panel {
            background: var(--white);
            border-radius: var(--rounded);
            padding: 16px;
            box-shadow: var(--shadow-sm);
        }

        .panel-title {
            font-size: 1.2rem;
            margin-bottom: 12px;
            color: var(--dark);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* Product Grid */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .product-card {
            background: var(--white);
            border-radius: var(--rounded-sm);
            padding: 12px;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s;
            border: 1px solid #eee;
            cursor: pointer;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
            border-color: var(--primary);
        }

        .product-image {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--light);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            overflow: hidden;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .product-image i {
            font-size: 1.5rem;
            color: var(--gray);
        }

        .product-name {
            font-weight: 500;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }

        .product-price {
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 4px;
        }

        .product-stock {
            font-size: 0.8rem;
            font-weight: 500;
        }
        .product-stock.low { color: var(--warning); }
        .product-stock.out-of-stock { color: var(--danger); }

        .product-category {
            font-size: 0.7rem;
            color: var(--gray);
            background-color: var(--light);
            padding: 2px 6px;
            border-radius: 10px;
            margin-top: 4px;
        }

        /* Search and Filter */
        .search-container {
            position: relative;
            margin-bottom: 16px;
        }

        .search-container i {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 40px;
            border: 1px solid #ddd;
            border-radius: var(--rounded-sm);
            font-size: 1rem;
        }

        .filter-row {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            overflow-x: auto;
            padding-bottom: 4px;
        }

        .filter-chip {
            padding: 8px 12px;
            background: var(--light);
            border-radius: 20px;
            font-size: 0.9rem;
            white-space: nowrap;
            cursor: pointer;
        }

        .filter-chip.active {
            background: var(--primary);
            color: var(--white);
        }

        /* Order Styles */
        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }

        .order-item-info {
            flex: 1;
        }

        .order-item-name {
            font-weight: 500;
        }

        .order-item-price {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .whatsapp-link {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }
        .whatsapp-link:hover {
            text-decoration: underline;
        }

        .order-item-qty {
            display: flex;
            align-items: center;
        }

        .qty-btn {
            width: 32px;
            height: 32px;
            border: 1px solid #ddd;
            background: var(--light);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .qty-input {
            width: 40px;
            text-align: center;
            margin: 0 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 6px;
        }

        .remove-btn {
            color: var(--danger);
            margin-left: 8px;
            cursor: pointer;
        }

        /* Summary Styles */
        .summary-container {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px dashed #ddd;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .total-row {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--primary);
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #ddd;
        }

        /* Button Styles */
        .btn {
            display: inline-block;
            padding: 12px 20px;
            background-color: var(--primary);
            color: var(--white);
            border: none;
            border-radius: var(--rounded-sm);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            text-align: center;
            transition: all 0.2s;
            width: 100%;
        }
        
        .btn:disabled {
            background-color: var(--gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn:hover:not(:disabled) {
            background-color: var(--secondary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .btn:active:not(:disabled) {
            transform: translateY(0);
        }
        
        .btn .fa-spinner {
            margin-right: 8px;
        }

        .btn-sm {
            padding: 8px 12px;
            font-size: 0.9rem;
        }

        .btn-success {
            background-color: var(--success);
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-danger {
            background-color: var(--danger);
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-warning {
            background-color: var(--warning);
            color: #000;
        }

        .btn-warning:hover {
            background-color: #e0a800;
        }

        .btn-info {
            background-color: var(--info);
        }

        .btn-info:hover {
            background-color: #138496;
        }
        
        .btn-outline-primary {
            background-color: transparent;
            color: var(--primary);
            border: 1px solid var(--primary);
        }
        
        .btn-outline-primary:hover {
            background-color: var(--primary);
            color: var(--white);
        }

        .btn-donation {
            background-color: var(--donation);
        }

        .btn-donation:hover {
            background-color: #5a32a3;
        }

        /* Tab Styles */
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 16px;
            overflow-x: auto;
        }

        .tab {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            text-align: center;
            flex: 1;
        }

        .tab.active {
            border-bottom: 3px solid var(--primary);
            color: var(--primary);
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background-color: var(--white);
            border-radius: var(--rounded-lg);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
            animation: fadeIn 0.3s;
        }

        .modal-header {
            padding: 16px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }

        .modal-body {
            padding: 16px;
        }

        .modal-footer {
            padding: 16px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-check {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: var(--rounded-sm);
            font-size: 1rem;
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        /* === [PERBAIKAN] DESAIN LOGIN === */
        #loginModal {
            background: linear-gradient(45deg, #f0f2f5, #e6e9ed);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-container {
            width: 100%;
            max-width: 400px;
            margin: 0;
            background: var(--white);
            border-radius: var(--rounded-lg);
            padding: 32px;
            box-shadow: var(--shadow);
            border-top: 5px solid var(--primary);
            animation: fadeIn 0.4s;
        }

        .login-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .login-logo {
            font-size: 3.5rem;
            color: var(--primary);
            margin-bottom: 12px;
            line-height: 1;
        }

        .login-title {
            font-size: 2rem;
            color: var(--dark);
            font-weight: 700;
            letter-spacing: 1px;
        }
        
        .login-header p {
            color: var(--gray);
        }
        /* === AKHIR DARI PERBAIKAN DESAIN LOGIN === */

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 16px;
            background-color: var(--dark);
            color: var(--white);
            border-radius: var(--rounded-sm);
            box-shadow: var(--shadow);
            z-index: 1100;
            display: flex;
            align-items: center;
            transform: translateX(200%);
            transition: transform 0.3s;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background-color: var(--success);
        }

        .toast.error {
            background-color: var(--danger);
        }

        .toast.warning {
            background-color: var(--warning);
            color: #000;
        }

        .toast i {
            margin-right: 8px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 24px;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 3rem;
            color: #ddd;
            margin-bottom: 12px;
        }

        /* Admin Panel */
        .admin-panel {
            display: none;
            margin-top: 16px;
            padding: 16px;
            background-color: var(--light);
            border-radius: var(--rounded);
        }
        
        .admin-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        /* Table Styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 16px;
        }

        .data-table th, .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background-color: var(--light);
            font-weight: 600;
        }

        .data-table tr:hover {
            background-color: #f9f9f9;
        }
        
        .data-table .text-danger { color: var(--danger) !important; font-weight: 500; }
        .data-table .text-success { color: var(--success) !important; font-weight: 500; }
        .data-table .text-warning { color: var(--warning) !important; font-weight: 500; }

        /* product Actions */
        .product-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            display: none;
            gap: 4px;
        }

        .product-card:hover .product-actions {
            display: flex;
        }

        .action-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.7rem;
            color: white;
        }

        .edit-btn {
            background-color: var(--info);
        }

        .delete-btn {
            background-color: var(--danger);
        }

        /* Note Input */
        .note-input {
            margin-top: 12px;
        }

        .note-input textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: var(--rounded-sm);
            resize: vertical;
            min-height: 60px;
        }

        /* Member Search */
        .member-search-container {
            position: relative;
        }

        .member-search-results {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 var(--rounded-sm) var(--rounded-sm);
            z-index: 100;
            display: none;
        }

        .member-search-item {
            padding: 8px 12px;
            cursor: pointer;
        }

        .member-search-item:hover {
            background-color: var(--light);
        }
        
        /* Payment Modal Enhancements */
        .payment-total-display {
            background: var(--primary-light);
            border-radius: var(--rounded);
            padding: 16px;
            text-align: center;
            margin-bottom: 16px;
        }
        
        .payment-total-display p {
            font-size: 1rem;
            color: var(--secondary);
            margin: 0;
        }
        
        .payment-total-display h3 {
            font-size: 2rem;
            color: var(--primary);
            margin: 0;
        }
        
        .quick-cash-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin: 16px 0;
        }

        /* Member Badge */
        .member-badge {
            background-color: var(--info);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 6px;
        }

        /* Donation Badge */
        .donation-badge {
            background-color: var(--donation);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 6px;
        }

        /* Responsive Adjustments */
        @media (min-width: 768px) {
            .app-content {
                flex-direction: row;
            }
            
            .product-panel {
                flex: 2;
            }
            
            .order-panel {
                flex: 1;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-content {
            animation: fadeIn 0.3s;
        }

        /* Utility Classes */
        .text-center {
            text-align: center;
        }

        .mt-2 {
            margin-top: 8px;
        }

        .mt-3 {
            margin-top: 16px;
        }

        .mb-2 {
            margin-bottom: 8px;
        }

        .mb-3 {
            margin-bottom: 16px;
        }

        .d-flex {
            display: flex;
        }

        .justify-between {
            justify-content: space-between;
        }

        .align-center {
            align-items: center;
        }

        .gap-2 {
            gap: 8px;
        }
        
        /* Footer */
        .app-footer {
            text-align: center;
            margin-top: 20px;
            padding: 10px;
            color: var(--gray);
            font-size: 0.8rem;
        }
        
        /* === [PENYEMPURNAAN] KODE CETAK STRUK & HISTORI === */
        #receiptContent {
            font-family: 'Courier New', Courier, monospace;
            width: 300px;
            margin: 0 auto;
            padding: 15px;
            font-size: 12px;
            line-height: 1.3;
            color: #000;
            background: white;
        }

        .receipt-header {
            text-align: center;
            margin-bottom: 8px;
        }
        
        .receipt-title {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 3px;
        }

        .receipt-info {
            margin-bottom: 8px;
            font-size: 11px;
            border-top: 1px dashed #000;
            border-bottom: 1px dashed #000;
            padding: 5px 0;
        }
        
        .receipt-info div {
            display: flex;
            justify-content: space-between;
        }

        .receipt-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
        }
        
        .receipt-item-details {
            display: block;
        }
        
        .receipt-item-details .item-name {
            font-weight: bold;
        }
        .receipt-item-details .item-price-calc {
            font-size: 10px;
            padding-left: 5px;
        }
        
        #receiptItemsContainer {
             padding: 8px 0;
        }

        .receipt-total {
            font-weight: bold;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed #000;
        }

        .receipt-footer {
            margin-top: 12px;
            font-size: 10px;
            text-align: center;
        }
        
        @media print {
            html, body {
                width: 100%; height: auto; margin: 0 !important; padding: 0 !important;
                overflow: visible !important; box-shadow: none;
            }
            body * { visibility: hidden; }
            #print-container, #print-container * {
                visibility: visible; box-sizing: border-box !important;
            }
            #print-container {
                position: absolute; left: 0; top: 0; width: 100%; height: auto;
                margin: 0; padding: 0; display: block !important;
            }
            #print-container .printable-area, #print-container #receiptContent, #print-container .recap-printable-area {
                margin: 0 !important; padding: 5px !important; box-shadow: none !important;
                border: none !important; display: block !important; color: #000 !important;
                background: #fff !important; width: 100% !important; 
                font-size: 11pt !important; page-break-inside: avoid;
            }
            #print-container #receiptContent { font-size: 10pt !important; }
            #print-container #historyResultsContainer, #print-container #historyResults {
                max-height: none !important; overflow: visible !important; height: auto !important;
            }
            .no-print, .modal-footer, .modal-header, .app-header, .app-footer, .order-panel, .product-panel, #loginModal {
                display: none !important;
            }
            @page { size: auto; margin: 10mm; }
        }
        /* === AKHIR DARI PENYEMPURNAAN KODE CETAK === */

        /* Backup Restore Styles */
        .backup-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .backup-btn {
            flex: 1;
        }

        .file-input {
            display: none;
        }

        .file-label {
            display: block;
            padding: 12px;
            background-color: var(--info);
            color: white;
            border-radius: var(--rounded-sm);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-label:hover {
            background-color: #138496;
        }
        
        /* KTA Card Design */
        #ktaCard {
            width: 320px;
            height: 500px;
            margin: 0 auto;
            border-radius: 20px;
            background: radial-gradient(circle at top left, #4f5bd5, #007bff, #17a2b8);
            color: white;
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        #ktaCard::before, #ktaCard::after {
            content: ''; position: absolute; background: rgba(255,255,255,0.1);
            border-radius: 50%; filter: blur(10px);
        }
        #ktaCard::before { top: -80px; left: -80px; width: 200px; height: 200px; }
        #ktaCard::after { bottom: -100px; right: -60px; width: 250px; height: 250px; }
        
        .kta-header {
            text-align: center; border-bottom: 1px solid rgba(255,255,255,0.3);
            padding-bottom: 15px; margin-bottom: 25px; z-index: 1;
        }
        .kta-store-info h3 { font-size: 18px; margin: 0; font-weight: 700; text-shadow: 1px 1px 3px rgba(0,0,0,0.3); }
        .kta-store-info p { font-size: 11px; margin: 0; opacity: 0.9; }
        .kta-body {
            flex-grow: 1; display: flex; flex-direction: column; justify-content: center;
            align-items: center; text-align: center; z-index: 1;
        }
        #ktaMemberName { font-size: 26px; font-weight: 600; margin-bottom: 8px; text-shadow: 1px 1px 3px rgba(0,0,0,0.4); }
        #ktaMemberId {
            font-family: 'Courier New', monospace; font-size: 14px; background-color: rgba(0,0,0,0.3);
            padding: 4px 12px; border-radius: 20px; display: inline-block; margin-bottom: 20px; letter-spacing: 1px;
        }
        .kta-qrcode {
            background: white; padding: 10px; border-radius: 8px; min-height: 160px;
            display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .kta-qrcode img { width: 160px; height: auto; display: block; }
        .kta-footer {
            text-align: center; font-size: 11px; opacity: 0.8; padding-top: 15px;
            margin-top: 25px; border-top: 1px solid rgba(255,255,255,0.3); z-index: 1;
        }

        /* [BARU] Role Management Styles */
        .permission-group {
            margin-bottom: 16px;
        }
        .permission-group-title {
            font-weight: 600;
            margin-bottom: 8px;
            border-bottom: 1px solid #eee;
            padding-bottom: 4px;
        }
        .permission-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .permission-item input {
            margin-right: 10px;
        }

        /* [BARU] Recap Report Styles */
        .recap-filter-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            align-items: flex-end;
            padding: 16px;
            background-color: var(--light);
            border-radius: var(--rounded-sm);
            margin-bottom: 16px;
        }
        .recap-summary-card {
            background: var(--primary-light);
            border-left: 5px solid var(--primary);
            padding: 12px;
            border-radius: var(--rounded-sm);
            margin-bottom: 12px;
        }
        .recap-summary-card .title {
            font-weight: 600;
            color: var(--secondary);
            margin-bottom: 4px;
        }
        .recap-summary-card .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        /* [PERBAIKAN] WhatsApp Member Styles */
        .whatsapp-member {
            color: #25D366;
            text-decoration: none;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-top: 4px;
        }
        .whatsapp-member:hover {
            text-decoration: underline;
            color: #128C7E;
        }
    </style>
</head>
<body>
    <div id="toast" class="toast">
        <i class="fas fa-info-circle"></i>
        <span id="toast-message">Notification message</span>
    </div>

    <div id="loginModal" class="modal" style="display: flex;">
        <div class="login-container">
            <div class="login-header">
                <div class="login-logo">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <h1 class="login-title">SUPERMARKET</h1>
                <p>Aplikasi Kasir Digital</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username" class="form-label">Username</label>
                    <input type="text" id="username" class="form-control" placeholder="Masukkan username" required>
                </div>
                <div class="form-group">
                    <label for="password" class="form-label">Password</label>
                    <input type="password" id="password" class="form-control" placeholder="Masukkan password" required>
                </div>
                
                <div class="form-group mt-3">
                    <label for="captcha" class="form-label">Verifikasi Keamanan</label>
                    <div class="d-flex align-center gap-2">
                        <canvas id="captchaCanvas" width="150" height="40" style="border: 1px solid #ddd; border-radius: var(--rounded-sm);"></canvas>
                        <button type="button" id="reloadCaptchaBtn" class="btn btn-sm" style="width: auto; background-color: var(--gray);"><i class="fas fa-sync-alt"></i></button>
                    </div>
                    <input type="text" id="captchaInput" class="form-control mt-2" placeholder="Masukkan kode di atas" required autocomplete="off">
                </div>
                <button type="submit" class="btn mt-3">Login</button>
            </form>
        </div>
    </div>

    <div class="container" id="mainApp" style="display: none;">
        <header class="app-header">
            <div class="header-title-container">
                <div class="header-logo">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <div>
                    <h1 class="app-title" id="storeNameHeader">SUPERMARKET</h1>
                    <p id="currentDate">Rabu, 24 September 2025</p>
                </div>
            </div>
            <div class="header-info">
                <p>Kasir: <span id="loggedInUser">Admin</span></p>
                <div id="shiftStatusContainer">
                    <span id="shiftStatusBadge">Tidak Ada Shift Aktif</span>
                    <button id="shiftActionBtn" class="btn btn-sm btn-warning">Mulai Shift</button>
                </div>
                <p><a href="#" id="logoutBtn" style="color: white; margin-top: 5px; display: inline-block;">Logout</a></p>
            </div>
        </header>

        <main class="app-content">
            <section class="panel product-panel">
                <h2 class="panel-title">
                    <span>Daftar Produk</span>
                    <span id="productCount">(0 produk)</span>
                </h2>
                
                <div class="search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" id="productSearch" class="search-input" placeholder="Cari produk...">
                </div>
                
                <div class="filter-row">
                    <div class="filter-chip active" data-category="all">Semua</div>
                    <div class="filter-chip" data-category="food">Makanan</div>
                    <div class="filter-chip" data-category="drink">Minuman</div>
                    <div class="filter-chip" data-category="snack">Snack</div>
                    <div class="filter-chip" data-category="other">Lainnya</div>
                </div>
                
                <div class="product-grid" id="productGrid">
                    <!-- Product cards will be generated here -->
                </div>
                
                <div class="admin-panel" id="adminPanel">
                    <h3 class="panel-title">Manajemen Produk</h3>
                    <div class="admin-grid">
                        <button id="addProductBtn" class="btn btn-success"><i class="fas fa-plus"></i> Tambah Produk</button>
                        <button id="manageStockBtn" class="btn btn-info"><i class="fas fa-boxes"></i> Kelola Stok</button>
                        <button id="manageCategoriesBtn" class="btn btn-warning"><i class="fas fa-tags"></i> Kelola Kategori</button>
                        <button id="manageMembersBtn" class="btn btn-donation"><i class="fas fa-users"></i> Kelola Member</button>
                    </div>
                </div>
            </section>
            
            <section class="panel order-panel">
                <h2 class="panel-title">Transaksi</h2>
                
                <div class="form-group">
                    <label for="memberSearch" class="form-label">Cari Member (opsional)</label>
                    <div class="member-search-container">
                        <input type="text" id="memberSearch" class="form-control" placeholder="Nama atau ID member">
                        <div class="member-search-results" id="memberSearchResults"></div>
                    </div>
                    <div id="selectedMemberInfo" class="mt-2" style="display: none;"></div>
                </div>
                
                <div id="orderItemsContainer">
                    <!-- Order items will be generated here -->
                </div>
                
                <div class="summary-container">
                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span id="subtotal">Rp 0</span>
                    </div>
                    <div class="summary-row">
                        <span>Diskon:</span>
                        <span id="discount">Rp 0</span>
                    </div>
                    <div class="summary-row">
                        <span>Pajak (10%):</span>
                        <span id="tax">Rp 0</span>
                    </div>
                    <div class="summary-row total-row">
                        <span>Total:</span>
                        <span id="total">Rp 0</span>
                    </div>
                </div>
                
                <div class="note-input">
                    <textarea id="orderNote" placeholder="Catatan untuk transaksi ini..."></textarea>
                </div>
                
                <button id="checkoutBtn" class="btn btn-success mt-3">Proses Pembayaran</button>
                <button id="cancelOrderBtn" class="btn btn-danger mt-2">Batalkan Transaksi</button>
            </section>
        </main>

        <div class="app-footer">
            <p>&copy; 2025 Aplikasi Kasir Supermarket - v2.0</p>
        </div>
    </div>

    <!-- Modal for Product Management -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="productModalTitle">Tambah Produk Baru</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="productId">
                    <div class="form-group">
                        <label for="productName" class="form-label">Nama Produk</label>
                        <input type="text" id="productName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="productPrice" class="form-label">Harga</label>
                        <input type="number" id="productPrice" class="form-control" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="productStock" class="form-label">Stok</label>
                        <input type="number" id="productStock" class="form-control" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="productCategory" class="form-label">Kategori</label>
                        <select id="productCategory" class="form-control" required>
                            <option value="food">Makanan</option>
                            <option value="drink">Minuman</option>
                            <option value="snack">Snack</option>
                            <option value="other">Lainnya</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="productImage" class="form-label">Gambar Produk (URL)</label>
                        <input type="text" id="productImage" class="form-control" placeholder="https://example.com/image.jpg">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="deleteProductBtn" style="display: none;">Hapus Produk</button>
                <button class="btn" id="saveProductBtn">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Modal for Stock Management -->
    <div id="stockModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Kelola Stok Produk</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" id="stockSearch" class="search-input" placeholder="Cari produk...">
                </div>
                <div id="stockList" style="max-height: 400px; overflow-y: auto;">
                    <!-- Stock items will be generated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="closeStockBtn">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Modal for Category Management -->
    <div id="categoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Kelola Kategori Produk</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="newCategoryName" class="form-label">Tambah Kategori Baru</label>
                    <input type="text" id="newCategoryName" class="form-control" placeholder="Nama kategori">
                </div>
                <button class="btn btn-success" id="addCategoryBtn">Tambah Kategori</button>
                
                <div class="mt-3">
                    <h4>Daftar Kategori</h4>
                    <div id="categoryList">
                        <!-- Categories will be generated here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="closeCategoryBtn">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Modal for Member Management -->
    <div id="memberModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Kelola Member</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="newMemberName" class="form-label">Tambah Member Baru</label>
                    <input type="text" id="newMemberName" class="form-control" placeholder="Nama member">
                </div>
                <div class="form-group">
                    <label for="newMemberPhone" class="form-label">Nomor WhatsApp</label>
                    <input type="text" id="newMemberPhone" class="form-control" placeholder="Contoh: 6281234567890">
                </div>
                <button class="btn btn-success" id="addMemberBtn">Tambah Member</button>
                
                <div class="mt-3">
                    <h4>Daftar Member</h4>
                    <div class="search-container">
                        <i class="fas fa-search"></i>
                        <input type="text" id="memberSearchList" class="search-input" placeholder="Cari member...">
                    </div>
                    <div id="memberList" style="max-height: 300px; overflow-y: auto;">
                        <!-- Members will be generated here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="closeMemberBtn">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Modal for Payment -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Pembayaran</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="payment-total-display">
                    <p>Total yang harus dibayar:</p>
                    <h3 id="paymentTotal">Rp 0</h3>
                </div>
                
                <div class="form-group">
                    <label for="paymentMethod" class="form-label">Metode Pembayaran</label>
                    <select id="paymentMethod" class="form-control">
                        <option value="cash">Tunai</option>
                        <option value="debit">Kartu Debit</option>
                        <option value="credit">Kartu Kredit</option>
                        <option value="qris">QRIS</option>
                        <option value="e-wallet">E-Wallet</option>
                    </select>
                </div>
                
                <div class="form-group" id="cashPaymentGroup">
                    <label for="cashAmount" class="form-label">Jumlah Uang Diterima</label>
                    <input type="number" id="cashAmount" class="form-control" min="0">
                    
                    <div class="quick-cash-buttons">
                        <button class="btn btn-sm btn-outline-primary" data-amount="50000">50K</button>
                        <button class="btn btn-sm btn-outline-primary" data-amount="100000">100K</button>
                        <button class="btn btn-sm btn-outline-primary" data-amount="150000">150K</button>
                        <button class="btn btn-sm btn-outline-primary" data-amount="200000">200K</button>
                        <button class="btn btn-sm btn-outline-primary" data-amount="250000">250K</button>
                        <button class="btn btn-sm btn-outline-primary" data-amount="300000">300K</button>
                    </div>
                    
                    <div class="mt-2">
                        <p>Kembalian: <span id="changeAmount">Rp 0</span></p>
                    </div>
                </div>
                
                <div class="form-group" id="donationContainer">
                    <div class="form-check">
                        <input type="checkbox" id="addDonation" class="form-check-input">
                        <label for="addDonation" class="form-check-label">Tambahkan donasi untuk program sosial (Rp 1,000)</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="cancelPaymentBtn">Batal</button>
                <button class="btn btn-success" id="confirmPaymentBtn">Konfirmasi Pembayaran</button>
            </div>
        </div>
    </div>

    <!-- Modal for Receipt -->
    <div id="receiptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Struk Pembayaran</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="receiptContent">
                    <div class="receipt-header">
                        <div class="receipt-title" id="receiptStoreName">SUPERMARKET</div>
                        <div id="receiptStoreAddress">Jl. Contoh No. 123, Kota Contoh</div>
                        <div id="receiptStorePhone">Telp: (021) 123-4567</div>
                    </div>
                    
                    <div class="receipt-info">
                        <div><span>No. Transaksi:</span> <span id="receiptTransactionId">TRX-001</span></div>
                        <div><span>Tanggal:</span> <span id="receiptDate">01/01/2025 10:00:00</span></div>
                        <div><span>Kasir:</span> <span id="receiptCashier">Admin</span></div>
                    </div>
                    
                    <div id="receiptItemsContainer">
                        <!-- Receipt items will be generated here -->
                    </div>
                    
                    <div class="receipt-total">
                        <div><span>Subtotal:</span> <span id="receiptSubtotal">Rp 0</span></div>
                        <div><span>Pajak (10%):</span> <span id="receiptTax">Rp 0</span></div>
                        <div><span>Total:</span> <span id="receiptTotal">Rp 0</span></div>
                        <div><span>Bayar:</span> <span id="receiptPayment">Rp 0</span></div>
                        <div><span>Kembali:</span> <span id="receiptChange">Rp 0</span></div>
                    </div>
                    
                    <div class="receipt-footer">
                        <div>Terima kasih atas kunjungan Anda</div>
                        <div>Barang yang sudah dibeli tidak dapat ditukar/dikembalikan</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="printReceiptBtn">Cetak Struk</button>
                <button class="btn" id="closeReceiptBtn">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Modal for Settings -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Pengaturan Aplikasi</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <div class="tab active" data-tab="general">Umum</div>
                    <div class="tab" data-tab="store">Toko</div>
                    <div class="tab" data-tab="backup">Backup & Restore</div>
                    <div class="tab" data-tab="users">Pengguna</div>
                </div>
                
                <div class="tab-content active" id="generalTab">
                    <div class="form-group">
                        <label for="taxRate" class="form-label">Tarif Pajak (%)</label>
                        <input type="number" id="taxRate" class="form-control" min="0" max="100" value="10">
                    </div>
                    <div class="form-group">
                        <label for="currency" class="form-label">Mata Uang</label>
                        <select id="currency" class="form-control">
                            <option value="IDR">Rupiah (IDR)</option>
                            <option value="USD">Dollar (USD)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <div class="form-check">
                            <input type="checkbox" id="enableSound" class="form-check-input" checked>
                            <label for="enableSound" class="form-check-label">Aktifkan suara notifikasi</label>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="storeTab">
                    <div class="form-group">
                        <label for="storeName" class="form-label">Nama Toko</label>
                        <input type="text" id="storeName" class="form-control" value="SUPERMARKET">
                    </div>
                    <div class="form-group">
                        <label for="storeAddress" class="form-label">Alamat Toko</label>
                        <textarea id="storeAddress" class="form-control">Jl. Contoh No. 123, Kota Contoh</textarea>
                    </div>
                    <div class="form-group">
                        <label for="storePhone" class="form-label">Telepon Toko</label>
                        <input type="text" id="storePhone" class="form-control" value="(021) 123-4567">
                    </div>
                    <div class="form-group">
                        <label for="storeReceiptFooter" class="form-label">Catatan Kaki Struk</label>
                        <textarea id="storeReceiptFooter" class="form-control">Terima kasih atas kunjungan Anda\nBarang yang sudah dibeli tidak dapat ditukar/dikembalikan</textarea>
                    </div>
                </div>
                
                <div class="tab-content" id="backupTab">
                    <p>Backup data aplikasi untuk mencegah kehilangan data.</p>
                    <div class="backup-actions">
                        <button class="btn btn-success backup-btn" id="backupDataBtn">Backup Data</button>
                        <label for="restoreFile" class="file-label">Restore Data</label>
                        <input type="file" id="restoreFile" class="file-input" accept=".json">
                    </div>
                </div>
                
                <div class="tab-content" id="usersTab">
                    <div class="form-group">
                        <label for="newUsername" class="form-label">Username Baru</label>
                        <input type="text" id="newUsername" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="newPassword" class="form-label">Password Baru</label>
                        <input type="password" id="newPassword" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="userRole" class="form-label">Role Pengguna</label>
                        <select id="userRole" class="form-control">
                            <option value="admin">Admin</option>
                            <option value="kasir">Kasir</option>
                        </select>
                    </div>
                    <button class="btn btn-success" id="addUserBtn">Tambah Pengguna</button>
                    
                    <div class="mt-3">
                        <h4>Daftar Pengguna</h4>
                        <div id="userList">
                            <!-- Users will be generated here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="saveSettingsBtn">Simpan Pengaturan</button>
            </div>
        </div>
    </div>

    <!-- Modal for Transaction History -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Riwayat Transaksi</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="filter-row">
                    <div class="filter-chip active" data-period="today">Hari Ini</div>
                    <div class="filter-chip" data-period="week">Minggu Ini</div>
                    <div class="filter-chip" data-period="month">Bulan Ini</div>
                    <div class="filter-chip" data-period="all">Semua</div>
                </div>
                
                <div class="search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" id="historySearch" class="search-input" placeholder="Cari transaksi...">
                </div>
                
                <div id="historyResults" style="max-height: 400px; overflow-y: auto;">
                    <!-- History items will be generated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="closeHistoryBtn">Tutup</button>
                <button class="btn btn-info" id="printHistoryBtn">Cetak Laporan</button>
            </div>
        </div>
    </div>

    <!-- Modal for KTA Member -->
    <div id="ktaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Kartu Tanda Anggota (KTA)</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="ktaMemberSelect" class="form-label">Pilih Member</label>
                    <select id="ktaMemberSelect" class="form-control">
                        <!-- Member options will be generated here -->
                    </select>
                </div>
                
                <div id="ktaCard">
                    <div class="kta-header">
                        <div class="kta-store-info">
                            <h3 id="ktaStoreName">SUPERMARKET</h3>
                            <p>Kartu Tanda Anggota</p>
                        </div>
                    </div>
                    <div class="kta-body">
                        <div id="ktaMemberName">Nama Member</div>
                        <div id="ktaMemberId">ID: MEM-001</div>
                        <div class="kta-qrcode">
                            <div id="ktaQrCode"></div>
                        </div>
                    </div>
                    <div class="kta-footer">
                        <div id="ktaMemberPhone">WhatsApp: 08123456789</div>
                        <div id="ktaMemberSince">Bergabung sejak: Jan 2025</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="printKtaBtn">Cetak KTA</button>
                <button class="btn" id="closeKtaBtn">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Print Container (Hidden) -->
    <div id="print-container" style="display: none;"></div>

    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    
    <script>
        // ===========================
        // INITIALIZATION & VARIABLES
        // ===========================
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize application
            initializeApp();
            
            // Set current date
            updateCurrentDate();
            
            // Generate initial captcha
            generateCaptcha();
            
            // Load initial data
            loadProducts();
            loadCategories();
            loadMembers();
            loadUsers();
            loadTransactions();
            loadSettings();
            
            // Setup event listeners
            setupEventListeners();
        });

        // Application state
        const state = {
            products: [],
            categories: ['food', 'drink', 'snack', 'other'],
            orders: [],
            members: [],
            transactions: [],
            users: [],
            settings: {},
            currentUser: null,
            currentMember: null,
            currentShift: null,
            captchaText: ''
        };

        // DOM Elements
        const elements = {
            // Main app
            loginModal: document.getElementById('loginModal'),
            mainApp: document.getElementById('mainApp'),
            
            // Login
            loginForm: document.getElementById('loginForm'),
            username: document.getElementById('username'),
            password: document.getElementById('password'),
            captchaCanvas: document.getElementById('captchaCanvas'),
            captchaInput: document.getElementById('captchaInput'),
            reloadCaptchaBtn: document.getElementById('reloadCaptchaBtn'),
            logoutBtn: document.getElementById('logoutBtn'),
            
            // Header
            storeNameHeader: document.getElementById('storeNameHeader'),
            currentDate: document.getElementById('currentDate'),
            loggedInUser: document.getElementById('loggedInUser'),
            shiftStatusContainer: document.getElementById('shiftStatusContainer'),
            shiftStatusBadge: document.getElementById('shiftStatusBadge'),
            shiftActionBtn: document.getElementById('shiftActionBtn'),
            
            // Products
            productGrid: document.getElementById('productGrid'),
            productSearch: document.getElementById('productSearch'),
            productCount: document.getElementById('productCount'),
            adminPanel: document.getElementById('adminPanel'),
            
            // Orders
            orderItemsContainer: document.getElementById('orderItemsContainer'),
            memberSearch: document.getElementById('memberSearch'),
            memberSearchResults: document.getElementById('memberSearchResults'),
            selectedMemberInfo: document.getElementById('selectedMemberInfo'),
            subtotal: document.getElementById('subtotal'),
            discount: document.getElementById('discount'),
            tax: document.getElementById('tax'),
            total: document.getElementById('total'),
            orderNote: document.getElementById('orderNote'),
            checkoutBtn: document.getElementById('checkoutBtn'),
            cancelOrderBtn: document.getElementById('cancelOrderBtn'),
            
            // Admin buttons
            addProductBtn: document.getElementById('addProductBtn'),
            manageStockBtn: document.getElementById('manageStockBtn'),
            manageCategoriesBtn: document.getElementById('manageCategoriesBtn'),
            manageMembersBtn: document.getElementById('manageMembersBtn'),
            
            // Modals
            modals: document.querySelectorAll('.modal'),
            modalCloses: document.querySelectorAll('.modal-close'),
            
            // Product modal
            productModal: document.getElementById('productModal'),
            productModalTitle: document.getElementById('productModalTitle'),
            productForm: document.getElementById('productForm'),
            productId: document.getElementById('productId'),
            productName: document.getElementById('productName'),
            productPrice: document.getElementById('productPrice'),
            productStock: document.getElementById('productStock'),
            productCategory: document.getElementById('productCategory'),
            productImage: document.getElementById('productImage'),
            saveProductBtn: document.getElementById('saveProductBtn'),
            deleteProductBtn: document.getElementById('deleteProductBtn'),
            
            // Stock modal
            stockModal: document.getElementById('stockModal'),
            stockSearch: document.getElementById('stockSearch'),
            stockList: document.getElementById('stockList'),
            closeStockBtn: document.getElementById('closeStockBtn'),
            
            // Category modal
            categoryModal: document.getElementById('categoryModal'),
            newCategoryName: document.getElementById('newCategoryName'),
            addCategoryBtn: document.getElementById('addCategoryBtn'),
            categoryList: document.getElementById('categoryList'),
            closeCategoryBtn: document.getElementById('closeCategoryBtn'),
            
            // Member modal
            memberModal: document.getElementById('memberModal'),
            newMemberName: document.getElementById('newMemberName'),
            newMemberPhone: document.getElementById('newMemberPhone'),
            addMemberBtn: document.getElementById('addMemberBtn'),
            memberSearchList: document.getElementById('memberSearchList'),
            memberList: document.getElementById('memberList'),
            closeMemberBtn: document.getElementById('closeMemberBtn'),
            
            // Payment modal
            paymentModal: document.getElementById('paymentModal'),
            paymentTotal: document.getElementById('paymentTotal'),
            paymentMethod: document.getElementById('paymentMethod'),
            cashPaymentGroup: document.getElementById('cashPaymentGroup'),
            cashAmount: document.getElementById('cashAmount'),
            changeAmount: document.getElementById('changeAmount'),
            addDonation: document.getElementById('addDonation'),
            cancelPaymentBtn: document.getElementById('cancelPaymentBtn'),
            confirmPaymentBtn: document.getElementById('confirmPaymentBtn'),
            
            // Receipt modal
            receiptModal: document.getElementById('receiptModal'),
            receiptStoreName: document.getElementById('receiptStoreName'),
            receiptStoreAddress: document.getElementById('receiptStoreAddress'),
            receiptStorePhone: document.getElementById('receiptStorePhone'),
            receiptTransactionId: document.getElementById('receiptTransactionId'),
            receiptDate: document.getElementById('receiptDate'),
            receiptCashier: document.getElementById('receiptCashier'),
            receiptItemsContainer: document.getElementById('receiptItemsContainer'),
            receiptSubtotal: document.getElementById('receiptSubtotal'),
            receiptTax: document.getElementById('receiptTax'),
            receiptTotal: document.getElementById('receiptTotal'),
            receiptPayment: document.getElementById('receiptPayment'),
            receiptChange: document.getElementById('receiptChange'),
            printReceiptBtn: document.getElementById('printReceiptBtn'),
            closeReceiptBtn: document.getElementById('closeReceiptBtn'),
            
            // Settings modal
            settingsModal: document.getElementById('settingsModal'),
            tabs: document.querySelectorAll('.tab'),
            tabContents: document.querySelectorAll('.tab-content'),
            taxRate: document.getElementById('taxRate'),
            currency: document.getElementById('currency'),
            enableSound: document.getElementById('enableSound'),
            storeName: document.getElementById('storeName'),
            storeAddress: document.getElementById('storeAddress'),
            storePhone: document.getElementById('storePhone'),
            storeReceiptFooter: document.getElementById('storeReceiptFooter'),
            backupDataBtn: document.getElementById('backupDataBtn'),
            restoreFile: document.getElementById('restoreFile'),
            newUsername: document.getElementById('newUsername'),
            newPassword: document.getElementById('newPassword'),
            userRole: document.getElementById('userRole'),
            addUserBtn: document.getElementById('addUserBtn'),
            userList: document.getElementById('userList'),
            saveSettingsBtn: document.getElementById('saveSettingsBtn'),
            
            // History modal
            historyModal: document.getElementById('historyModal'),
            historySearch: document.getElementById('historySearch'),
            historyResults: document.getElementById('historyResults'),
            closeHistoryBtn: document.getElementById('closeHistoryBtn'),
            printHistoryBtn: document.getElementById('printHistoryBtn'),
            
            // KTA modal
            ktaModal: document.getElementById('ktaModal'),
            ktaMemberSelect: document.getElementById('ktaMemberSelect'),
            ktaStoreName: document.getElementById('ktaStoreName'),
            ktaMemberName: document.getElementById('ktaMemberName'),
            ktaMemberId: document.getElementById('ktaMemberId'),
            ktaQrCode: document.getElementById('ktaQrCode'),
            ktaMemberPhone: document.getElementById('ktaMemberPhone'),
            ktaMemberSince: document.getElementById('ktaMemberSince'),
            printKtaBtn: document.getElementById('printKtaBtn'),
            closeKtaBtn: document.getElementById('closeKtaBtn'),
            
            // Toast
            toast: document.getElementById('toast'),
            toastMessage: document.getElementById('toast-message'),
            
            // Print container
            printContainer: document.getElementById('print-container')
        };

        // ===========================
        // INITIALIZATION FUNCTIONS
        // ===========================
        function initializeApp() {
            // Check if user is already logged in
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                state.currentUser = JSON.parse(savedUser);
                showMainApp();
            } else {
                elements.loginModal.style.display = 'flex';
            }
            
            // Load default settings if not exists
            if (!localStorage.getItem('settings')) {
                const defaultSettings = {
                    taxRate: 10,
                    currency: 'IDR',
                    enableSound: true,
                    storeName: 'SUPERMARKET',
                    storeAddress: 'Jl. Contoh No. 123, Kota Contoh',
                    storePhone: '(021) 123-4567',
                    storeReceiptFooter: 'Terima kasih atas kunjungan Anda\nBarang yang sudah dibeli tidak dapat ditukar/dikembalikan'
                };
                localStorage.setItem('settings', JSON.stringify(defaultSettings));
                state.settings = defaultSettings;
            }
            
            // Load default users if not exists
            if (!localStorage.getItem('users')) {
                const defaultUsers = [
                    { username: 'admin', password: 'admin123', role: 'admin' },
                    { username: 'kasir', password: 'kasir123', role: 'kasir' }
                ];
                localStorage.setItem('users', JSON.stringify(defaultUsers));
                state.users = defaultUsers;
            }
            
            // Load default categories if not exists
            if (!localStorage.getItem('categories')) {
                const defaultCategories = [
                    { id: 'food', name: 'Makanan' },
                    { id: 'drink', name: 'Minuman' },
                    { id: 'snack', name: 'Snack' },
                    { id: 'other', name: 'Lainnya' }
                ];
                localStorage.setItem('categories', JSON.stringify(defaultCategories));
                state.categories = defaultCategories;
            }
            
            // Load default products if not exists
            if (!localStorage.getItem('products')) {
                const defaultProducts = [
                    { id: 1, name: 'Nasi Goreng', price: 15000, stock: 10, category: 'food', image: '' },
                    { id: 2, name: 'Es Teh Manis', price: 5000, stock: 20, category: 'drink', image: '' },
                    { id: 3, name: 'Kerupuk', price: 3000, stock: 15, category: 'snack', image: '' },
                    { id: 4, name: 'Sabun Mandi', price: 8000, stock: 5, category: 'other', image: '' },
                    { id: 5, name: 'Mie Instan', price: 4000, stock: 25, category: 'food', image: '' },
                    { id: 6, name: 'Air Mineral', price: 3000, stock: 30, category: 'drink', image: '' }
                ];
                localStorage.setItem('products', JSON.stringify(defaultProducts));
                state.products = defaultProducts;
            }
            
            // Load default members if not exists
            if (!localStorage.getItem('members')) {
                const defaultMembers = [
                    { id: 'MEM-001', name: 'Budi Santoso', phone: '6281234567890', joinDate: new Date().toISOString() },
                    { id: 'MEM-002', name: 'Siti Rahayu', phone: '6289876543210', joinDate: new Date().toISOString() }
                ];
                localStorage.setItem('members', JSON.stringify(defaultMembers));
                state.members = defaultMembers;
            }
        }

        function setupEventListeners() {
            // Login form
            elements.loginForm.addEventListener('submit', handleLogin);
            elements.reloadCaptchaBtn.addEventListener('click', generateCaptcha);
            elements.logoutBtn.addEventListener('click', handleLogout);
            
            // Product filters
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.addEventListener('click', function() {
                    document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    filterProducts(this.dataset.category);
                });
            });
            
            // Product search
            elements.productSearch.addEventListener('input', function() {
                filterProducts(document.querySelector('.filter-chip.active').dataset.category, this.value);
            });
            
            // Admin buttons
            elements.addProductBtn.addEventListener('click', () => openProductModal());
            elements.manageStockBtn.addEventListener('click', openStockModal);
            elements.manageCategoriesBtn.addEventListener('click', openCategoryModal);
            elements.manageMembersBtn.addEventListener('click', openMemberModal);
            
            // Member search
            elements.memberSearch.addEventListener('input', searchMembers);
            
            // Order actions
            elements.checkoutBtn.addEventListener('click', openPaymentModal);
            elements.cancelOrderBtn.addEventListener('click', cancelOrder);
            
            // Modal close buttons
            elements.modalCloses.forEach(close => {
                close.addEventListener('click', function() {
                    this.closest('.modal').style.display = 'none';
                });
            });
            
            // Close modals when clicking outside
            elements.modals.forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.style.display = 'none';
                    }
                });
            });
            
            // Product form
            elements.saveProductBtn.addEventListener('click', saveProduct);
            elements.deleteProductBtn.addEventListener('click', deleteProduct);
            
            // Category management
            elements.addCategoryBtn.addEventListener('click', addCategory);
            
            // Member management
            elements.addMemberBtn.addEventListener('click', addMember);
            elements.memberSearchList.addEventListener('input', filterMemberList);
            
            // Payment
            elements.paymentMethod.addEventListener('change', togglePaymentFields);
            elements.cashAmount.addEventListener('input', calculateChange);
            document.querySelectorAll('.quick-cash-buttons button').forEach(btn => {
                btn.addEventListener('click', function() {
                    elements.cashAmount.value = this.dataset.amount;
                    calculateChange();
                });
            });
            elements.addDonation.addEventListener('change', updatePaymentTotal);
            elements.cancelPaymentBtn.addEventListener('click', () => elements.paymentModal.style.display = 'none');
            elements.confirmPaymentBtn.addEventListener('click', confirmPayment);
            
            // Receipt
            elements.printReceiptBtn.addEventListener('click', printReceipt);
            elements.closeReceiptBtn.addEventListener('click', () => elements.receiptModal.style.display = 'none');
            
            // Settings
            elements.tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.dataset.tab;
                    
                    // Update active tab
                    elements.tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show corresponding content
                    elements.tabContents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === tabId + 'Tab') {
                            content.classList.add('active');
                        }
                    });
                });
            });
            
            elements.backupDataBtn.addEventListener('click', backupData);
            elements.restoreFile.addEventListener('change', restoreData);
            elements.addUserBtn.addEventListener('click', addUser);
            elements.saveSettingsBtn.addEventListener('click', saveSettings);
            
            // History
            document.querySelectorAll('#historyModal .filter-chip').forEach(chip => {
                chip.addEventListener('click', function() {
                    document.querySelectorAll('#historyModal .filter-chip').forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    filterTransactions(this.dataset.period);
                });
            });
            
            elements.historySearch.addEventListener('input', function() {
                const period = document.querySelector('#historyModal .filter-chip.active').dataset.period;
                filterTransactions(period, this.value);
            });
            
            elements.closeHistoryBtn.addEventListener('click', () => elements.historyModal.style.display = 'none');
            elements.printHistoryBtn.addEventListener('click', printHistoryReport);
            
            // KTA
            elements.ktaMemberSelect.addEventListener('change', updateKtaCard);
            elements.printKtaBtn.addEventListener('click', printKta);
            elements.closeKtaBtn.addEventListener('click', () => elements.ktaModal.style.display = 'none');
            
            // Shift management
            elements.shiftActionBtn.addEventListener('click', toggleShift);
        }

        // ===========================
        // AUTHENTICATION FUNCTIONS
        // ===========================
        function handleLogin(e) {
            e.preventDefault();
            
            const username = elements.username.value;
            const password = elements.password.value;
            const captcha = elements.captchaInput.value;
            
            // Validate captcha
            if (captcha.toLowerCase() !== state.captchaText.toLowerCase()) {
                showToast('Kode verifikasi tidak sesuai!', 'error');
                generateCaptcha();
                return;
            }
            
            // Find user
            const user = state.users.find(u => u.username === username && u.password === password);
            
            if (user) {
                state.currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                showMainApp();
                showToast('Login berhasil!', 'success');
            } else {
                showToast('Username atau password salah!', 'error');
                generateCaptcha();
            }
        }

        function handleLogout() {
            state.currentUser = null;
            localStorage.removeItem('currentUser');
            elements.loginModal.style.display = 'flex';
            elements.mainApp.style.display = 'none';
            elements.loginForm.reset();
            generateCaptcha();
        }

        function showMainApp() {
            elements.loginModal.style.display = 'none';
            elements.mainApp.style.display = 'block';
            elements.loggedInUser.textContent = state.currentUser.username;
            
            // Show/hide admin panel based on user role
            if (state.currentUser.role === 'admin') {
                elements.adminPanel.style.display = 'block';
            } else {
                elements.adminPanel.style.display = 'none';
            }
            
            // Update store name in header
            elements.storeNameHeader.textContent = state.settings.storeName;
            
            // Load shift status
            loadShiftStatus();
        }

        function generateCaptcha() {
            const canvas = elements.captchaCanvas;
            const ctx = canvas.getContext('2d');
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Generate random text
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';
            let text = '';
            for (let i = 0; i < 6; i++) {
                text += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            
            state.captchaText = text;
            
            // Draw background
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw text
            ctx.font = '24px Arial';
            ctx.fillStyle = '#343a40';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // Add some distortion
            for (let i = 0; i < text.length; i++) {
                ctx.save();
                ctx.translate(25 + i * 20, 20);
                ctx.rotate((Math.random() - 0.5) * 0.4);
                ctx.fillText(text[i], 0, 0);
                ctx.restore();
            }
            
            // Add some noise
            for (let i = 0; i < 50; i++) {
                ctx.fillStyle = `rgba(${Math.random() * 255}, ${Math.random() * 255}, ${Math.random() * 255}, 0.5)`;
                ctx.fillRect(Math.random() * canvas.width, Math.random() * canvas.height, 2, 2);
            }
        }

        // ===========================
        // PRODUCT MANAGEMENT FUNCTIONS
        // ===========================
        function loadProducts() {
            const savedProducts = localStorage.getItem('products');
            if (savedProducts) {
                state.products = JSON.parse(savedProducts);
            }
            renderProducts();
        }

        function renderProducts(filteredProducts = null) {
            const products = filteredProducts || state.products;
            elements.productGrid.innerHTML = '';
            
            if (products.length === 0) {
                elements.productGrid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-box-open"></i>
                        <p>Tidak ada produk ditemukan</p>
                    </div>
                `;
                return;
            }
            
            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.dataset.id = product.id;
                
                const categoryName = state.categories.find(c => c.id === product.category)?.name || product.category;
                
                productCard.innerHTML = `
                    <div class="product-actions">
                        <div class="action-btn edit-btn" data-id="${product.id}">
                            <i class="fas fa-edit"></i>
                        </div>
                        <div class="action-btn delete-btn" data-id="${product.id}">
                            <i class="fas fa-trash"></i>
                        </div>
                    </div>
                    <div class="product-image">
                        ${product.image ? `<img src="${product.image}" alt="${product.name}">` : `<i class="fas fa-box"></i>`}
                    </div>
                    <div class="product-name">${product.name}</div>
                    <div class="product-price">${formatCurrency(product.price)}</div>
                    <div class="product-stock ${product.stock < 5 ? 'low' : ''} ${product.stock === 0 ? 'out-of-stock' : ''}">
                        Stok: ${product.stock}
                    </div>
                    <div class="product-category">${categoryName}</div>
                `;
                
                // Add event listeners for actions
                const editBtn = productCard.querySelector('.edit-btn');
                const deleteBtn = productCard.querySelector('.delete-btn');
                
                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openProductModal(product.id);
                });
                
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm(`Hapus produk "${product.name}"?`)) {
                        deleteProduct(product.id);
                    }
                });
                
                // Add to cart on click
                productCard.addEventListener('click', () => {
                    addToCart(product.id);
                });
                
                elements.productGrid.appendChild(productCard);
            });
            
            // Update product count
            elements.productCount.textContent = `(${products.length} produk)`;
        }

        function filterProducts(category = 'all', searchTerm = '') {
            let filtered = state.products;
            
            // Filter by category
            if (category !== 'all') {
                filtered = filtered.filter(product => product.category === category);
            }
            
            // Filter by search term
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filtered = filtered.filter(product => 
                    product.name.toLowerCase().includes(term) || 
                    product.category.toLowerCase().includes(term)
                );
            }
            
            renderProducts(filtered);
        }

        function openProductModal(productId = null) {
            if (productId) {
                // Edit existing product
                const product = state.products.find(p => p.id === productId);
                if (product) {
                    elements.productModalTitle.textContent = 'Edit Produk';
                    elements.productId.value = product.id;
                    elements.productName.value = product.name;
                    elements.productPrice.value = product.price;
                    elements.productStock.value = product.stock;
                    elements.productCategory.value = product.category;
                    elements.productImage.value = product.image || '';
                    elements.deleteProductBtn.style.display = 'block';
                }
            } else {
                // Add new product
                elements.productModalTitle.textContent = 'Tambah Produk Baru';
                elements.productForm.reset();
                elements.productId.value = '';
                elements.deleteProductBtn.style.display = 'none';
            }
            
            elements.productModal.style.display = 'flex';
        }

        function saveProduct() {
            const id = elements.productId.value;
            const name = elements.productName.value;
            const price = parseInt(elements.productPrice.value);
            const stock = parseInt(elements.productStock.value);
            const category = elements.productCategory.value;
            const image = elements.productImage.value;
            
            if (!name || isNaN(price) || isNaN(stock)) {
                showToast('Harap isi semua field dengan benar!', 'error');
                return;
            }
            
            if (id) {
                // Update existing product
                const index = state.products.findIndex(p => p.id === parseInt(id));
                if (index !== -1) {
                    state.products[index] = {
                        ...state.products[index],
                        name,
                        price,
                        stock,
                        category,
                        image
                    };
                }
            } else {
                // Add new product
                const newId = state.products.length > 0 ? Math.max(...state.products.map(p => p.id)) + 1 : 1;
                state.products.push({
                    id: newId,
                    name,
                    price,
                    stock,
                    category,
                    image
                });
            }
            
            // Save to localStorage
            localStorage.setItem('products', JSON.stringify(state.products));
            
            // Update UI
            renderProducts();
            elements.productModal.style.display = 'none';
            
            showToast(`Produk ${id ? 'diperbarui' : 'ditambahkan'}!`, 'success');
        }

        function deleteProduct(productId = null) {
            if (!productId) {
                productId = parseInt(elements.productId.value);
            }
            
            state.products = state.products.filter(p => p.id !== productId);
            localStorage.setItem('products', JSON.stringify(state.products));
            
            renderProducts();
            elements.productModal.style.display = 'none';
            
            showToast('Produk dihapus!', 'success');
        }

        // ===========================
        // STOCK MANAGEMENT FUNCTIONS
        // ===========================
        function openStockModal() {
            renderStockList();
            elements.stockModal.style.display = 'flex';
        }

        function renderStockList(filteredProducts = null) {
            const products = filteredProducts || state.products;
            elements.stockList.innerHTML = '';
            
            if (products.length === 0) {
                elements.stockList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-box-open"></i>
                        <p>Tidak ada produk</p>
                    </div>
                `;
                return;
            }
            
            products.forEach(product => {
                const stockItem = document.createElement('div');
                stockItem.className = 'order-item';
                
                stockItem.innerHTML = `
                    <div class="order-item-info">
                        <div class="order-item-name">${product.name}</div>
                        <div class="order-item-price">Stok: ${product.stock}</div>
                    </div>
                    <div class="order-item-qty">
                        <button class="qty-btn decrease-stock" data-id="${product.id}">-</button>
                        <input type="number" class="qty-input stock-input" data-id="${product.id}" value="0" min="0">
                        <button class="qty-btn increase-stock" data-id="${product.id}">+</button>
                    </div>
                `;
                
                elements.stockList.appendChild(stockItem);
            });
            
            // Add event listeners for stock adjustments
            document.querySelectorAll('.decrease-stock').forEach(btn => {
                btn.addEventListener('click', function() {
                    const input = this.nextElementSibling;
                    if (input.value > 0) {
                        input.value = parseInt(input.value) - 1;
                    }
                });
            });
            
            document.querySelectorAll('.increase-stock').forEach(btn => {
                btn.addEventListener('click', function() {
                    const input = this.previousElementSibling;
                    input.value = parseInt(input.value) + 1;
                });
            });
            
            document.querySelectorAll('.stock-input').forEach(input => {
                input.addEventListener('change', function() {
                    if (this.value < 0) this.value = 0;
                });
            });
            
            // Add event listener for stock search
            elements.stockSearch.addEventListener('input', function() {
                const term = this.value.toLowerCase();
                const filtered = state.products.filter(product => 
                    product.name.toLowerCase().includes(term)
                );
                renderStockList(filtered);
            });
            
            // Add save button if not exists
            if (!document.getElementById('saveStockBtn')) {
                const saveBtn = document.createElement('button');
                saveBtn.id = 'saveStockBtn';
                saveBtn.className = 'btn btn-success';
                saveBtn.textContent = 'Simpan Perubahan Stok';
                saveBtn.addEventListener('click', saveStockChanges);
                
                elements.stockList.parentNode.appendChild(saveBtn);
            }
        }

        function saveStockChanges() {
            const inputs = document.querySelectorAll('.stock-input');
            let updated = false;
            
            inputs.forEach(input => {
                const adjustment = parseInt(input.value);
                if (adjustment !== 0) {
                    const productId = parseInt(input.dataset.id);
                    const product = state.products.find(p => p.id === productId);
                    
                    if (product) {
                        product.stock += adjustment;
                        if (product.stock < 0) product.stock = 0;
                        updated = true;
                    }
                }
            });
            
            if (updated) {
                localStorage.setItem('products', JSON.stringify(state.products));
                renderProducts();
                renderStockList();
                showToast('Stok produk diperbarui!', 'success');
            }
        }

        // ===========================
        // CATEGORY MANAGEMENT FUNCTIONS
        // ===========================
        function loadCategories() {
            const savedCategories = localStorage.getItem('categories');
            if (savedCategories) {
                state.categories = JSON.parse(savedCategories);
            }
        }

        function openCategoryModal() {
            renderCategoryList();
            elements.categoryModal.style.display = 'flex';
        }

        function renderCategoryList() {
            elements.categoryList.innerHTML = '';
            
            state.categories.forEach(category => {
                const categoryItem = document.createElement('div');
                categoryItem.className = 'order-item';
                
                categoryItem.innerHTML = `
                    <div class="order-item-info">
                        <div class="order-item-name">${category.name}</div>
                        <div class="order-item-price">ID: ${category.id}</div>
                    </div>
                    <div class="remove-btn delete-category" data-id="${category.id}">
                        <i class="fas fa-trash"></i>
                    </div>
                `;
                
                elements.categoryList.appendChild(categoryItem);
            });
            
            // Add event listeners for delete buttons
            document.querySelectorAll('.delete-category').forEach(btn => {
                btn.addEventListener('click', function() {
                    const categoryId = this.dataset.id;
                    
                    // Check if category is used by any products
                    const productsUsingCategory = state.products.filter(p => p.category === categoryId);
                    
                    if (productsUsingCategory.length > 0) {
                        showToast(`Tidak dapat menghapus kategori ini karena digunakan oleh ${productsUsingCategory.length} produk!`, 'error');
                        return;
                    }
                    
                    if (confirm(`Hapus kategori "${this.previousElementSibling.querySelector('.order-item-name').textContent}"?`)) {
                        deleteCategory(categoryId);
                    }
                });
            });
        }

        function addCategory() {
            const name = elements.newCategoryName.value.trim();
            
            if (!name) {
                showToast('Harap masukkan nama kategori!', 'error');
                return;
            }
            
            // Check if category already exists
            if (state.categories.some(c => c.name.toLowerCase() === name.toLowerCase())) {
                showToast('Kategori sudah ada!', 'error');
                return;
            }
            
            // Generate ID from name
            const id = name.toLowerCase().replace(/\s+/g, '-');
            
            state.categories.push({ id, name });
            localStorage.setItem('categories', JSON.stringify(state.categories));
            
            elements.newCategoryName.value = '';
            renderCategoryList();
            
            showToast('Kategori ditambahkan!', 'success');
        }

        function deleteCategory(categoryId) {
            state.categories = state.categories.filter(c => c.id !== categoryId);
            localStorage.setItem('categories', JSON.stringify(state.categories));
            
            renderCategoryList();
            showToast('Kategori dihapus!', 'success');
        }

        // ===========================
        // MEMBER MANAGEMENT FUNCTIONS
        // ===========================
        function loadMembers() {
            const savedMembers = localStorage.getItem('members');
            if (savedMembers) {
                state.members = JSON.parse(savedMembers);
            }
        }

        function openMemberModal() {
            renderMemberList();
            elements.memberModal.style.display = 'flex';
        }

        function renderMemberList(filteredMembers = null) {
            const members = filteredMembers || state.members;
            elements.memberList.innerHTML = '';
            
            if (members.length === 0) {
                elements.memberList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <p>Tidak ada member</p>
                    </div>
                `;
                return;
            }
            
            members.forEach(member => {
                const memberItem = document.createElement('div');
                memberItem.className = 'order-item';
                
                // Format join date
                const joinDate = new Date(member.joinDate);
                const formattedDate = joinDate.toLocaleDateString('id-ID', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                });
                
                memberItem.innerHTML = `
                    <div class="order-item-info">
                        <div class="order-item-name">${member.name} <span class="member-badge">${member.id}</span></div>
                        <div class="order-item-price">
                            Bergabung: ${formattedDate}
                        </div>
                        <!-- [PERBAIKAN] Tampilkan dan buat link WhatsApp bisa diklik -->
                        <a href="https://wa.me/${member.phone}" target="_blank" class="whatsapp-member">
                            <i class="fab fa-whatsapp"></i> ${formatPhoneNumber(member.phone)}
                        </a>
                    </div>
                    <div class="remove-btn delete-member" data-id="${member.id}">
                        <i class="fas fa-trash"></i>
                    </div>
                `;
                
                elements.memberList.appendChild(memberItem);
            });
            
            // Add event listeners for delete buttons
            document.querySelectorAll('.delete-member').forEach(btn => {
                btn.addEventListener('click', function() {
                    const memberId = this.dataset.id;
                    const member = state.members.find(m => m.id === memberId);
                    
                    if (confirm(`Hapus member "${member.name}"?`)) {
                        deleteMember(memberId);
                    }
                });
            });
        }

        function addMember() {
            const name = elements.newMemberName.value.trim();
            const phone = elements.newMemberPhone.value.trim();
            
            if (!name) {
                showToast('Harap masukkan nama member!', 'error');
                return;
            }
            
            if (!phone) {
                showToast('Harap masukkan nomor WhatsApp!', 'error');
                return;
            }
            
            // Validate phone number (simple validation)
            if (!/^(\+62|62|0)8[1-9][0-9]{6,9}$/.test(phone)) {
                showToast('Format nomor WhatsApp tidak valid!', 'error');
                return;
            }
            
            // Generate member ID
            const memberId = 'MEM-' + String(state.members.length + 1).padStart(3, '0');
            
            state.members.push({
                id: memberId,
                name,
                phone,
                joinDate: new Date().toISOString()
            });
            
            localStorage.setItem('members', JSON.stringify(state.members));
            
            elements.newMemberName.value = '';
            elements.newMemberPhone.value = '';
            renderMemberList();
            
            showToast('Member ditambahkan!', 'success');
        }

        function deleteMember(memberId) {
            state.members = state.members.filter(m => m.id !== memberId);
            localStorage.setItem('members', JSON.stringify(state.members));
            
            renderMemberList();
            showToast('Member dihapus!', 'success');
        }

        function filterMemberList() {
            const term = elements.memberSearchList.value.toLowerCase();
            const filtered = state.members.filter(member => 
                member.name.toLowerCase().includes(term) || 
                member.id.toLowerCase().includes(term)
            );
            renderMemberList(filtered);
        }

        function searchMembers() {
            const term = elements.memberSearch.value.toLowerCase();
            elements.memberSearchResults.innerHTML = '';
            
            if (term.length < 2) {
                elements.memberSearchResults.style.display = 'none';
                return;
            }
            
            const results = state.members.filter(member => 
                member.name.toLowerCase().includes(term) || 
                member.id.toLowerCase().includes(term)
            );
            
            if (results.length === 0) {
                elements.memberSearchResults.innerHTML = `
                    <div class="member-search-item">Tidak ada member ditemukan</div>
                `;
            } else {
                results.forEach(member => {
                    const item = document.createElement('div');
                    item.className = 'member-search-item';
                    item.textContent = `${member.name} (${member.id})`;
                    item.dataset.id = member.id;
                    
                    item.addEventListener('click', function() {
                        selectMember(member.id);
                    });
                    
                    elements.memberSearchResults.appendChild(item);
                });
            }
            
            elements.memberSearchResults.style.display = 'block';
        }

        function selectMember(memberId) {
            const member = state.members.find(m => m.id === memberId);
            if (member) {
                state.currentMember = member;
                elements.memberSearch.value = `${member.name} (${member.id})`;
                elements.memberSearchResults.style.display = 'none';
                
                // Show member info
                elements.selectedMemberInfo.innerHTML = `
                    <div style="background: #e7f3ff; padding: 8px; border-radius: 4px;">
                        <strong>Member:</strong> ${member.name} (${member.id}) 
                        <!-- [PERBAIKAN] Tampilkan dan buat link WhatsApp bisa diklik -->
                        | <a href="https://wa.me/${member.phone}" target="_blank" class="whatsapp-member">
                            <i class="fab fa-whatsapp"></i> ${formatPhoneNumber(member.phone)}
                        </a>
                    </div>
                `;
                elements.selectedMemberInfo.style.display = 'block';
                
                showToast(`Member ${member.name} dipilih!`, 'success');
            }
        }

        // ===========================
        // ORDER MANAGEMENT FUNCTIONS
        // ===========================
        function addToCart(productId) {
            const product = state.products.find(p => p.id === productId);
            
            if (!product) {
                showToast('Produk tidak ditemukan!', 'error');
                return;
            }
            
            if (product.stock < 1) {
                showToast('Stok produk habis!', 'error');
                return;
            }
            
            // Check if product already in cart
            const existingOrder = state.orders.find(o => o.productId === productId);
            
            if (existingOrder) {
                existingOrder.quantity += 1;
            } else {
                state.orders.push({
                    productId: product.id,
                    name: product.name,
                    price: product.price,
                    quantity: 1
                });
            }
            
            // Update product stock (temporary)
            product.stock -= 1;
            
            renderOrderItems();
            updateOrderSummary();
            
            showToast(`${product.name} ditambahkan ke keranjang!`, 'success');
        }

        function renderOrderItems() {
            elements.orderItemsContainer.innerHTML = '';
            
            if (state.orders.length === 0) {
                elements.orderItemsContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-shopping-cart"></i>
                        <p>Keranjang belanja kosong</p>
                    </div>
                `;
                return;
            }
            
            state.orders.forEach(order => {
                const orderItem = document.createElement('div');
                orderItem.className = 'order-item';
                orderItem.dataset.productId = order.productId;
                
                orderItem.innerHTML = `
                    <div class="order-item-info">
                        <div class="order-item-name">${order.name}</div>
                        <div class="order-item-price">${formatCurrency(order.price)} x ${order.quantity}</div>
                    </div>
                    <div class="order-item-qty">
                        <button class="qty-btn decrease-qty" data-product-id="${order.productId}">-</button>
                        <input type="number" class="qty-input" data-product-id="${order.productId}" value="${order.quantity}" min="1">
                        <button class="qty-btn increase-qty" data-product-id="${order.productId}">+</button>
                        <div class="remove-btn remove-item" data-product-id="${order.productId}">
                            <i class="fas fa-trash"></i>
                        </div>
                    </div>
                `;
                
                elements.orderItemsContainer.appendChild(orderItem);
            });
            
            // Add event listeners for quantity adjustments
            document.querySelectorAll('.decrease-qty').forEach(btn => {
                btn.addEventListener('click', function() {
                    updateQuantity(parseInt(this.dataset.productId), -1);
                });
            });
            
            document.querySelectorAll('.increase-qty').forEach(btn => {
                btn.addEventListener('click', function() {
                    updateQuantity(parseInt(this.dataset.productId), 1);
                });
            });
            
            document.querySelectorAll('.qty-input').forEach(input => {
                input.addEventListener('change', function() {
                    const newQuantity = parseInt(this.value);
                    if (newQuantity < 1) this.value = 1;
                    setQuantity(parseInt(this.dataset.productId), newQuantity);
                });
            });
            
            document.querySelectorAll('.remove-item').forEach(btn => {
                btn.addEventListener('click', function() {
                    removeFromCart(parseInt(this.dataset.productId));
                });
            });
        }

        function updateQuantity(productId, change) {
            const order = state.orders.find(o => o.productId === productId);
            const product = state.products.find(p => p.id === productId);
            
            if (order && product) {
                const newQuantity = order.quantity + change;
                
                if (newQuantity < 1) {
                    removeFromCart(productId);
                    return;
                }
                
                // Check stock availability
                const currentStock = product.stock + order.quantity; // Stock before this update
                
                if (newQuantity > currentStock) {
                    showToast(`Stok ${product.name} tidak mencukupi! Stok tersedia: ${currentStock}`, 'error');
                    return;
                }
                
                // Update stock
                product.stock = currentStock - newQuantity;
                order.quantity = newQuantity;
                
                renderOrderItems();
                updateOrderSummary();
            }
        }

        function setQuantity(productId, quantity) {
            const order = state.orders.find(o => o.productId === productId);
            const product = state.products.find(p => p.id === productId);
            
            if (order && product) {
                // Check stock availability
                const currentStock = product.stock + order.quantity; // Stock before this update
                
                if (quantity > currentStock) {
                    showToast(`Stok ${product.name} tidak mencukupi! Stok tersedia: ${currentStock}`, 'error');
                    quantity = currentStock;
                }
                
                // Update stock
                product.stock = currentStock - quantity;
                order.quantity = quantity;
                
                renderOrderItems();
                updateOrderSummary();
            }
        }

        function removeFromCart(productId) {
            const orderIndex = state.orders.findIndex(o => o.productId === productId);
            
            if (orderIndex !== -1) {
                const order = state.orders[orderIndex];
                const product = state.products.find(p => p.id === productId);
                
                // Restore stock
                if (product) {
                    product.stock += order.quantity;
                }
                
                state.orders.splice(orderIndex, 1);
                renderOrderItems();
                updateOrderSummary();
                
                showToast(`${order.name} dihapus dari keranjang!`, 'success');
            }
        }

        function updateOrderSummary() {
            const subtotal = state.orders.reduce((sum, order) => sum + (order.price * order.quantity), 0);
            const taxRate = state.settings.taxRate || 10;
            const tax = subtotal * (taxRate / 100);
            const total = subtotal + tax;
            
            elements.subtotal.textContent = formatCurrency(subtotal);
            elements.tax.textContent = formatCurrency(tax);
            elements.total.textContent = formatCurrency(total);
            
            // Update payment total if payment modal is open
            if (elements.paymentModal.style.display === 'flex') {
                updatePaymentTotal();
            }
        }

        function cancelOrder() {
            if (state.orders.length === 0) {
                showToast('Tidak ada transaksi untuk dibatalkan!', 'warning');
                return;
            }
            
            if (!confirm('Batalkan transaksi ini? Semua item akan dihapus dari keranjang.')) {
                return;
            }
            
            // Restore all product stocks
            state.orders.forEach(order => {
                const product = state.products.find(p => p.id === order.productId);
                if (product) {
                    product.stock += order.quantity;
                }
            });
            
            state.orders = [];
            state.currentMember = null;
            
            renderOrderItems();
            updateOrderSummary();
            
            elements.memberSearch.value = '';
            elements.selectedMemberInfo.style.display = 'none';
            elements.orderNote.value = '';
            
            showToast('Transaksi dibatalkan!', 'success');
        }

        // ===========================
        // PAYMENT FUNCTIONS
        // ===========================
        function openPaymentModal() {
            if (state.orders.length === 0) {
                showToast('Keranjang belanja kosong!', 'error');
                return;
            }
            
            updatePaymentTotal();
            elements.paymentModal.style.display = 'flex';
            
            // Reset payment form
            elements.paymentMethod.value = 'cash';
            elements.cashAmount.value = '';
            elements.changeAmount.textContent = formatCurrency(0);
            elements.addDonation.checked = false;
            
            togglePaymentFields();
        }

        function togglePaymentFields() {
            const method = elements.paymentMethod.value;
            
            if (method === 'cash') {
                elements.cashPaymentGroup.style.display = 'block';
            } else {
                elements.cashPaymentGroup.style.display = 'none';
            }
        }

        function calculateChange() {
            const total = calculateTotalWithDonation();
            const cashAmount = parseFloat(elements.cashAmount.value) || 0;
            const change = cashAmount - total;
            
            elements.changeAmount.textContent = formatCurrency(change >= 0 ? change : 0);
            
            // Update confirm button state
            elements.confirmPaymentBtn.disabled = (method === 'cash' && cashAmount < total);
        }

        function calculateTotalWithDonation() {
            const subtotal = state.orders.reduce((sum, order) => sum + (order.price * order.quantity), 0);
            const taxRate = state.settings.taxRate || 10;
            const tax = subtotal * (taxRate / 100);
            let total = subtotal + tax;
            
            // Add donation if selected
            if (elements.addDonation.checked) {
                total += 1000;
            }
            
            return total;
        }

        function updatePaymentTotal() {
            const total = calculateTotalWithDonation();
            elements.paymentTotal.textContent = formatCurrency(total);
            calculateChange();
        }

        function confirmPayment() {
            const method = elements.paymentMethod.value;
            const total = calculateTotalWithDonation();
            
            // For cash payment, validate cash amount
            if (method === 'cash') {
                const cashAmount = parseFloat(elements.cashAmount.value) || 0;
                
                if (cashAmount < total) {
                    showToast('Jumlah uang tidak mencukupi!', 'error');
                    return;
                }
            }
            
            // Generate transaction ID
            const transactionId = 'TRX-' + Date.now();
            
            // Create transaction record
            const transaction = {
                id: transactionId,
                date: new Date().toISOString(),
                items: [...state.orders],
                subtotal: state.orders.reduce((sum, order) => sum + (order.price * order.quantity), 0),
                tax: state.orders.reduce((sum, order) => sum + (order.price * order.quantity), 0) * ((state.settings.taxRate || 10) / 100),
                donation: elements.addDonation.checked ? 1000 : 0,
                total: total,
                paymentMethod: method,
                cashAmount: method === 'cash' ? parseFloat(elements.cashAmount.value) : 0,
                change: method === 'cash' ? (parseFloat(elements.cashAmount.value) - total) : 0,
                member: state.currentMember ? { id: state.currentMember.id, name: state.currentMember.name } : null,
                note: elements.orderNote.value,
                cashier: state.currentUser.username
            };
            
            // Add to transactions
            state.transactions.push(transaction);
            localStorage.setItem('transactions', JSON.stringify(state.transactions));
            
            // Update product stocks permanently
            state.orders.forEach(order => {
                const product = state.products.find(p => p.id === order.productId);
                // Stock already reduced when adding to cart
            });
            
            // Save updated products
            localStorage.setItem('products', JSON.stringify(state.products));
            
            // Show receipt
            showReceipt(transaction);
            
            // Reset order
            state.orders = [];
            state.currentMember = null;
            
            renderOrderItems();
            updateOrderSummary();
            
            elements.memberSearch.value = '';
            elements.selectedMemberInfo.style.display = 'none';
            elements.orderNote.value = '';
            
            elements.paymentModal.style.display = 'none';
        }

        // ===========================
        // RECEIPT FUNCTIONS
        // ===========================
        function showReceipt(transaction) {
            // Update receipt content
            elements.receiptStoreName.textContent = state.settings.storeName;
            elements.receiptStoreAddress.textContent = state.settings.storeAddress;
            elements.receiptStorePhone.textContent = state.settings.storePhone;
            
            elements.receiptTransactionId.textContent = transaction.id;
            elements.receiptDate.textContent = new Date(transaction.date).toLocaleString('id-ID');
            elements.receiptCashier.textContent = transaction.cashier;
            
            // Update receipt items
            elements.receiptItemsContainer.innerHTML = '';
            transaction.items.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'receipt-item';
                
                itemElement.innerHTML = `
                    <div class="receipt-item-details">
                        <div class="item-name">${item.name}</div>
                        <div class="item-price-calc">${formatCurrency(item.price)} x ${item.quantity} = ${formatCurrency(item.price * item.quantity)}</div>
                    </div>
                `;
                
                elements.receiptItemsContainer.appendChild(itemElement);
            });
            
            // Update receipt totals
            elements.receiptSubtotal.textContent = formatCurrency(transaction.subtotal);
            elements.receiptTax.textContent = formatCurrency(transaction.tax);
            elements.receiptTotal.textContent = formatCurrency(transaction.total);
            elements.receiptPayment.textContent = formatCurrency(transaction.paymentMethod === 'cash' ? transaction.cashAmount : transaction.total);
            elements.receiptChange.textContent = formatCurrency(transaction.change);
            
            // Show receipt modal
            elements.receiptModal.style.display = 'flex';
        }

        function printReceipt() {
            const receiptContent = elements.receiptContent.cloneNode(true);
            const printContainer = elements.printContainer;
            
            printContainer.innerHTML = '';
            printContainer.appendChild(receiptContent);
            
            // Add print-specific styles
            const style = document.createElement('style');
            style.textContent = `
                @media print {
                    body * { visibility: hidden; }
                    #print-container, #print-container * { visibility: visible; }
                    #print-container { position: absolute; left: 0; top: 0; width: 100%; }
                }
            `;
            printContainer.appendChild(style);
            
            // Trigger print
            window.print();
        }

        // ===========================
        // SETTINGS FUNCTIONS
        // ===========================
        function loadSettings() {
            const savedSettings = localStorage.getItem('settings');
            if (savedSettings) {
                state.settings = JSON.parse(savedSettings);
                
                // Update settings form
                elements.taxRate.value = state.settings.taxRate || 10;
                elements.currency.value = state.settings.currency || 'IDR';
                elements.enableSound.checked = state.settings.enableSound !== false;
                elements.storeName.value = state.settings.storeName || 'SUPERMARKET';
                elements.storeAddress.value = state.settings.storeAddress || '';
                elements.storePhone.value = state.settings.storePhone || '';
                elements.storeReceiptFooter.value = state.settings.storeReceiptFooter || '';
                
                // Update store name in header
                elements.storeNameHeader.textContent = state.settings.storeName;
            }
        }

        function loadUsers() {
            const savedUsers = localStorage.getItem('users');
            if (savedUsers) {
                state.users = JSON.parse(savedUsers);
            }
            renderUserList();
        }

        function renderUserList() {
            elements.userList.innerHTML = '';
            
            state.users.forEach(user => {
                const userItem = document.createElement('div');
                userItem.className = 'order-item';
                
                userItem.innerHTML = `
                    <div class="order-item-info">
                        <div class="order-item-name">${user.username}</div>
                        <div class="order-item-price">Role: ${user.role}</div>
                    </div>
                    ${user.username !== 'admin' ? `
                        <div class="remove-btn delete-user" data-username="${user.username}">
                            <i class="fas fa-trash"></i>
                        </div>
                    ` : ''}
                `;
                
                elements.userList.appendChild(userItem);
            });
            
            // Add event listeners for delete buttons
            document.querySelectorAll('.delete-user').forEach(btn => {
                btn.addEventListener('click', function() {
                    const username = this.dataset.username;
                    
                    if (confirm(`Hapus pengguna "${username}"?`)) {
                        deleteUser(username);
                    }
                });
            });
        }

        function addUser() {
            const username = elements.newUsername.value.trim();
            const password = elements.newPassword.value;
            const role = elements.userRole.value;
            
            if (!username || !password) {
                showToast('Harap isi semua field!', 'error');
                return;
            }
            
            // Check if user already exists
            if (state.users.some(u => u.username === username)) {
                showToast('Username sudah ada!', 'error');
                return;
            }
            
            state.users.push({ username, password, role });
            localStorage.setItem('users', JSON.stringify(state.users));
            
            elements.newUsername.value = '';
            elements.newPassword.value = '';
            renderUserList();
            
            showToast('Pengguna ditambahkan!', 'success');
        }

        function deleteUser(username) {
            state.users = state.users.filter(u => u.username !== username);
            localStorage.setItem('users', JSON.stringify(state.users));
            
            renderUserList();
            showToast('Pengguna dihapus!', 'success');
        }

        function saveSettings() {
            const settings = {
                taxRate: parseInt(elements.taxRate.value) || 10,
                currency: elements.currency.value,
                enableSound: elements.enableSound.checked,
                storeName: elements.storeName.value,
                storeAddress: elements.storeAddress.value,
                storePhone: elements.storePhone.value,
                storeReceiptFooter: elements.storeReceiptFooter.value
            };
            
            state.settings = settings;
            localStorage.setItem('settings', JSON.stringify(settings));
            
            // Update store name in header
            elements.storeNameHeader.textContent = settings.storeName;
            
            elements.settingsModal.style.display = 'none';
            showToast('Pengaturan disimpan!', 'success');
        }

        function backupData() {
            const data = {
                products: state.products,
                categories: state.categories,
                members: state.members,
                transactions: state.transactions,
                users: state.users,
                settings: state.settings
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup-supermarket-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Backup data berhasil!', 'success');
        }

        function restoreData() {
            const file = elements.restoreFile.files[0];
            
            if (!file) {
                showToast('Pilih file backup!', 'error');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Validate data structure
                    if (!data.products || !data.categories || !data.members || !data.transactions || !data.users || !data.settings) {
                        throw new Error('Format file backup tidak valid!');
                    }
                    
                    // Confirm restore
                    if (!confirm('Restore data akan mengganti semua data saat ini. Lanjutkan?')) {
                        return;
                    }
                    
                    // Restore data
                    state.products = data.products;
                    state.categories = data.categories;
                    state.members = data.members;
                    state.transactions = data.transactions;
                    state.users = data.users;
                    state.settings = data.settings;
                    
                    // Save to localStorage
                    localStorage.setItem('products', JSON.stringify(state.products));
                    localStorage.setItem('categories', JSON.stringify(state.categories));
                    localStorage.setItem('members', JSON.stringify(state.members));
                    localStorage.setItem('transactions', JSON.stringify(state.transactions));
                    localStorage.setItem('users', JSON.stringify(state.users));
                    localStorage.setItem('settings', JSON.stringify(state.settings));
                    
                    // Update UI
                    renderProducts();
                    loadSettings();
                    renderUserList();
                    
                    elements.restoreFile.value = '';
                    elements.settingsModal.style.display = 'none';
                    
                    showToast('Data berhasil di-restore!', 'success');
                } catch (error) {
                    console.error('Restore error:', error);
                    showToast('Error: File backup tidak valid!', 'error');
                }
            };
            
            reader.readAsText(file);
        }

        // ===========================
        // TRANSACTION HISTORY FUNCTIONS
        // ===========================
        function loadTransactions() {
            const savedTransactions = localStorage.getItem('transactions');
            if (savedTransactions) {
                state.transactions = JSON.parse(savedTransactions);
            }
        }

        function openHistoryModal() {
            filterTransactions('today');
            elements.historyModal.style.display = 'flex';
        }

        function filterTransactions(period = 'today', searchTerm = '') {
            let filtered = state.transactions;
            
            // Filter by period
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const weekAgo = new Date(today);
            weekAgo.setDate(today.getDate() - 7);
            const monthAgo = new Date(today);
            monthAgo.setMonth(today.getMonth() - 1);
            
            switch (period) {
                case 'today':
                    filtered = filtered.filter(t => new Date(t.date) >= today);
                    break;
                case 'week':
                    filtered = filtered.filter(t => new Date(t.date) >= weekAgo);
                    break;
                case 'month':
                    filtered = filtered.filter(t => new Date(t.date) >= monthAgo);
                    break;
                // 'all' keeps all transactions
            }
            
            // Filter by search term
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filtered = filtered.filter(t => 
                    t.id.toLowerCase().includes(term) ||
                    (t.member && t.member.name.toLowerCase().includes(term)) ||
                    t.cashier.toLowerCase().includes(term)
                );
            }
            
            renderTransactionHistory(filtered);
        }

        function renderTransactionHistory(transactions) {
            elements.historyResults.innerHTML = '';
            
            if (transactions.length === 0) {
                elements.historyResults.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-receipt"></i>
                        <p>Tidak ada transaksi ditemukan</p>
                    </div>
                `;
                return;
            }
            
            // Sort by date (newest first)
            transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            transactions.forEach(transaction => {
                const historyItem = document.createElement('div');
                historyItem.className = 'order-item';
                
                historyItem.innerHTML = `
                    <div class="order-item-info">
                        <div class="order-item-name">${transaction.id}</div>
                        <div class="order-item-price">${new Date(transaction.date).toLocaleString('id-ID')}</div>
                        <div class="order-item-price">Kasir: ${transaction.cashier} | Total: ${formatCurrency(transaction.total)}</div>
                        ${transaction.member ? `<div class="order-item-price">Member: ${transaction.member.name} (${transaction.member.id})</div>` : ''}
                    </div>
                    <div class="remove-btn view-receipt" data-id="${transaction.id}">
                        <i class="fas fa-eye"></i>
                    </div>
                `;
                
                elements.historyResults.appendChild(historyItem);
            });
            
            // Add event listeners for view buttons
            document.querySelectorAll('.view-receipt').forEach(btn => {
                btn.addEventListener('click', function() {
                    const transactionId = this.dataset.id;
                    const transaction = state.transactions.find(t => t.id === transactionId);
                    
                    if (transaction) {
                        showReceipt(transaction);
                        elements.historyModal.style.display = 'none';
                    }
                });
            });
        }

        function printHistoryReport() {
            const period = document.querySelector('#historyModal .filter-chip.active').dataset.period;
            const searchTerm = elements.historySearch.value;
            
            let filtered = state.transactions;
            
            // Apply same filters as in filterTransactions
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const weekAgo = new Date(today);
            weekAgo.setDate(today.getDate() - 7);
            const monthAgo = new Date(today);
            monthAgo.setMonth(today.getMonth() - 1);
            
            switch (period) {
                case 'today':
                    filtered = filtered.filter(t => new Date(t.date) >= today);
                    break;
                case 'week':
                    filtered = filtered.filter(t => new Date(t.date) >= weekAgo);
                    break;
                case 'month':
                    filtered = filtered.filter(t => new Date(t.date) >= monthAgo);
                    break;
            }
            
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filtered = filtered.filter(t => 
                    t.id.toLowerCase().includes(term) ||
                    (t.member && t.member.name.toLowerCase().includes(term)) ||
                    t.cashier.toLowerCase().includes(term)
                );
            }
            
            // Calculate totals
            const totalTransactions = filtered.length;
            const totalRevenue = filtered.reduce((sum, t) => sum + t.total, 0);
            const totalTax = filtered.reduce((sum, t) => sum + t.tax, 0);
            const totalDonation = filtered.reduce((sum, t) => sum + t.donation, 0);
            
            // Create print content
            const printContent = `
                <div class="recap-printable-area" style="font-family: Arial, sans-serif; padding: 20px;">
                    <h1 style="text-align: center; margin-bottom: 5px;">LAPORAN TRANSAKSI</h1>
                    <h2 style="text-align: center; margin-top: 0; color: #555;">${state.settings.storeName}</h2>
                    <p style="text-align: center; margin-bottom: 20px;">Periode: ${document.querySelector('#historyModal .filter-chip.active').textContent} | Dicetak: ${new Date().toLocaleString('id-ID')}</p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; border-left: 5px solid #007bff;">
                            <div style="font-weight: bold; color: #0056b3; margin-bottom: 5px;">Total Transaksi</div>
                            <div style="font-size: 24px; font-weight: bold; color: #007bff;">${totalTransactions}</div>
                        </div>
                        <div style="background: #e7f5ee; padding: 15px; border-radius: 8px; border-left: 5px solid #28a745;">
                            <div style="font-weight: bold; color: #1e7e34; margin-bottom: 5px;">Total Pendapatan</div>
                            <div style="font-size: 24px; font-weight: bold; color: #28a745;">${formatCurrency(totalRevenue)}</div>
                        </div>
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                        <thead>
                            <tr style="background-color: #f8f9fa;">
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">ID Transaksi</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">Tanggal</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">Kasir</th>
                                <th style="padding: 12px; text-align: right; border-bottom: 2px solid #dee2e6;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filtered.map(t => `
                                <tr>
                                    <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">${t.id}</td>
                                    <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">${new Date(t.date).toLocaleString('id-ID')}</td>
                                    <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">${t.cashier}</td>
                                    <td style="padding: 10px; border-bottom: 1px solid #dee2e6; text-align: right;">${formatCurrency(t.total)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr style="background-color: #f8f9fa; font-weight: bold;">
                                <td style="padding: 12px; border-top: 2px solid #dee2e6;" colspan="3">TOTAL</td>
                                <td style="padding: 12px; border-top: 2px solid #dee2e6; text-align: right;">${formatCurrency(totalRevenue)}</td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    <div style="margin-top: 30px; font-size: 12px; color: #6c757d; text-align: center;">
                        <p>Dicetak oleh: ${state.currentUser.username} | ${new Date().toLocaleString('id-ID')}</p>
                    </div>
                </div>
            `;
            
            // Print the content
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Laporan Transaksi - ${state.settings.storeName}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; color: #333; }
                            table { width: 100%; border-collapse: collapse; }
                            th, td { padding: 8px 12px; text-align: left; border-bottom: 1px solid #ddd; }
                            th { background-color: #f5f5f5; }
                            @media print { body { margin: 0; } }
                        </style>
                    </head>
                    <body>
                        ${printContent}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // ===========================
        // KTA MEMBER FUNCTIONS
        // ===========================
        function openKtaModal() {
            // Populate member select
            elements.ktaMemberSelect.innerHTML = '';
            state.members.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = `${member.name} (${member.id})`;
                elements.ktaMemberSelect.appendChild(option);
            });
            
            // Select first member by default
            if (state.members.length > 0) {
                elements.ktaMemberSelect.value = state.members[0].id;
                updateKtaCard();
            }
            
            elements.ktaModal.style.display = 'flex';
        }

        function updateKtaCard() {
            const memberId = elements.ktaMemberSelect.value;
            const member = state.members.find(m => m.id === memberId);
            
            if (!member) return;
            
            // Update card info
            elements.ktaStoreName.textContent = state.settings.storeName;
            elements.ktaMemberName.textContent = member.name;
            elements.ktaMemberId.textContent = `ID: ${member.id}`;
            
            // Format phone number
            elements.ktaMemberPhone.textContent = `WhatsApp: ${formatPhoneNumber(member.phone)}`;
            
            // Format join date
            const joinDate = new Date(member.joinDate);
            elements.ktaMemberSince.textContent = `Bergabung sejak: ${joinDate.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' })}`;
            
            // Generate QR code with member information
            // [PERBAIKAN] QR Code berisi informasi lengkap
            const qrData = JSON.stringify({
                store: state.settings.storeName,
                member: member.name,
                id: member.id,
                phone: member.phone,
                joinDate: member.joinDate
            });
            
            // Clear previous QR code
            elements.ktaQrCode.innerHTML = '';
            
            // Generate new QR code
            QRCode.toCanvas(elements.ktaQrCode, qrData, {
                width: 160,
                height: 160,
                margin: 1,
                color: {
                    dark: '#000000',
                    light: '#FFFFFF'
                }
            }, function(error) {
                if (error) {
                    console.error('QR Code generation error:', error);
                    elements.ktaQrCode.innerHTML = '<p>Error generating QR code</p>';
                }
            });
        }

        function printKta() {
            const ktaCard = document.getElementById('ktaCard').cloneNode(true);
            const printContainer = elements.printContainer;
            
            printContainer.innerHTML = '';
            printContainer.appendChild(ktaCard);
            
            // Add print styles
            const style = document.createElement('style');
            style.textContent = `
                @media print {
                    body * { visibility: hidden; }
                    #print-container, #print-container * { visibility: visible; }
                    #print-container { 
                        position: absolute; 
                        left: 0; 
                        top: 0; 
                        width: 100%; 
                        height: 100%; 
                        display: flex;
                        justify-content: center;
                        align-items: center;
                    }
                    #ktaCard {
                        margin: 0;
                        box-shadow: none;
                    }
                }
            `;
            printContainer.appendChild(style);
            
            // Trigger print
            window.print();
        }

        // ===========================
        // SHIFT MANAGEMENT FUNCTIONS
        // ===========================
        function loadShiftStatus() {
            const savedShift = localStorage.getItem('currentShift');
            
            if (savedShift) {
                state.currentShift = JSON.parse(savedShift);
                updateShiftUI(true);
            } else {
                updateShiftUI(false);
            }
        }

        function toggleShift() {
            if (state.currentShift) {
                // End current shift
                if (confirm('Akhiri shift saat ini?')) {
                    state.currentShift.endTime = new Date().toISOString();
                    
                    // Save to transaction history
                    const shifts = JSON.parse(localStorage.getItem('shifts') || '[]');
                    shifts.push(state.currentShift);
                    localStorage.setItem('shifts', JSON.stringify(shifts));
                    
                    // Clear current shift
                    state.currentShift = null;
                    localStorage.removeItem('currentShift');
                    
                    updateShiftUI(false);
                    showToast('Shift berhasil diakhiri!', 'success');
                }
            } else {
                // Start new shift
                const shiftId = 'SHIFT-' + Date.now();
                state.currentShift = {
                    id: shiftId,
                    startTime: new Date().toISOString(),
                    cashier: state.currentUser.username,
                    startingCash: 0,
                    transactions: []
                };
                
                localStorage.setItem('currentShift', JSON.stringify(state.currentShift));
                updateShiftUI(true);
                showToast('Shift baru dimulai!', 'success');
            }
        }

        function updateShiftUI(shiftActive) {
            if (shiftActive) {
                elements.shiftStatusBadge.textContent = 'Shift Aktif';
                elements.shiftStatusBadge.classList.add('active');
                elements.shiftActionBtn.textContent = 'Akhiri Shift';
                elements.shiftActionBtn.className = 'btn btn-sm btn-danger';
            } else {
                elements.shiftStatusBadge.textContent = 'Tidak Ada Shift Aktif';
                elements.shiftStatusBadge.classList.remove('active');
                elements.shiftActionBtn.textContent = 'Mulai Shift';
                elements.shiftActionBtn.className = 'btn btn-sm btn-warning';
            }
        }

        // ===========================
        // UTILITY FUNCTIONS
        // ===========================
        function formatCurrency(amount) {
            if (state.settings.currency === 'USD') {
                return '$' + amount.toFixed(2);
            } else {
                return 'Rp ' + amount.toLocaleString('id-ID');
            }
        }

        function formatPhoneNumber(phone) {
            // Format Indonesian phone number
            if (phone.startsWith('62')) {
                return '+62 ' + phone.substring(2).replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
            } else if (phone.startsWith('0')) {
                return '+62 ' + phone.substring(1).replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
            } else {
                return phone;
            }
        }

        function updateCurrentDate() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            elements.currentDate.textContent = now.toLocaleDateString('id-ID', options);
        }

        function showToast(message, type = 'info') {
            elements.toastMessage.textContent = message;
            elements.toast.className = 'toast ' + type;
            elements.toast.classList.add('show');
            
            // Update icon based on type
            const icon = elements.toast.querySelector('i');
            icon.className = 
                type === 'success' ? 'fas fa-check-circle' :
                type === 'error' ? 'fas fa-exclamation-circle' :
                type === 'warning' ? 'fas fa-exclamation-triangle' :
                'fas fa-info-circle';
            
            // Hide after 3 seconds
            setTimeout(() => {
                elements.toast.classList.remove('show');
            }, 3000);
            
            // Play sound if enabled
            if (state.settings.enableSound !== false) {
                playNotificationSound(type);
            }
        }

        function playNotificationSound(type) {
            // In a real app, you would play actual sound files
            // This is a simplified version
            console.log(`Playing ${type} notification sound`);
        }

        // ===========================
        // ADDITIONAL FEATURE INTEGRATION
        // ===========================
        
        // Add event listeners for additional features
        document.addEventListener('DOMContentLoaded', function() {
            // Add KTA button to member modal
            const memberModalFooter = document.querySelector('#memberModal .modal-footer');
            if (memberModalFooter && !document.getElementById('generateKtaBtn')) {
                const ktaBtn = document.createElement('button');
                ktaBtn.id = 'generateKtaBtn';
                ktaBtn.className = 'btn btn-donation';
                ktaBtn.innerHTML = '<i class="fas fa-id-card"></i> Buat KTA';
                ktaBtn.addEventListener('click', openKtaModal);
                
                memberModalFooter.insertBefore(ktaBtn, memberModalFooter.firstChild);
            }
            
            // Add history button to settings or main interface
            const settingsModalFooter = document.querySelector('#settingsModal .modal-footer');
            if (settingsModalFooter && !document.getElementById('openHistoryBtn')) {
                const historyBtn = document.createElement('button');
                historyBtn.id = 'openHistoryBtn';
                historyBtn.className = 'btn btn-info';
                historyBtn.innerHTML = '<i class="fas fa-history"></i> Riwayat Transaksi';
                historyBtn.addEventListener('click', function() {
                    elements.settingsModal.style.display = 'none';
                    openHistoryModal();
                });
                
                settingsModalFooter.insertBefore(historyBtn, settingsModalFooter.firstChild);
            }
        });

        // [PERBAIKAN] Memastikan tombol manajemen stok berfungsi dengan benar
        // Fungsi ini sudah diintegrasikan dalam setupEventListeners()
        // Pastikan tidak ada kode yang menghapus atau menonaktifkan fungsi ini

    </script>
</body>
</html>
