<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APLIKASI KASIR SUPERMARKET</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary: #007bff; /* Warna biru untuk supermarket */
            --primary-light: #cce5ff;
            --secondary: #0056b3;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #343a40;
            --gray: #6c757d;
            --white: #ffffff;
            --shadow-sm: 0 0.15rem 0.35rem rgba(0,0,0,0.1);
            --shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
            --rounded-sm: 0.35rem;
            --rounded: 0.75rem;
            --rounded-lg: 1rem;
            --donation: #6f42c1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: #f0f2f5;
            color: #212529;
            line-height: 1.5;
            touch-action: manipulation;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 12px;
        }

        /* Header Styles */
        .app-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--white);
            padding: 12px 16px;
            border-radius: var(--rounded);
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-title-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-logo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--white);
            padding: 5px;
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: var(--primary);
        }

        .app-title {
            font-size: 1.4rem;
            font-weight: 600;
        }

        .header-info {
            text-align: right;
            font-size: 0.9rem;
        }

        .header-info p {
            margin: 2px 0;
        }

        /* Main Content Layout */
        .app-content {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* Panel Styles */
        .panel {
            background: var(--white);
            border-radius: var(--rounded);
            padding: 16px;
            box-shadow: var(--shadow-sm);
        }

        .panel-title {
            font-size: 1.2rem;
            margin-bottom: 12px;
            color: var(--dark);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* Product Grid */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .product-card {
            background: var(--white);
            border-radius: var(--rounded-sm);
            padding: 12px;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s;
            border: 1px solid #eee;
            cursor: pointer;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
            border-color: var(--primary);
        }

        .product-image {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--light);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            overflow: hidden;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .product-image i {
            font-size: 1.5rem;
            color: var(--gray);
        }

        .product-name {
            font-weight: 500;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }

        .product-price {
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 4px;
        }

        .product-stock {
            font-size: 0.8rem;
            font-weight: 500;
        }
        .product-stock.low { color: var(--warning); }
        .product-stock.out-of-stock { color: var(--danger); }

        .product-category {
            font-size: 0.7rem;
            color: var(--gray);
            background-color: var(--light);
            padding: 2px 6px;
            border-radius: 10px;
            margin-top: 4px;
        }

        /* Search and Filter */
        .search-container {
            position: relative;
            margin-bottom: 16px;
        }

        .search-container i {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 40px;
            border: 1px solid #ddd;
            border-radius: var(--rounded-sm);
            font-size: 1rem;
        }

        .filter-row {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            overflow-x: auto;
            padding-bottom: 4px;
        }

        .filter-chip {
            padding: 8px 12px;
            background: var(--light);
            border-radius: 20px;
            font-size: 0.9rem;
            white-space: nowrap;
            cursor: pointer;
        }

        .filter-chip.active {
            background: var(--primary);
            color: var(--white);
        }

        /* Order Styles */
        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }

        .order-item-info {
            flex: 1;
        }

        .order-item-name {
            font-weight: 500;
        }

        .order-item-price {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .whatsapp-link {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }
        .whatsapp-link:hover {
            text-decoration: underline;
        }

        .order-item-qty {
            display: flex;
            align-items: center;
        }

        .qty-btn {
            width: 32px;
            height: 32px;
            border: 1px solid #ddd;
            background: var(--light);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .qty-input {
            width: 40px;
            text-align: center;
            margin: 0 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 6px;
        }

        .remove-btn {
            color: var(--danger);
            margin-left: 8px;
            cursor: pointer;
        }

        /* Summary Styles */
        .summary-container {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px dashed #ddd;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .total-row {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--primary);
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #ddd;
        }

        /* Button Styles */
        .btn {
            display: inline-block;
            padding: 12px 20px;
            background-color: var(--primary);
            color: var(--white);
            border: none;
            border-radius: var(--rounded-sm);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            text-align: center;
            transition: all 0.2s;
            width: 100%;
        }
        
        .btn:disabled {
            background-color: var(--gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn:hover:not(:disabled) {
            background-color: var(--secondary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .btn:active:not(:disabled) {
            transform: translateY(0);
        }
        
        .btn .fa-spinner {
            margin-right: 8px;
        }

        .btn-sm {
            padding: 8px 12px;
            font-size: 0.9rem;
        }

        .btn-success {
            background-color: var(--success);
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-danger {
            background-color: var(--danger);
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-warning {
            background-color: var(--warning);
            color: #000;
        }

        .btn-warning:hover {
            background-color: #e0a800;
        }

        .btn-info {
            background-color: var(--info);
        }

        .btn-info:hover {
            background-color: #138496;
        }
        
        .btn-outline-primary {
            background-color: transparent;
            color: var(--primary);
            border: 1px solid var(--primary);
        }
        
        .btn-outline-primary:hover {
            background-color: var(--primary);
            color: var(--white);
        }

        .btn-donation {
            background-color: var(--donation);
        }

        .btn-donation:hover {
            background-color: #5a32a3;
        }

        /* Tab Styles */
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 16px;
            overflow-x: auto;
        }

        .tab {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            text-align: center;
            flex: 1;
        }

        .tab.active {
            border-bottom: 3px solid var(--primary);
            color: var(--primary);
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background-color: var(--white);
            border-radius: var(--rounded-lg);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
            animation: fadeIn 0.3s;
        }

        .modal-header {
            padding: 16px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }

        .modal-body {
            padding: 16px;
        }

        .modal-footer {
            padding: 16px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-check {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: var(--rounded-sm);
            font-size: 1rem;
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        /* === [PERBAIKAN] DESAIN LOGIN === */
        #loginModal {
            background: linear-gradient(45deg, #f0f2f5, #e6e9ed);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-container {
            width: 100%;
            max-width: 400px;
            margin: 0;
            background: var(--white);
            border-radius: var(--rounded-lg);
            padding: 32px;
            box-shadow: var(--shadow);
            border-top: 5px solid var(--primary);
            animation: fadeIn 0.4s;
        }

        .login-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .login-logo {
            font-size: 3.5rem;
            color: var(--primary);
            margin-bottom: 12px;
            line-height: 1;
        }

        .login-title {
            font-size: 2rem;
            color: var(--dark);
            font-weight: 700;
            letter-spacing: 1px;
        }
        
        .login-header p {
            color: var(--gray);
        }
        /* === AKHIR DARI PERBAIKAN DESAIN LOGIN === */

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 16px;
            background-color: var(--dark);
            color: var(--white);
            border-radius: var(--rounded-sm);
            box-shadow: var(--shadow);
            z-index: 1100;
            display: flex;
            align-items: center;
            transform: translateX(200%);
            transition: transform 0.3s;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background-color: var(--success);
        }

        .toast.error {
            background-color: var(--danger);
        }

        .toast.warning {
            background-color: var(--warning);
            color: #000;
        }

        .toast i {
            margin-right: 8px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 24px;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 3rem;
            color: #ddd;
            margin-bottom: 12px;
        }

        /* Admin Panel */
        .admin-panel {
            display: none;
            margin-top: 16px;
            padding: 16px;
            background-color: var(--light);
            border-radius: var(--rounded);
        }
        
        .admin-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        /* Table Styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 16px;
        }

        .data-table th, .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background-color: var(--light);
            font-weight: 600;
        }

        .data-table tr:hover {
            background-color: #f9f9f9;
        }
        
        .data-table-container {
            max-height: 40vh;
            overflow-y: auto;
        }
        
        .data-table .text-danger { color: var(--danger) !important; font-weight: 500; }
        .data-table .text-success { color: var(--success) !important; font-weight: 500; }

        /* product Actions */
        .product-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            display: none;
            gap: 4px;
        }

        .product-card:hover .product-actions {
            display: flex;
        }

        .action-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.7rem;
            color: white;
        }

        .edit-btn {
            background-color: var(--info);
        }

        .delete-btn {
            background-color: var(--danger);
        }

        /* Note Input */
        .note-input {
            margin-top: 12px;
        }

        .note-input textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: var(--rounded-sm);
            resize: vertical;
            min-height: 60px;
        }

        /* Member Search */
        .member-search-container {
            position: relative;
        }

        .member-search-results {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 var(--rounded-sm) var(--rounded-sm);
            z-index: 100;
            display: none;
        }

        .member-search-item {
            padding: 8px 12px;
            cursor: pointer;
        }

        .member-search-item:hover {
            background-color: var(--light);
        }
        
        /* Payment Modal Enhancements */
        .payment-total-display {
            background: var(--primary-light);
            border-radius: var(--rounded);
            padding: 16px;
            text-align: center;
            margin-bottom: 16px;
        }
        
        .payment-total-display p {
            font-size: 1rem;
            color: var(--secondary);
            margin: 0;
        }
        
        .payment-total-display h3 {
            font-size: 2rem;
            color: var(--primary);
            margin: 0;
        }
        
        .quick-cash-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin: 16px 0;
        }

        /* Member Badge */
        .member-badge {
            background-color: var(--info);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 6px;
        }

        /* Donation Badge */
        .donation-badge {
            background-color: var(--donation);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 6px;
        }

        /* Responsive Adjustments */
        @media (min-width: 768px) {
            .app-content {
                flex-direction: row;
            }
            
            .product-panel {
                flex: 2;
            }
            
            .order-panel {
                flex: 1;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-content {
            animation: fadeIn 0.3s;
        }

        /* Utility Classes */
        .text-center {
            text-align: center;
        }

        .mt-2 {
            margin-top: 8px;
        }

        .mt-3 {
            margin-top: 16px;
        }

        .mb-2 {
            margin-bottom: 8px;
        }

        .mb-3 {
            margin-bottom: 16px;
        }

        .d-flex {
            display: flex;
        }

        .justify-between {
            justify-content: space-between;
        }

        .align-center {
            align-items: center;
        }

        .gap-2 {
            gap: 8px;
        }
        
        /* Footer */
        .app-footer {
            text-align: center;
            margin-top: 20px;
            padding: 10px;
            color: var(--gray);
            font-size: 0.8rem;
        }
        
        /* === [PENYEMPURNAAN] KODE CETAK STRUK & HISTORI === */
        #receiptContent {
            font-family: 'Courier New', Courier, monospace;
            width: 300px;
            margin: 0 auto;
            padding: 15px;
            font-size: 12px;
            line-height: 1.3;
            color: #000;
            background: white;
        }

        .receipt-header {
            text-align: center;
            margin-bottom: 8px;
        }
        
        .receipt-title {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 3px;
        }

        .receipt-info {
            margin-bottom: 8px;
            font-size: 11px;
            border-top: 1px dashed #000;
            border-bottom: 1px dashed #000;
            padding: 5px 0;
        }
        
        .receipt-info div {
            display: flex;
            justify-content: space-between;
        }

        .receipt-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
        }
        
        .receipt-item-details {
            display: block;
        }
        
        .receipt-item-details .item-name {
            font-weight: bold;
        }
        .receipt-item-details .item-price-calc {
            font-size: 10px;
            padding-left: 5px;
        }
        
        #receiptItemsContainer {
             padding: 8px 0;
        }

        .receipt-total {
            font-weight: bold;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed #000;
        }

        .receipt-footer {
            margin-top: 12px;
            font-size: 10px;
            text-align: center;
        }
        
        @media print {
            html, body {
                width: 100%; height: auto; margin: 0 !important; padding: 0 !important;
                overflow: visible !important; box-shadow: none;
            }
            body * { visibility: hidden; }
            #print-container, #print-container * {
                visibility: visible; box-sizing: border-box !important;
            }
            #print-container {
                position: absolute; left: 0; top: 0; width: 100%; height: auto;
                margin: 0; padding: 0; display: block !important;
            }
            #print-container .printable-area, #print-container #receiptContent {
                margin: 0 !important; padding: 5px !important; box-shadow: none !important;
                border: none !important; display: block !important; color: #000 !important;
                background: #fff !important; width: 100% !important; 
                font-size: 11pt !important; page-break-inside: avoid;
            }
            #print-container #receiptContent { font-size: 10pt !important; }
            #print-container #historyResultsContainer, #print-container #historyResults {
                max-height: none !important; overflow: visible !important; height: auto !important;
            }
            .no-print, .modal-footer, .modal-header, .app-header, .app-footer, .order-panel, .product-panel, #loginModal {
                display: none !important;
            }
            @page { size: auto; margin: 10mm; }
        }
        /* === AKHIR DARI PENYEMPURNAAN KODE CETAK === */

        /* Backup Restore Styles */
        .backup-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .backup-btn {
            flex: 1;
        }

        .file-input {
            display: none;
        }

        .file-label {
            display: block;
            padding: 12px;
            background-color: var(--info);
            color: white;
            border-radius: var(--rounded-sm);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-label:hover {
            background-color: #138496;
        }
        
        /* KTA Card Design */
        #ktaCard {
            width: 320px;
            height: 500px;
            margin: 0 auto;
            border-radius: 20px;
            background: radial-gradient(circle at top left, #4f5bd5, #007bff, #17a2b8);
            color: white;
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        #ktaCard::before, #ktaCard::after {
            content: ''; position: absolute; background: rgba(255,255,255,0.1);
            border-radius: 50%; filter: blur(10px);
        }
        #ktaCard::before { top: -80px; left: -80px; width: 200px; height: 200px; }
        #ktaCard::after { bottom: -100px; right: -60px; width: 250px; height: 250px; }
        
        .kta-header {
            text-align: center; border-bottom: 1px solid rgba(255,255,255,0.3);
            padding-bottom: 15px; margin-bottom: 25px; z-index: 1;
        }
        .kta-store-info h3 { font-size: 18px; margin: 0; font-weight: 700; text-shadow: 1px 1px 3px rgba(0,0,0,0.3); }
        .kta-store-info p { font-size: 11px; margin: 0; opacity: 0.9; }
        .kta-body {
            flex-grow: 1; display: flex; flex-direction: column; justify-content: center;
            align-items: center; text-align: center; z-index: 1;
        }
        #ktaMemberName { font-size: 26px; font-weight: 600; margin-bottom: 8px; text-shadow: 1px 1px 3px rgba(0,0,0,0.4); }
        #ktaMemberId {
            font-family: 'Courier New', monospace; font-size: 14px; background-color: rgba(0,0,0,0.3);
            padding: 4px 12px; border-radius: 20px; display: inline-block; margin-bottom: 20px; letter-spacing: 1px;
        }
        .kta-qrcode {
            background: white; padding: 10px; border-radius: 8px; min-height: 160px;
            display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .kta-qrcode img { width: 160px; height: auto; display: block; }
        .kta-footer {
            text-align: center; font-size: 11px; opacity: 0.8; padding-top: 15px;
            margin-top: 25px; border-top: 1px solid rgba(255,255,255,0.3); z-index: 1;
        }

        /* [BARU] Role Management Styles */
        .permission-group {
            margin-bottom: 16px;
        }
        .permission-group-title {
            font-weight: 600;
            margin-bottom: 8px;
            border-bottom: 1px solid #eee;
            padding-bottom: 4px;
        }
        .permission-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .permission-item input {
            margin-right: 10px;
        }

        /* [BARU] Unit Type Styles */
        .unit-type-badge {
            font-size: 0.6rem;
            background-color: var(--dark);
            color: white;
            padding: 1px 4px;
            border-radius: 4px;
            margin-left: 4px;
        }

        /* [BARU] Report Styles */
        .report-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        .report-controls .form-group {
            flex: 1;
            min-width: 150px;
            margin-bottom: 0;
        }
        .report-summary {
            background-color: var(--light);
            padding: 16px;
            border-radius: var(--rounded-sm);
            margin-bottom: 16px;
        }
        .report-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }
        .report-summary-item {
            text-align: center;
            padding: 12px;
            background: white;
            border-radius: var(--rounded-sm);
            box-shadow: var(--shadow-sm);
        }
        .report-summary-item h4 {
            font-size: 1rem;
            margin-bottom: 8px;
            color: var(--gray);
        }
        .report-summary-item p {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0;
        }
        .profit { color: var(--success); }
        .loss { color: var(--danger); }
    </style>
</head>
<body>
    <div id="toast" class="toast">
        <i class="fas fa-info-circle"></i>
        <span id="toast-message">Notification message</span>
    </div>

    <div id="loginModal" class="modal" style="display: flex;">
        <div class="login-container">
            <div class="login-header">
                <div class="login-logo">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <h1 class="login-title">SUPERMARKET</h1>
                <p>Aplikasi Kasir Digital</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username" class="form-label">Username</label>
                    <input type="text" id="username" class="form-control" placeholder="Masukkan username" required>
                </div>
                <div class="form-group">
                    <label for="password" class="form-label">Password</label>
                    <input type="password" id="password" class="form-control" placeholder="Masukkan password" required>
                </div>
                
                <div class="form-group mt-3">
                    <label for="captcha" class="form-label">Verifikasi Keamanan</label>
                    <div class="d-flex align-center gap-2">
                        <canvas id="captchaCanvas" width="150" height="40" style="border: 1px solid #ddd; border-radius: var(--rounded-sm);"></canvas>
                        <button type="button" id="reloadCaptchaBtn" class="btn btn-sm" style="width: auto; background-color: var(--gray);"><i class="fas fa-sync-alt"></i></button>
                    </div>
                    <input type="text" id="captchaInput" class="form-control mt-2" placeholder="Masukkan kode di atas" required autocomplete="off">
                </div>
                <button type="submit" class="btn mt-3">Login</button>
            </form>
        </div>
    </div>

    <div class="container" id="mainApp" style="display: none;">
        <header class="app-header">
            <div class="header-title-container">
                <div class="header-logo">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <div>
                    <h1 class="app-title" id="storeNameHeader">SUPERMARKET</h1>
                    <p id="currentDate">Rabu, 24 September 2025</p>
                </div>
            </div>
            <div class="header-info">
                <p>Kasir: <span id="loggedInUser">Admin</span></p>
                <p><a href="#" id="logoutBtn" style="color: white;">Logout</a></p>
            </div>
        </header>

        <main class="app-content">
            <section class="panel product-panel">
                <h2 class="panel-title">
                    <span>Daftar Produk</span>
                    <span id="productCount">(0 produk)</span>
                </h2>
                
                <div class="search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" id="productSearch" class="search-input" placeholder="Cari produk...">
                </div>
                
                <div class="filter-row">
                    <div class="filter-chip active" data-category="all">Semua</div>
                </div>
                
                <div class="product-grid" id="productGrid"></div>

                <div id="adminPanel" class="admin-panel">
                    <h3 class="panel-title">Admin Panel</h3>
                    <div class="admin-grid">
                        <button id="addProductBtn" class="btn btn-sm">Tambah Produk</button>
                        <button id="manageCategoriesBtn" class="btn btn-sm">Kelola Kategori</button>
                        <button id="manageStockBtn" class="btn btn-sm">Manajemen Stok</button>
                        <button id="manageSuppliersBtn" class="btn btn-sm">Kelola Suplier</button>
                        <button id="processReturnBtn" class="btn btn-sm">Proses Retur</button>
                        <button id="viewReportsBtn" class="btn btn-sm">Laporan</button>
                        <button id="historyBtn" class="btn btn-sm">Histori Transaksi</button>
                        <button id="manageMembersBtn" class="btn btn-sm">Kelola Member</button>
                        <button id="manageStoreInfoBtn" class="btn btn-sm">Info Toko</button>
                        <button id="controlPanelBtn" class="btn btn-sm btn-warning">Kontrol Panel</button>
                        <!-- [BARU] Tombol Menu Laporan Cerdas -->
                        <button id="smartReportBtn" class="btn btn-sm btn-info">Laporan Cerdas</button>
                    </div>
                </div>
            </section>

            <section class="panel order-panel">
                <h2 class="panel-title">Pesanan</h2>
                
                <div class="member-search-container">
                    <input type="text" id="memberSearch" class="form-control" placeholder="Cari member...">
                    <div class="member-search-results" id="memberSearchResults"></div>
                </div>
                
                <div id="orderItemsContainer">
                    <div class="empty-state">
                        <i class="fas fa-shopping-basket"></i>
                        <p>Belum ada pesanan</p>
                    </div>
                </div>
                
                <div class="note-input">
                    <textarea id="orderNote" placeholder="Catatan pesanan..."></textarea>
                </div>
                
                <div class="summary-container">
                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span id="subtotal">Rp 0</span>
                    </div>
                    <div class="summary-row">
                        <span>Diskon:</span>
                        <span id="discount">Rp 0</span>
                    </div>
                    <div class="summary-row">
                        <span>Pajak:</span>
                        <span id="tax">Rp 0</span>
                    </div>
                    <div class="summary-row total-row">
                        <span>Total:</span>
                        <span id="total">Rp 0</span>
                    </div>
                </div>
                
                <div class="d-flex gap-2">
                    <button id="clearOrderBtn" class="btn btn-danger">Hapus</button>
                    <button id="checkoutBtn" class="btn btn-success">Bayar</button>
                </div>
                
                <div class="mt-3">
                    <button id="donationBtn" class="btn btn-donation">Donasi</button>
                </div>
            </section>
        </main>

        <footer class="app-footer">
            <p>&copy; 2025 Aplikasi Kasir Supermarket | Versi 2.0</p>
        </footer>
    </div>

    <!-- Modal untuk Tambah/Edit Produk -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="productModalTitle">Tambah Produk</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="productId">
                    <div class="form-group">
                        <label for="productName" class="form-label">Nama Produk</label>
                        <input type="text" id="productName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="productCategory" class="form-label">Kategori</label>
                        <select id="productCategory" class="form-control" required>
                            <option value="">Pilih Kategori</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="productPrice" class="form-label">Harga</label>
                        <input type="number" id="productPrice" class="form-control" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="productStock" class="form-label">Stok</label>
                        <input type="number" id="productStock" class="form-control" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="productUnit" class="form-label">Satuan</label>
                        <input type="text" id="productUnit" class="form-control" placeholder="Contoh: pcs, kg, liter" required>
                    </div>
                    <div class="form-group">
                        <label for="productBarcode" class="form-label">Barcode (opsional)</label>
                        <input type="text" id="productBarcode" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="productSupplier" class="form-label">Supplier (opsional)</label>
                        <select id="productSupplier" class="form-control">
                            <option value="">Pilih Supplier</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline-primary" id="cancelProductBtn">Batal</button>
                <button class="btn" id="saveProductBtn">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Modal untuk Kelola Kategori -->
    <div id="categoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Kelola Kategori Produk</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="d-flex gap-2 mb-3">
                    <input type="text" id="newCategoryName" class="form-control" placeholder="Nama kategori baru">
                    <button id="addCategoryBtn" class="btn btn-sm">Tambah</button>
                </div>
                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Nama Kategori</th>
                                <th>Jumlah Produk</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="categoryTableBody">
                        </tbody>
                    </table>
                </div>
                <!-- [BARU] Form untuk menambahkan jenis satuan di kategori -->
                <div class="mt-3">
                    <h4 class="panel-title">Kelola Jenis Satuan</h4>
                    <div class="d-flex gap-2 mb-3">
                        <input type="text" id="newUnitType" class="form-control" placeholder="Jenis satuan baru (contoh: pcs, kg)">
                        <button id="addUnitTypeBtn" class="btn btn-sm">Tambah Satuan</button>
                    </div>
                    <div class="data-table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Jenis Satuan</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="unitTypeTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="closeCategoryModalBtn">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Modal untuk Manajemen Stok -->
    <div id="stockModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Manajemen Stok</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <div class="tab active" data-tab="stockAdjustment">Penyesuaian Stok</div>
                    <div class="tab" data-tab="stockOpname">Stok Opname</div>
                    <div class="tab" data-tab="stockHistory">Riwayat Stok</div>
                </div>
                
                <div class="tab-content active" id="stockAdjustment">
                    <div class="search-container">
                        <i class="fas fa-search"></i>
                        <input type="text" id="stockSearch" class="search-input" placeholder="Cari produk...">
                    </div>
                    <div class="data-table-container" style="max-height: 300px;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Produk</th>
                                    <th>Stok Saat Ini</th>
                                    <th>Penyesuaian</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="stockAdjustmentTable">
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="tab-content" id="stockOpname">
                    <div class="d-flex justify-between align-center mb-3">
                        <h4>Stok Opname</h4>
                        <div>
                            <!-- [BARU] Tombol Cetak dan Unduh PDF untuk Stok Opname -->
                            <button id="printStockOpnameBtn" class="btn btn-sm btn-outline-primary"><i class="fas fa-print"></i> Cetak</button>
                            <button id="downloadStockOpnamePdfBtn" class="btn btn-sm btn-outline-primary"><i class="fas fa-download"></i> PDF</button>
                        </div>
                    </div>
                    <div class="data-table-container" style="max-height: 300px;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Produk</th>
                                    <th>Stok Sistem</th>
                                    <th>Stok Fisik</th>
                                    <th>Selisih</th>
                                    <th>Keterangan</th>
                                </tr>
                            </thead>
                            <tbody id="stockOpnameTable">
                            </tbody>
                        </table>
                    </div>
                    <button id="startStockOpnameBtn" class="btn mt-3">Mulai Stok Opname</button>
                </div>
                
                <div class="tab-content" id="stockHistory">
                    <div class="d-flex justify-between align-center mb-3">
                        <h4>Riwayat Perubahan Stok</h4>
                        <div>
                            <!-- [BARU] Tombol Cetak dan Unduh PDF untuk Riwayat Stok -->
                            <button id="printStockHistoryBtn" class="btn btn-sm btn-outline-primary"><i class="fas fa-print"></i> Cetak</button>
                            <button id="downloadStockHistoryPdfBtn" class="btn btn-sm btn-outline-primary"><i class="fas fa-download"></i> PDF</button>
                        </div>
                    </div>
                    <div class="report-controls">
                        <div class="form-group">
                            <label for="stockHistoryFilter" class="form-label">Filter Periode</label>
                            <select id="stockHistoryFilter" class="form-control">
                                <option value="today">Hari Ini</option>
                                <option value="week">Minggu Ini</option>
                                <option value="month">Bulan Ini</option>
                                <option value="year">Tahun Ini</option>
                                <option value="custom">Kustom</option>
                            </select>
                        </div>
                        <div class="form-group" id="stockHistoryCustomRange" style="display: none;">
                            <label for="stockHistoryStartDate" class="form-label">Dari Tanggal</label>
                            <input type="date" id="stockHistoryStartDate" class="form-control">
                            <label for="stockHistoryEndDate" class="form-label">Sampai Tanggal</label>
                            <input type="date" id="stockHistoryEndDate" class="form-control">
                        </div>
                    </div>
                    <div class="data-table-container" style="max-height: 300px;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Tanggal</th>
                                    <th>Produk</th>
                                    <th>Perubahan</th>
                                    <th>Stok Akhir</th>
                                    <th>Tipe</th>
                                    <th>User</th>
                                </tr>
                            </thead>
                            <tbody id="stockHistoryTable">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="closeStockModalBtn">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Modal untuk Kelola Supplier -->
    <div id="supplierModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Kelola Supplier</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="d-flex gap-2 mb-3">
                    <input type="text" id="newSupplierName" class="form-control" placeholder="Nama supplier">
                    <input type="text" id="newSupplierContact" class="form-control" placeholder="Kontak">
                    <button id="addSupplierBtn" class="btn btn-sm">Tambah</button>
                </div>
                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Nama Supplier</th>
                                <th>Kontak</th>
                                <th>Jumlah Produk</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="supplierTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="closeSupplierModalBtn">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Modal untuk Proses Retur -->
    <div id="returnModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Proses Retur Produk</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="returnTransactionId" class="form-label">Cari Transaksi</label>
                    <input type="text" id="returnTransactionId" class="form-control" placeholder="Masukkan ID Transaksi">
                </div>
                <div id="returnTransactionDetails" style="display: none;">
                    <h4>Detail Transaksi</h4>
                    <div id="returnItemsContainer"></div>
                    <div class="form-group">
                        <label for="returnReason" class="form-label">Alasan Retur</label>
                        <select id="returnReason" class="form-control">
                            <option value="kerusakan">Produk Rusak</option>
                            <option value="tidak-sesuai">Tidak Sesuai Pesanan</option>
                            <option value="kadaluarsa">Kadaluarsa</option>
                            <option value="lainnya">Lainnya</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="returnNote" class="form-label">Catatan Tambahan</label>
                        <textarea id="returnNote" class="form-control"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline-primary" id="cancelReturnBtn">Batal</button>
                <button class="btn btn-danger" id="processReturnBtn" disabled>Proses Retur</button>
            </div>
        </div>
    </div>

    <!-- Modal untuk Laporan -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Laporan Penjualan</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="report-controls">
                    <div class="form-group">
                        <label for="reportType" class="form-label">Jenis Laporan</label>
                        <select id="reportType" class="form-control">
                            <option value="sales">Laporan Penjualan</option>
                            <option value="products">Laporan Produk</option>
                            <option value="donations">Laporan Donasi</option>
                            <option value="returns">Laporan Retur</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="reportPeriod" class="form-label">Periode</label>
                        <select id="reportPeriod" class="form-control">
                            <option value="today">Hari Ini</option>
                            <option value="yesterday">Kemarin</option>
                            <option value="week">Minggu Ini</option>
                            <option value="month">Bulan Ini</option>
                            <option value="year">Tahun Ini</option>
                            <option value="custom">Kustom</option>
                        </select>
                    </div>
                    <div class="form-group" id="customDateRange" style="display: none;">
                        <label for="startDate" class="form-label">Dari Tanggal</label>
                        <input type="date" id="startDate" class="form-control">
                        <label for="endDate" class="form-label">Sampai Tanggal</label>
                        <input type="date" id="endDate" class="form-control">
                    </div>
                </div>
                
                <div class="report-summary">
                    <div class="report-summary-grid" id="reportSummary">
                        <!-- Summary akan diisi oleh JavaScript -->
                    </div>
                </div>
                
                <div class="data-table-container">
                    <table class="data-table" id="reportTable">
                        <!-- Tabel laporan akan diisi oleh JavaScript -->
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline-primary" id="printReportBtn"><i class="fas fa-print"></i> Cetak</button>
                <button class="btn btn-outline-primary" id="exportReportBtn"><i class="fas fa-download"></i> Export</button>
                <button class="btn" id="closeReportModalBtn">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Modal untuk Histori Transaksi -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Histori Transaksi</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="report-controls">
                    <div class="form-group">
                        <label for="historyFilter" class="form-label">Filter Periode</label>
                        <select id="historyFilter" class="form-control">
                            <option value="today">Hari Ini</option>
                            <option value="week">Minggu Ini</option>
                            <option value="month">Bulan Ini</option>
                            <option value="year">Tahun Ini</option>
                            <option value="custom">Kustom</option>
                        </select>
                    </div>
                    <div class="form-group" id="historyCustomRange" style="display: none;">
                        <label for="historyStartDate" class="form-label">Dari Tanggal</label>
                        <input type="date" id="historyStartDate" class="form-control">
                        <label for="historyEndDate" class="form-label">Sampai Tanggal</label>
                        <input type="date" id="historyEndDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="historySearch" class="form-label">Cari Transaksi</label>
                        <input type="text" id="historySearch" class="form-control" placeholder="Cari berdasarkan ID atau nama produk">
                    </div>
                </div>
                
                <div class="data-table-container" style="max-height: 400px;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Tanggal</th>
                                <th>ID Transaksi</th>
                                <th>Items</th>
                                <th>Total</th>
                                <th>Kasir</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline-primary" id="printHistoryBtn"><i class="fas fa-print"></i> Cetak</button>
                <button class="btn" id="closeHistoryModalBtn">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Modal untuk Kelola Member -->
    <div id="memberModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Kelola Member</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="d-flex gap-2 mb-3">
                    <input type="text" id="newMemberName" class="form-control" placeholder="Nama member">
                    <input type="text" id="newMemberPhone" class="form-control" placeholder="No. Telepon">
                    <button id="addMemberBtn" class="btn btn-sm">Tambah</button>
                </div>
                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Nama</th>
                                <th>Telepon</th>
                                <th>Alamat</th>
                                <th>Poin</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="memberTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="closeMemberModalBtn">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Modal untuk Info Toko -->
    <div id="storeInfoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Informasi Toko</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="storeInfoForm">
                    <div class="form-group">
                        <label for="storeName" class="form-label">Nama Toko</label>
                        <input type="text" id="storeName" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="storeAddress" class="form-label">Alamat</label>
                        <textarea id="storeAddress" class="form-control"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="storePhone" class="form-label">Telepon</label>
                        <input type="text" id="storePhone" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="storeTax" class="form-label">PPN (%)</label>
                        <input type="number" id="storeTax" class="form-control" min="0" max="100" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="receiptFooter" class="form-label">Footer Struk</label>
                        <textarea id="receiptFooter" class="form-control"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline-primary" id="cancelStoreInfoBtn">Batal</button>
                <button class="btn" id="saveStoreInfoBtn">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Modal untuk Kontrol Panel -->
    <div id="controlPanelModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Kontrol Panel Admin</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="admin-grid">
                    <button id="backupDataBtn" class="btn btn-sm">Backup Data</button>
                    <button id="restoreDataBtn" class="btn btn-sm">Restore Data</button>
                    <button id="resetDataBtn" class="btn btn-sm btn-danger">Reset Data</button>
                    <button id="manageUsersBtn" class="btn btn-sm">Kelola User</button>
                    <button id="printKtaBtn" class="btn btn-sm">Cetak KTA Member</button>
                    <button id="systemInfoBtn" class="btn btn-sm">Info Sistem</button>
                </div>
                
                <div id="backupRestoreSection" style="display: none; margin-top: 16px;">
                    <div class="backup-actions">
                        <button id="downloadBackupBtn" class="btn backup-btn">Download Backup</button>
                        <label for="restoreFile" class="file-label">Upload Backup</label>
                        <input type="file" id="restoreFile" class="file-input" accept=".json">
                    </div>
                </div>
                
                <div id="userManagementSection" style="display: none; margin-top: 16px;">
                    <div class="d-flex gap-2 mb-3">
                        <input type="text" id="newUsername" class="form-control" placeholder="Username">
                        <input type="password" id="newPassword" class="form-control" placeholder="Password">
                        <select id="newUserRole" class="form-control">
                            <option value="kasir">Kasir</option>
                            <option value="admin">Admin</option>
                        </select>
                        <button id="addUserBtn" class="btn btn-sm">Tambah User</button>
                    </div>
                    <div class="data-table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Role</th>
                                    <th>Terakhir Login</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="userTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div id="systemInfoSection" style="display: none; margin-top: 16px;">
                    <div class="data-table">
                        <tr><td>Versi Aplikasi</td><td>2.0</td></tr>
                        <tr><td>Jumlah Produk</td><td id="systemProductCount">0</td></tr>
                        <tr><td>Jumlah Transaksi</td><td id="systemTransactionCount">0</td></tr>
                        <tr><td>Jumlah Member</td><td id="systemMemberCount">0</td></tr>
                        <tr><td>Total Penjualan</td><td id="systemTotalSales">Rp 0</td></tr>
                        <tr><td>Browser</td><td id="systemBrowser">-</td></tr>
                        <tr><td>Lokasi</td><td id="systemLocation">-</td></tr>
                    </div>
                </div>
                
                <div id="ktaSection" style="display: none; margin-top: 16px;">
                    <div class="form-group">
                        <label for="ktaMemberSelect" class="form-label">Pilih Member</label>
                        <select id="ktaMemberSelect" class="form-control">
                            <option value="">Pilih Member</option>
                        </select>
                    </div>
                    <div id="ktaCard" style="display: none;">
                        <div class="kta-header">
                            <div class="kta-store-info">
                                <h3 id="ktaStoreName">SUPERMARKET</h3>
                                <p id="ktaStoreAddress">Alamat Toko</p>
                            </div>
                        </div>
                        <div class="kta-body">
                            <h2 id="ktaMemberName">Nama Member</h2>
                            <div id="ktaMemberId">ID: MEM-001</div>
                            <div class="kta-qrcode">
                                <img id="ktaQrCode" src="" alt="QR Code">
                            </div>
                        </div>
                        <div class="kta-footer">
                            <p>Kartu ini berlaku selama menjadi member aktif</p>
                        </div>
                    </div>
                    <button id="printKtaCardBtn" class="btn mt-3" style="display: none;">Cetak Kartu</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="closeControlPanelBtn">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Modal untuk Pembayaran -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Pembayaran</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="payment-total-display">
                    <p>Total yang harus dibayar:</p>
                    <h3 id="paymentTotal">Rp 0</h3>
                </div>
                
                <div class="form-group">
                    <label for="paymentMethod" class="form-label">Metode Pembayaran</label>
                    <select id="paymentMethod" class="form-control">
                        <option value="cash">Tunai</option>
                        <option value="transfer">Transfer</option>
                        <option value="debit">Kartu Debit</option>
                        <option value="credit">Kartu Kredit</option>
                        <option value="qris">QRIS</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="amountPaid" class="form-label">Jumlah Bayar</label>
                    <input type="number" id="amountPaid" class="form-control" min="0">
                </div>
                
                <div class="quick-cash-buttons">
                    <button class="btn btn-sm" data-amount="10000">10K</button>
                    <button class="btn btn-sm" data-amount="20000">20K</button>
                    <button class="btn btn-sm" data-amount="50000">50K</button>
                    <button class="btn btn-sm" data-amount="100000">100K</button>
                    <button class="btn btn-sm" data-amount="150000">150K</button>
                    <button class="btn btn-sm" data-amount="200000">200K</button>
                </div>
                
                <div id="changeAmount" style="display: none;">
                    <p>Kembalian: <span id="changeValue">Rp 0</span></p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline-primary" id="cancelPaymentBtn">Batal</button>
                <button class="btn btn-success" id="confirmPaymentBtn" disabled>Konfirmasi Pembayaran</button>
            </div>
        </div>
    </div>

    <!-- Modal untuk Donasi -->
    <div id="donationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Donasi</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="donationAmount" class="form-label">Jumlah Donasi</label>
                    <input type="number" id="donationAmount" class="form-control" min="1000" value="1000">
                </div>
                <div class="form-group">
                    <label for="donationNote" class="form-label">Catatan Donasi</label>
                    <input type="text" id="donationNote" class="form-control" placeholder="Contoh: Untuk korban bencana">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline-primary" id="cancelDonationBtn">Batal</button>
                <button class="btn btn-donation" id="confirmDonationBtn">Konfirmasi Donasi</button>
            </div>
        </div>
    </div>

    <!-- Modal untuk Detail Transaksi -->
    <div id="transactionDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Detail Transaksi</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="transactionDetailContent">
                    <!-- Detail transaksi akan diisi oleh JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline-primary" id="printReceiptBtn">Cetak Struk</button>
                <button class="btn" id="closeTransactionDetailBtn">Tutup</button>
            </div>
        </div>
    </div>

    <!-- [BARU] Modal untuk Laporan Cerdas -->
    <div id="smartReportModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title">Laporan Cerdas - Analisis Lengkap</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="report-controls">
                    <div class="form-group">
                        <label for="smartReportType" class="form-label">Jenis Laporan</label>
                        <select id="smartReportType" class="form-control">
                            <option value="sales">Laporan Penjualan (Laba/Rugi)</option>
                            <option value="returns">Laporan Retur</option>
                            <option value="stock">Laporan Pasokan/Stok</option>
                            <option value="donations">Laporan Donasi</option>
                            <option value="members">Laporan Member</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="smartReportPeriod" class="form-label">Periode Laporan</label>
                        <select id="smartReportPeriod" class="form-control">
                            <option value="today">Hari Ini</option>
                            <option value="yesterday">Kemarin</option>
                            <option value="week">Minggu Ini</option>
                            <option value="month">Bulan Ini</option>
                            <option value="year">Tahun Ini</option>
                            <option value="custom">Rentang Tanggal</option>
                        </select>
                    </div>
                    <div class="form-group" id="smartReportCustomRange" style="display: none;">
                        <label for="smartReportStartDate" class="form-label">Dari Tanggal</label>
                        <input type="date" id="smartReportStartDate" class="form-control">
                        <label for="smartReportEndDate" class="form-label">Sampai Tanggal</label>
                        <input type="date" id="smartReportEndDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <button id="generateSmartReportBtn" class="btn btn-info" style="margin-top: 24px;">Generate Laporan</button>
                    </div>
                </div>
                
                <div id="smartReportSummary" class="report-summary" style="display: none;">
                    <h4 class="panel-title">Ringkasan Laporan</h4>
                    <div class="report-summary-grid" id="smartReportSummaryGrid">
                        <!-- Ringkasan laporan akan diisi oleh JavaScript -->
                    </div>
                </div>
                
                <div id="smartReportContent" style="display: none;">
                    <h4 class="panel-title">Detail Laporan</h4>
                    <div class="data-table-container" style="max-height: 400px;">
                        <table class="data-table" id="smartReportTable">
                            <!-- Tabel laporan cerdas akan diisi oleh JavaScript -->
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline-primary" id="printSmartReportBtn" style="display: none;"><i class="fas fa-print"></i> Cetak PDF</button>
                <button class="btn btn-outline-primary" id="exportSmartReportExcelBtn" style="display: none;"><i class="fas fa-file-excel"></i> Export Excel</button>
                <button class="btn" id="closeSmartReportModalBtn">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Container untuk cetak struk (hidden) -->
    <div id="print-container" style="display: none;"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Deklarasi variabel global
        let products = [];
        let categories = [];
        let suppliers = [];
        let members = [];
        let users = [];
        let currentOrder = [];
        let transactions = [];
        let stockHistory = [];
        let unitTypes = []; // [BARU] Array untuk jenis satuan
        let storeInfo = {};
        let currentUser = null;
        let selectedMember = null;
        let captchaText = '';

        // Inisialisasi aplikasi saat halaman dimuat
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            generateCaptcha();
        });

        function initializeApp() {
            // Load data dari localStorage
            loadDataFromStorage();
            
            // Set tanggal hari ini
            updateCurrentDate();
            
            // Tampilkan jumlah produk
            updateProductCount();
            
            // Render daftar produk
            renderProducts();
            
            // Render kategori filter
            renderCategoryFilters();
            
            // Render daftar kategori di modal
            renderCategories();
            
            // [BARU] Render daftar jenis satuan
            renderUnitTypes();
        }

        function loadDataFromStorage() {
            // Load data dari localStorage atau gunakan data default
            products = JSON.parse(localStorage.getItem('products')) || [
                { id: 1, name: 'Beras Premium', category: 'Sembako', price: 12500, stock: 50, unit: 'kg', barcode: '123456', supplier: 'Supplier A' },
                { id: 2, name: 'Minyak Goreng', category: 'Sembako', price: 15000, stock: 30, unit: 'liter', barcode: '123457', supplier: 'Supplier A' },
                { id: 3, name: 'Gula Pasir', category: 'Sembako', price: 12000, stock: 25, unit: 'kg', barcode: '123458', supplier: 'Supplier B' },
                { id: 4, name: 'Sabun Mandi', category: 'Kebutuhan Rumah Tangga', price: 5000, stock: 100, unit: 'pcs', barcode: '123459', supplier: 'Supplier C' },
                { id: 5, name: 'Shampoo', category: 'Kebutuhan Rumah Tangga', price: 8000, stock: 80, unit: 'pcs', barcode: '123460', supplier: 'Supplier C' },
                { id: 6, name: 'Pasta Gigi', category: 'Kebutuhan Rumah Tangga', price: 6000, stock: 60, unit: 'pcs', barcode: '123461', supplier: 'Supplier D' },
                { id: 7, name: 'Air Mineral', category: 'Minuman', price: 3000, stock: 200, unit: 'botol', barcode: '123462', supplier: 'Supplier E' },
                { id: 8, name: 'Kopi Sachet', category: 'Minuman', price: 2000, stock: 150, unit: 'pcs', barcode: '123463', supplier: 'Supplier F' }
            ];
            
            categories = JSON.parse(localStorage.getItem('categories')) || [
                'Sembako', 'Kebutuhan Rumah Tangga', 'Minuman', 'Makanan Ringan', 'Buah dan Sayur'
            ];
            
            // [BARU] Inisialisasi jenis satuan jika belum ada
            unitTypes = JSON.parse(localStorage.getItem('unitTypes')) || [
                'pcs', 'kg', 'liter', 'botol', 'pack', 'bungkus'
            ];
            
            suppliers = JSON.parse(localStorage.getItem('suppliers')) || [
                { id: 1, name: 'Supplier A', contact: '08123456789' },
                { id: 2, name: 'Supplier B', contact: '08123456788' },
                { id: 3, name: 'Supplier C', contact: '08123456787' }
            ];
            
            members = JSON.parse(localStorage.getItem('members')) || [
                { id: 1, name: 'Budi Santoso', phone: '08123456789', address: 'Jl. Merdeka No. 123', points: 100 },
                { id: 2, name: 'Siti Aminah', phone: '08123456788', address: 'Jl. Sudirman No. 45', points: 50 },
                { id: 3, name: 'Ahmad Wijaya', phone: '08123456787', address: 'Jl. Diponegoro No. 67', points: 200 }
            ];
            
            users = JSON.parse(localStorage.getItem('users')) || [
                { username: 'admin', password: 'admin123', role: 'admin', lastLogin: new Date().toISOString() },
                { username: 'kasir1', password: 'kasir123', role: 'kasir', lastLogin: new Date().toISOString() }
            ];
            
            transactions = JSON.parse(localStorage.getItem('transactions')) || [];
            stockHistory = JSON.parse(localStorage.getItem('stockHistory')) || [];
            
            storeInfo = JSON.parse(localStorage.getItem('storeInfo')) || {
                name: 'SUPERMARKET',
                address: 'Jl. Raya Contoh No. 123, Kota Contoh',
                phone: '(021) 1234567',
                tax: 10,
                receiptFooter: 'Terima kasih atas kunjungan Anda'
            };
            
            // Update header toko
            document.getElementById('storeNameHeader').textContent = storeInfo.name;
        }

        function saveDataToStorage() {
            localStorage.setItem('products', JSON.stringify(products));
            localStorage.setItem('categories', JSON.stringify(categories));
            localStorage.setItem('unitTypes', JSON.stringify(unitTypes)); // [BARU] Simpan jenis satuan
            localStorage.setItem('suppliers', JSON.stringify(suppliers));
            localStorage.setItem('members', JSON.stringify(members));
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('transactions', JSON.stringify(transactions));
            localStorage.setItem('stockHistory', JSON.stringify(stockHistory));
            localStorage.setItem('storeInfo', JSON.stringify(storeInfo));
        }

        function updateCurrentDate() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('id-ID', options);
        }

        function updateProductCount() {
            const count = products.length;
            document.getElementById('productCount').textContent = `(${count} produk)`;
        }

        function renderProducts(filteredProducts = null) {
            const productGrid = document.getElementById('productGrid');
            const productsToRender = filteredProducts || products;
            
            if (productsToRender.length === 0) {
                productGrid.innerHTML = '<div class="empty-state"><i class="fas fa-box-open"></i><p>Tidak ada produk</p></div>';
                return;
            }
            
            productGrid.innerHTML = '';
            
            productsToRender.forEach(product => {
                const stockClass = product.stock === 0 ? 'out-of-stock' : (product.stock < 10 ? 'low' : '');
                
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.innerHTML = `
                    <div class="product-actions">
                        <div class="action-btn edit-btn" data-id="${product.id}">
                            <i class="fas fa-edit"></i>
                        </div>
                        <div class="action-btn delete-btn" data-id="${product.id}">
                            <i class="fas fa-trash"></i>
                        </div>
                    </div>
                    <div class="product-image">
                        <i class="fas fa-box"></i>
                    </div>
                    <div class="product-name">${product.name}</div>
                    <div class="product-price">Rp ${formatNumber(product.price)}</div>
                    <div class="product-stock ${stockClass}">Stok: ${product.stock} ${product.unit}</div>
                    <div class="product-category">${product.category}</div>
                `;
                
                productCard.addEventListener('click', (e) => {
                    if (!e.target.closest('.product-actions')) {
                        addToOrder(product);
                    }
                });
                
                productGrid.appendChild(productCard);
            });
            
            // Tambahkan event listener untuk edit dan hapus
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const productId = parseInt(btn.getAttribute('data-id'));
                    editProduct(productId);
                });
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const productId = parseInt(btn.getAttribute('data-id'));
                    deleteProduct(productId);
                });
            });
        }

        function renderCategoryFilters() {
            const filterRow = document.querySelector('.filter-row');
            // Hapus semua filter chip kecuali "Semua"
            const allChip = filterRow.querySelector('.filter-chip[data-category="all"]');
            filterRow.innerHTML = '';
            filterRow.appendChild(allChip);
            
            // Tambahkan filter untuk setiap kategori
            categories.forEach(category => {
                const chip = document.createElement('div');
                chip.className = 'filter-chip';
                chip.textContent = category;
                chip.setAttribute('data-category', category);
                filterRow.appendChild(chip);
            });
            
            // Event listener untuk filter
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.addEventListener('click', function() {
                    document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    
                    const category = this.getAttribute('data-category');
                    if (category === 'all') {
                        renderProducts();
                    } else {
                        const filteredProducts = products.filter(p => p.category === category);
                        renderProducts(filteredProducts);
                    }
                });
            });
        }

        function renderCategories() {
            const categoryTableBody = document.getElementById('categoryTableBody');
            categoryTableBody.innerHTML = '';
            
            categories.forEach((category, index) => {
                const productCount = products.filter(p => p.category === category).length;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${category}</td>
                    <td>${productCount} produk</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary edit-category-btn" data-index="${index}">Edit</button>
                        <button class="btn btn-sm btn-danger delete-category-btn" data-index="${index}">Hapus</button>
                    </td>
                `;
                categoryTableBody.appendChild(row);
            });
            
            // Event listener untuk edit dan hapus kategori
            document.querySelectorAll('.edit-category-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    editCategory(index);
                });
            });
            
            document.querySelectorAll('.delete-category-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    deleteCategory(index);
                });
            });
        }

        // [BARU] Fungsi untuk render jenis satuan
        function renderUnitTypes() {
            const unitTypeTableBody = document.getElementById('unitTypeTableBody');
            unitTypeTableBody.innerHTML = '';
            
            unitTypes.forEach((unitType, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${unitType}</td>
                    <td>
                        <button class="btn btn-sm btn-danger delete-unit-type-btn" data-index="${index}">Hapus</button>
                    </td>
                `;
                unitTypeTableBody.appendChild(row);
            });
            
            // Event listener untuk hapus jenis satuan
            document.querySelectorAll('.delete-unit-type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    deleteUnitType(index);
                });
            });
        }

        function addToOrder(product) {
            // Cek apakah produk sudah ada di pesanan
            const existingItem = currentOrder.find(item => item.product.id === product.id);
            
            if (existingItem) {
                // Jika sudah ada, tambah jumlah
                existingItem.quantity += 1;
            } else {
                // Jika belum ada, tambah item baru
                currentOrder.push({
                    product: product,
                    quantity: 1
                });
            }
            
            // Update tampilan pesanan
            renderOrderItems();
            updateOrderSummary();
            
            // Tampilkan notifikasi
            showToast(`${product.name} ditambahkan ke pesanan`, 'success');
        }

        function renderOrderItems() {
            const orderItemsContainer = document.getElementById('orderItemsContainer');
            
            if (currentOrder.length === 0) {
                orderItemsContainer.innerHTML = '<div class="empty-state"><i class="fas fa-shopping-basket"></i><p>Belum ada pesanan</p></div>';
                return;
            }
            
            orderItemsContainer.innerHTML = '';
            
            currentOrder.forEach((item, index) => {
                const orderItem = document.createElement('div');
                orderItem.className = 'order-item';
                orderItem.innerHTML = `
                    <div class="order-item-info">
                        <div class="order-item-name">${item.product.name}</div>
                        <div class="order-item-price">Rp ${formatNumber(item.product.price)} / ${item.product.unit}</div>
                    </div>
                    <div class="order-item-qty">
                        <div class="qty-btn decrease-qty" data-index="${index}">-</div>
                        <input type="number" class="qty-input" value="${item.quantity}" min="1" data-index="${index}">
                        <div class="qty-btn increase-qty" data-index="${index}">+</div>
                        <div class="remove-btn" data-index="${index}"><i class="fas fa-trash"></i></div>
                    </div>
                `;
                orderItemsContainer.appendChild(orderItem);
            });
            
            // Tambahkan event listener untuk tombol kuantitas
            document.querySelectorAll('.decrease-qty').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    decreaseQuantity(index);
                });
            });
            
            document.querySelectorAll('.increase-qty').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    increaseQuantity(index);
                });
            });
            
            document.querySelectorAll('.qty-input').forEach(input => {
                input.addEventListener('change', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    updateQuantity(index, parseInt(this.value));
                });
            });
            
            document.querySelectorAll('.remove-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    removeFromOrder(index);
                });
            });
        }

        function decreaseQuantity(index) {
            if (currentOrder[index].quantity > 1) {
                currentOrder[index].quantity -= 1;
                renderOrderItems();
                updateOrderSummary();
            }
        }

        function increaseQuantity(index) {
            currentOrder[index].quantity += 1;
            renderOrderItems();
            updateOrderSummary();
        }

        function updateQuantity(index, newQuantity) {
            if (newQuantity > 0) {
                currentOrder[index].quantity = newQuantity;
                renderOrderItems();
                updateOrderSummary();
            } else {
                removeFromOrder(index);
            }
        }

        function removeFromOrder(index) {
            const productName = currentOrder[index].product.name;
            currentOrder.splice(index, 1);
            renderOrderItems();
            updateOrderSummary();
            showToast(`${productName} dihapus dari pesanan`, 'warning');
        }

        function updateOrderSummary() {
            const subtotal = currentOrder.reduce((sum, item) => sum + (item.product.price * item.quantity), 0);
            const tax = subtotal * (storeInfo.tax / 100);
            const total = subtotal + tax;
            
            document.getElementById('subtotal').textContent = `Rp ${formatNumber(subtotal)}`;
            document.getElementById('tax').textContent = `Rp ${formatNumber(tax)}`;
            document.getElementById('total').textContent = `Rp ${formatNumber(total)}`;
            
            // Update total di modal pembayaran
            document.getElementById('paymentTotal').textContent = `Rp ${formatNumber(total)}`;
        }

        function formatNumber(number) {
            return new Intl.NumberFormat('id-ID').format(number);
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            toastMessage.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function generateCaptcha() {
            const canvas = document.getElementById('captchaCanvas');
            const ctx = canvas.getContext('2d');
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Generate random text
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';
            captchaText = '';
            for (let i = 0; i < 5; i++) {
                captchaText += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            
            // Draw background
            ctx.fillStyle = '#f0f0f0';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw text with random rotation and position
            for (let i = 0; i < captchaText.length; i++) {
                ctx.save();
                ctx.translate(20 + i * 25, 25);
                ctx.rotate((Math.random() - 0.5) * 0.4);
                ctx.fillStyle = '#333';
                ctx.font = 'bold 20px Arial';
                ctx.fillText(captchaText[i], 0, 0);
                ctx.restore();
            }
            
            // Draw noise
            for (let i = 0; i < 50; i++) {
                ctx.beginPath();
                ctx.moveTo(Math.random() * canvas.width, Math.random() * canvas.height);
                ctx.lineTo(Math.random() * canvas.width, Math.random() * canvas.height);
                ctx.strokeStyle = `rgba(0, 0, 0, ${Math.random() * 0.3})`;
                ctx.stroke();
            }
        }

        function setupEventListeners() {
            // Event listener untuk login
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                handleLogin();
            });
            
            document.getElementById('reloadCaptchaBtn').addEventListener('click', generateCaptcha);
            
            // Event listener untuk logout
            document.getElementById('logoutBtn').addEventListener('click', function(e) {
                e.preventDefault();
                handleLogout();
            });
            
            // Event listener untuk pencarian produk
            document.getElementById('productSearch').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const filteredProducts = products.filter(p => 
                    p.name.toLowerCase().includes(searchTerm) || 
                    p.category.toLowerCase().includes(searchTerm)
                );
                renderProducts(filteredProducts);
            });
            
            // Event listener untuk pencarian member
            document.getElementById('memberSearch').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const resultsContainer = document.getElementById('memberSearchResults');
                
                if (searchTerm.length < 2) {
                    resultsContainer.style.display = 'none';
                    return;
                }
                
                const filteredMembers = members.filter(m => 
                    m.name.toLowerCase().includes(searchTerm) || 
                    m.phone.includes(searchTerm)
                );
                
                if (filteredMembers.length > 0) {
                    resultsContainer.innerHTML = '';
                    filteredMembers.forEach(member => {
                        const item = document.createElement('div');
                        item.className = 'member-search-item';
                        item.textContent = `${member.name} (${member.phone})`;
                        item.addEventListener('click', function() {
                            selectMember(member);
                            resultsContainer.style.display = 'none';
                            document.getElementById('memberSearch').value = '';
                        });
                        resultsContainer.appendChild(item);
                    });
                    resultsContainer.style.display = 'block';
                } else {
                    resultsContainer.style.display = 'none';
                }
            });
            
            // Event listener untuk tombol admin
            document.getElementById('addProductBtn').addEventListener('click', function() {
                openProductModal();
            });
            
            document.getElementById('manageCategoriesBtn').addEventListener('click', function() {
                openCategoryModal();
            });
            
            document.getElementById('manageStockBtn').addEventListener('click', function() {
                openStockModal();
            });
            
            document.getElementById('manageSuppliersBtn').addEventListener('click', function() {
                openSupplierModal();
            });
            
            document.getElementById('processReturnBtn').addEventListener('click', function() {
                openReturnModal();
            });
            
            document.getElementById('viewReportsBtn').addEventListener('click', function() {
                openReportModal();
            });
            
            document.getElementById('historyBtn').addEventListener('click', function() {
                openHistoryModal();
            });
            
            document.getElementById('manageMembersBtn').addEventListener('click', function() {
                openMemberModal();
            });
            
            document.getElementById('manageStoreInfoBtn').addEventListener('click', function() {
                openStoreInfoModal();
            });
            
            document.getElementById('controlPanelBtn').addEventListener('click', function() {
                openControlPanelModal();
            });
            
            // [BARU] Event listener untuk tombol Laporan Cerdas
            document.getElementById('smartReportBtn').addEventListener('click', function() {
                openSmartReportModal();
            });
            
            // Event listener untuk tombol pesanan
            document.getElementById('clearOrderBtn').addEventListener('click', function() {
                clearOrder();
            });
            
            document.getElementById('checkoutBtn').addEventListener('click', function() {
                if (currentOrder.length === 0) {
                    showToast('Tidak ada item dalam pesanan', 'error');
                    return;
                }
                openPaymentModal();
            });
            
            document.getElementById('donationBtn').addEventListener('click', function() {
                openDonationModal();
            });
            
            // Event listener untuk modal produk
            document.getElementById('saveProductBtn').addEventListener('click', function() {
                saveProduct();
            });
            
            document.getElementById('cancelProductBtn').addEventListener('click', function() {
                closeModal('productModal');
            });
            
            // Event listener untuk modal kategori
            document.getElementById('addCategoryBtn').addEventListener('click', function() {
                addCategory();
            });
            
            document.getElementById('closeCategoryModalBtn').addEventListener('click', function() {
                closeModal('categoryModal');
            });
            
            // [BARU] Event listener untuk modal jenis satuan
            document.getElementById('addUnitTypeBtn').addEventListener('click', function() {
                addUnitType();
            });
            
            // Event listener untuk modal stok
            document.getElementById('closeStockModalBtn').addEventListener('click', function() {
                closeModal('stockModal');
            });
            
            // [BARU] Event listener untuk tombol cetak dan unduh stok opname
            document.getElementById('printStockOpnameBtn').addEventListener('click', function() {
                printStockOpname();
            });
            
            document.getElementById('downloadStockOpnamePdfBtn').addEventListener('click', function() {
                downloadStockOpnamePdf();
            });
            
            // [BARU] Event listener untuk tombol cetak dan unduh riwayat stok
            document.getElementById('printStockHistoryBtn').addEventListener('click', function() {
                printStockHistory();
            });
            
            document.getElementById('downloadStockHistoryPdfBtn').addEventListener('click', function() {
                downloadStockHistoryPdf();
            });
            
            // Event listener untuk modal supplier
            document.getElementById('addSupplierBtn').addEventListener('click', function() {
                addSupplier();
            });
            
            document.getElementById('closeSupplierModalBtn').addEventListener('click', function() {
                closeModal('supplierModal');
            });
            
            // Event listener untuk modal retur
            document.getElementById('cancelReturnBtn').addEventListener('click', function() {
                closeModal('returnModal');
            });
            
            document.getElementById('processReturnBtn').addEventListener('click', function() {
                processReturn();
            });
            
            // Event listener untuk modal laporan
            document.getElementById('closeReportModalBtn').addEventListener('click', function() {
                closeModal('reportModal');
            });
            
            document.getElementById('printReportBtn').addEventListener('click', function() {
                printReport();
            });
            
            document.getElementById('exportReportBtn').addEventListener('click', function() {
                exportReport();
            });
            
            // Event listener untuk modal histori
            document.getElementById('closeHistoryModalBtn').addEventListener('click', function() {
                closeModal('historyModal');
            });
            
            document.getElementById('printHistoryBtn').addEventListener('click', function() {
                printHistory();
            });
            
            // Event listener untuk modal member
            document.getElementById('addMemberBtn').addEventListener('click', function() {
                addMember();
            });
            
            document.getElementById('closeMemberModalBtn').addEventListener('click', function() {
                closeModal('memberModal');
            });
            
            // Event listener untuk modal info toko
            document.getElementById('cancelStoreInfoBtn').addEventListener('click', function() {
                closeModal('storeInfoModal');
            });
            
            document.getElementById('saveStoreInfoBtn').addEventListener('click', function() {
                saveStoreInfo();
            });
            
            // Event listener untuk modal kontrol panel
            document.getElementById('closeControlPanelBtn').addEventListener('click', function() {
                closeModal('controlPanelModal');
            });
            
            document.getElementById('backupDataBtn').addEventListener('click', function() {
                toggleSection('backupRestoreSection');
            });
            
            document.getElementById('restoreDataBtn').addEventListener('click', function() {
                document.getElementById('restoreFile').click();
            });
            
            document.getElementById('resetDataBtn').addEventListener('click', function() {
                resetData();
            });
            
            document.getElementById('manageUsersBtn').addEventListener('click', function() {
                toggleSection('userManagementSection');
                renderUsers();
            });
            
            document.getElementById('printKtaBtn').addEventListener('click', function() {
                toggleSection('ktaSection');
                renderKtaMembers();
            });
            
            document.getElementById('systemInfoBtn').addEventListener('click', function() {
                toggleSection('systemInfoSection');
                updateSystemInfo();
            });
            
            document.getElementById('downloadBackupBtn').addEventListener('click', function() {
                downloadBackup();
            });
            
            document.getElementById('restoreFile').addEventListener('change', function(e) {
                restoreData(e.target.files[0]);
            });
            
            document.getElementById('addUserBtn').addEventListener('click', function() {
                addUser();
            });
            
            document.getElementById('ktaMemberSelect').addEventListener('change', function() {
                generateKtaCard(this.value);
            });
            
            document.getElementById('printKtaCardBtn').addEventListener('click', function() {
                printKtaCard();
            });
            
            // Event listener untuk modal pembayaran
            document.getElementById('cancelPaymentBtn').addEventListener('click', function() {
                closeModal('paymentModal');
            });
            
            document.getElementById('confirmPaymentBtn').addEventListener('click', function() {
                processPayment();
            });
            
            document.getElementById('amountPaid').addEventListener('input', function() {
                calculateChange();
            });
            
            // Event listener untuk tombol quick cash
            document.querySelectorAll('.quick-cash-buttons .btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const amount = parseInt(this.getAttribute('data-amount'));
                    document.getElementById('amountPaid').value = amount;
                    calculateChange();
                });
            });
            
            // Event listener untuk modal donasi
            document.getElementById('cancelDonationBtn').addEventListener('click', function() {
                closeModal('donationModal');
            });
            
            document.getElementById('confirmDonationBtn').addEventListener('click', function() {
                processDonation();
            });
            
            // Event listener untuk modal detail transaksi
            document.getElementById('closeTransactionDetailBtn').addEventListener('click', function() {
                closeModal('transactionDetailModal');
            });
            
            document.getElementById('printReceiptBtn').addEventListener('click', function() {
                printReceipt();
            });
            
            // Event listener untuk tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });
            
            // Event listener untuk filter periode
            document.getElementById('reportPeriod').addEventListener('change', function() {
                toggleCustomDateRange('customDateRange', this.value);
            });
            
            document.getElementById('historyFilter').addEventListener('change', function() {
                toggleCustomDateRange('historyCustomRange', this.value);
            });
            
            document.getElementById('stockHistoryFilter').addEventListener('change', function() {
                toggleCustomDateRange('stockHistoryCustomRange', this.value);
            });
            
            // [BARU] Event listener untuk modal laporan cerdas
            document.getElementById('smartReportPeriod').addEventListener('change', function() {
                toggleCustomDateRange('smartReportCustomRange', this.value);
            });
            
            document.getElementById('generateSmartReportBtn').addEventListener('click', function() {
                generateSmartReport();
            });
            
            document.getElementById('printSmartReportBtn').addEventListener('click', function() {
                printSmartReportPdf();
            });
            
            document.getElementById('exportSmartReportExcelBtn').addEventListener('click', function() {
                exportSmartReportExcel();
            });
            
            document.getElementById('closeSmartReportModalBtn').addEventListener('click', function() {
                closeModal('smartReportModal');
            });
            
            // Event listener untuk menutup modal dengan klik di luar
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeModal(this.id);
                    }
                });
            });
            
            // Event listener untuk tombol close modal
            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    closeModal(modal.id);
                });
            });
        }

        function handleLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const captchaInput = document.getElementById('captchaInput').value;
            
            // Validasi captcha
            if (captchaInput !== captchaText) {
                showToast('Kode verifikasi tidak sesuai', 'error');
                generateCaptcha();
                return;
            }
            
            // Cari user
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                // Update last login
                user.lastLogin = new Date().toISOString();
                saveDataToStorage();
                
                currentUser = user;
                
                // Sembunyikan modal login, tampilkan aplikasi utama
                document.getElementById('loginModal').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                
                // Tampilkan nama user yang login
                document.getElementById('loggedInUser').textContent = user.username;
                
                // Tampilkan/sembunyikan panel admin berdasarkan role
                if (user.role === 'admin') {
                    document.getElementById('adminPanel').style.display = 'block';
                }
                
                showToast(`Selamat datang, ${user.username}!`, 'success');
            } else {
                showToast('Username atau password salah', 'error');
                generateCaptcha();
            }
            
            // Reset form
            document.getElementById('loginForm').reset();
        }

        function handleLogout() {
            currentUser = null;
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginModal').style.display = 'flex';
            document.getElementById('adminPanel').style.display = 'none';
            clearOrder();
            showToast('Anda telah logout', 'info');
        }

        function openProductModal(productId = null) {
            const modal = document.getElementById('productModal');
            const title = document.getElementById('productModalTitle');
            const form = document.getElementById('productForm');
            
            if (productId) {
                // Edit mode
                title.textContent = 'Edit Produk';
                const product = products.find(p => p.id === productId);
                
                document.getElementById('productId').value = product.id;
                document.getElementById('productName').value = product.name;
                document.getElementById('productPrice').value = product.price;
                document.getElementById('productStock').value = product.stock;
                document.getElementById('productUnit').value = product.unit;
                document.getElementById('productBarcode').value = product.barcode || '';
                
                // Set kategori
                const categorySelect = document.getElementById('productCategory');
                categorySelect.innerHTML = '<option value="">Pilih Kategori</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    option.selected = category === product.category;
                    categorySelect.appendChild(option);
                });
                
                // Set supplier
                const supplierSelect = document.getElementById('productSupplier');
                supplierSelect.innerHTML = '<option value="">Pilih Supplier</option>';
                suppliers.forEach(supplier => {
                    const option = document.createElement('option');
                    option.value = supplier.name;
                    option.textContent = supplier.name;
                    option.selected = supplier.name === product.supplier;
                    supplierSelect.appendChild(option);
                });
            } else {
                // Tambah mode
                title.textContent = 'Tambah Produk';
                form.reset();
                
                // Isi opsi kategori
                const categorySelect = document.getElementById('productCategory');
                categorySelect.innerHTML = '<option value="">Pilih Kategori</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categorySelect.appendChild(option);
                });
                
                // Isi opsi supplier
                const supplierSelect = document.getElementById('productSupplier');
                supplierSelect.innerHTML = '<option value="">Pilih Supplier</option>';
                suppliers.forEach(supplier => {
                    const option = document.createElement('option');
                    option.value = supplier.name;
                    option.textContent = supplier.name;
                    supplierSelect.appendChild(option);
                });
            }
            
            modal.style.display = 'flex';
        }

        function editProduct(productId) {
            openProductModal(productId);
        }

        function deleteProduct(productId) {
            if (confirm('Apakah Anda yakin ingin menghapus produk ini?')) {
                products = products.filter(p => p.id !== productId);
                saveDataToStorage();
                renderProducts();
                updateProductCount();
                showToast('Produk berhasil dihapus', 'success');
            }
        }

        function saveProduct() {
            const productId = document.getElementById('productId').value;
            const name = document.getElementById('productName').value;
            const category = document.getElementById('productCategory').value;
            const price = parseInt(document.getElementById('productPrice').value);
            const stock = parseInt(document.getElementById('productStock').value);
            const unit = document.getElementById('productUnit').value;
            const barcode = document.getElementById('productBarcode').value;
            const supplier = document.getElementById('productSupplier').value;
            
            if (!name || !category || !price || !stock || !unit) {
                showToast('Harap isi semua field yang wajib diisi', 'error');
                return;
            }
            
            if (productId) {
                // Edit produk yang sudah ada
                const index = products.findIndex(p => p.id === parseInt(productId));
                if (index !== -1) {
                    products[index] = {
                        ...products[index],
                        name,
                        category,
                        price,
                        stock,
                        unit,
                        barcode,
                        supplier
                    };
                    showToast('Produk berhasil diperbarui', 'success');
                }
            } else {
                // Tambah produk baru
                const newId = products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 1;
                products.push({
                    id: newId,
                    name,
                    category,
                    price,
                    stock,
                    unit,
                    barcode,
                    supplier
                });
                showToast('Produk berhasil ditambahkan', 'success');
            }
            
            saveDataToStorage();
            renderProducts();
            updateProductCount();
            closeModal('productModal');
        }

        function openCategoryModal() {
            renderCategories();
            // [BARU] Render jenis satuan juga
            renderUnitTypes();
            openModal('categoryModal');
        }

        function addCategory() {
            const nameInput = document.getElementById('newCategoryName');
            const name = nameInput.value.trim();
            
            if (!name) {
                showToast('Harap masukkan nama kategori', 'error');
                return;
            }
            
            if (categories.includes(name)) {
                showToast('Kategori sudah ada', 'error');
                return;
            }
            
            categories.push(name);
            saveDataToStorage();
            renderCategories();
            renderCategoryFilters();
            nameInput.value = '';
            showToast('Kategori berhasil ditambahkan', 'success');
        }

        function editCategory(index) {
            const newName = prompt('Edit nama kategori:', categories[index]);
            if (newName && newName.trim() !== '') {
                categories[index] = newName.trim();
                saveDataToStorage();
                renderCategories();
                renderCategoryFilters();
                showToast('Kategori berhasil diperbarui', 'success');
            }
        }

        function deleteCategory(index) {
            if (confirm('Apakah Anda yakin ingin menghapus kategori ini? Produk dalam kategori ini akan dikategorikan sebagai "Lainnya".')) {
                const categoryName = categories[index];
                
                // Update produk yang menggunakan kategori ini
                products.forEach(product => {
                    if (product.category === categoryName) {
                        product.category = 'Lainnya';
                    }
                });
                
                categories.splice(index, 1);
                saveDataToStorage();
                renderCategories();
                renderCategoryFilters();
                renderProducts();
                showToast('Kategori berhasil dihapus', 'success');
            }
        }

        // [BARU] Fungsi untuk menambahkan jenis satuan
        function addUnitType() {
            const unitInput = document.getElementById('newUnitType');
            const unit = unitInput.value.trim().toLowerCase();
            
            if (!unit) {
                showToast('Harap masukkan jenis satuan', 'error');
                return;
            }
            
            if (unitTypes.includes(unit)) {
                showToast('Jenis satuan sudah ada', 'error');
                return;
            }
            
            unitTypes.push(unit);
            saveDataToStorage();
            renderUnitTypes();
            unitInput.value = '';
            showToast('Jenis satuan berhasil ditambahkan', 'success');
        }

        // [BARU] Fungsi untuk menghapus jenis satuan
        function deleteUnitType(index) {
            if (confirm('Apakah Anda yakin ingin menghapus jenis satuan ini? Produk yang menggunakan satuan ini tidak akan terpengaruh.')) {
                unitTypes.splice(index, 1);
                saveDataToStorage();
                renderUnitTypes();
                showToast('Jenis satuan berhasil dihapus', 'success');
            }
        }

        function openStockModal() {
            openModal('stockModal');
            // Default ke tab penyesuaian stok
            switchTab('stockAdjustment');
            renderStockAdjustmentTable();
        }

        function renderStockAdjustmentTable() {
            const tableBody = document.getElementById('stockAdjustmentTable');
            tableBody.innerHTML = '';
            
            products.forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.name}</td>
                    <td>${product.stock} ${product.unit}</td>
                    <td>
                        <input type="number" id="adjust-${product.id}" class="form-control" placeholder="Jumlah penyesuaian">
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary adjust-stock-btn" data-id="${product.id}" data-action="add">Tambah</button>
                        <button class="btn btn-sm btn-danger adjust-stock-btn" data-id="${product.id}" data-action="subtract">Kurangi</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Event listener untuk tombol penyesuaian stok
            document.querySelectorAll('.adjust-stock-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const productId = parseInt(this.getAttribute('data-id'));
                    const action = this.getAttribute('data-action');
                    const input = document.getElementById(`adjust-${productId}`);
                    const amount = parseInt(input.value) || 0;
                    
                    if (amount <= 0) {
                        showToast('Masukkan jumlah yang valid', 'error');
                        return;
                    }
                    
                    adjustStock(productId, action, amount);
                    input.value = '';
                });
            });
        }

        function adjustStock(productId, action, amount) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            const oldStock = product.stock;
            let newStock;
            
            if (action === 'add') {
                newStock = oldStock + amount;
                product.stock = newStock;
                
                // Tambahkan ke riwayat stok
                stockHistory.push({
                    date: new Date().toISOString(),
                    productId: productId,
                    productName: product.name,
                    change: amount,
                    newStock: newStock,
                    type: 'penambahan',
                    user: currentUser.username
                });
                
                showToast(`Stok ${product.name} ditambah ${amount} ${product.unit}`, 'success');
            } else {
                if (amount > oldStock) {
                    showToast('Jumlah pengurangan melebihi stok yang tersedia', 'error');
                    return;
                }
                
                newStock = oldStock - amount;
                product.stock = newStock;
                
                // Tambahkan ke riwayat stok
                stockHistory.push({
                    date: new Date().toISOString(),
                    productId: productId,
                    productName: product.name,
                    change: -amount,
                    newStock: newStock,
                    type: 'pengurangan',
                    user: currentUser.username
                });
                
                showToast(`Stok ${product.name} dikurangi ${amount} ${product.unit}`, 'success');
            }
            
            saveDataToStorage();
            renderProducts();
            renderStockAdjustmentTable();
        }

        // [BARU] Fungsi untuk mencetak laporan stok opname
        function printStockOpname() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Judul laporan
            doc.setFontSize(16);
            doc.text('LAPORAN STOK OPNAME', 105, 15, { align: 'center' });
            doc.setFontSize(10);
            doc.text(`Tanggal: ${new Date().toLocaleDateString('id-ID')}`, 105, 22, { align: 'center' });
            doc.text(`Toko: ${storeInfo.name}`, 105, 28, { align: 'center' });
            
            // Data untuk tabel
            const tableData = [];
            products.forEach(product => {
                tableData.push([
                    product.name,
                    `${product.stock} ${product.unit}`,
                    '', // Stok fisik (kosong karena perlu diisi manual)
                    '', // Selisih
                    ''  // Keterangan
                ]);
            });
            
            // Buat tabel
            doc.autoTable({
                head: [['Produk', 'Stok Sistem', 'Stok Fisik', 'Selisih', 'Keterangan']],
                body: tableData,
                startY: 35,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [0, 123, 255] }
            });
            
            // Simpan PDF
            doc.save(`stok-opname-${new Date().toISOString().split('T')[0]}.pdf`);
            showToast('Laporan stok opname berhasil diunduh', 'success');
        }

        // [BARU] Fungsi untuk mengunduh PDF stok opname
        function downloadStockOpnamePdf() {
            printStockOpname(); // Sama dengan fungsi cetak untuk sekarang
        }

        // [BARU] Fungsi untuk mencetak riwayat stok
        function printStockHistory() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Judul laporan
            doc.setFontSize(16);
            doc.text('LAPORAN RIWAYAT PERUBAHAN STOK', 105, 15, { align: 'center' });
            doc.setFontSize(10);
            doc.text(`Periode: ${getFilterPeriodText('stockHistoryFilter')}`, 105, 22, { align: 'center' });
            doc.text(`Toko: ${storeInfo.name}`, 105, 28, { align: 'center' });
            
            // Filter data berdasarkan periode
            const filteredHistory = filterDataByPeriod(stockHistory, 'stockHistoryFilter', 'stockHistoryStartDate', 'stockHistoryEndDate');
            
            // Data untuk tabel
            const tableData = filteredHistory.map(record => [
                new Date(record.date).toLocaleDateString('id-ID'),
                record.productName,
                record.change > 0 ? `+${record.change}` : record.change,
                `${record.newStock} ${products.find(p => p.id === record.productId)?.unit || ''}`,
                record.type,
                record.user
            ]);
            
            // Buat tabel
            doc.autoTable({
                head: [['Tanggal', 'Produk', 'Perubahan', 'Stok Akhir', 'Tipe', 'User']],
                body: tableData,
                startY: 35,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [0, 123, 255] }
            });
            
            // Simpan PDF
            doc.save(`riwayat-stok-${new Date().toISOString().split('T')[0]}.pdf`);
            showToast('Laporan riwayat stok berhasil diunduh', 'success');
        }

        // [BARU] Fungsi untuk mengunduh PDF riwayat stok
        function downloadStockHistoryPdf() {
            printStockHistory(); // Sama dengan fungsi cetak untuk sekarang
        }

        function openSupplierModal() {
            renderSuppliers();
            openModal('supplierModal');
        }

        function renderSuppliers() {
            const tableBody = document.getElementById('supplierTableBody');
            tableBody.innerHTML = '';
            
            suppliers.forEach((supplier, index) => {
                const productCount = products.filter(p => p.supplier === supplier.name).length;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${supplier.name}</td>
                    <td>${supplier.contact}</td>
                    <td>${productCount} produk</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary edit-supplier-btn" data-index="${index}">Edit</button>
                        <button class="btn btn-sm btn-danger delete-supplier-btn" data-index="${index}">Hapus</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Event listener untuk edit dan hapus supplier
            document.querySelectorAll('.edit-supplier-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    editSupplier(index);
                });
            });
            
            document.querySelectorAll('.delete-supplier-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    deleteSupplier(index);
                });
            });
        }

        function addSupplier() {
            const nameInput = document.getElementById('newSupplierName');
            const contactInput = document.getElementById('newSupplierContact');
            const name = nameInput.value.trim();
            const contact = contactInput.value.trim();
            
            if (!name || !contact) {
                showToast('Harap isi nama dan kontak supplier', 'error');
                return;
            }
            
            const newId = suppliers.length > 0 ? Math.max(...suppliers.map(s => s.id)) + 1 : 1;
            suppliers.push({
                id: newId,
                name,
                contact
            });
            
            saveDataToStorage();
            renderSuppliers();
            nameInput.value = '';
            contactInput.value = '';
            showToast('Supplier berhasil ditambahkan', 'success');
        }

        function editSupplier(index) {
            const newName = prompt('Edit nama supplier:', suppliers[index].name);
            const newContact = prompt('Edit kontak supplier:', suppliers[index].contact);
            
            if (newName && newContact) {
                suppliers[index].name = newName.trim();
                suppliers[index].contact = newContact.trim();
                saveDataToStorage();
                renderSuppliers();
                showToast('Supplier berhasil diperbarui', 'success');
            }
        }

        function deleteSupplier(index) {
            if (confirm('Apakah Anda yakin ingin menghapus supplier ini? Produk yang terkait dengan supplier ini akan dihapus informasi supplier-nya.')) {
                const supplierName = suppliers[index].name;
                
                // Hapus supplier dari produk yang terkait
                products.forEach(product => {
                    if (product.supplier === supplierName) {
                        product.supplier = '';
                    }
                });
                
                suppliers.splice(index, 1);
                saveDataToStorage();
                renderSuppliers();
                showToast('Supplier berhasil dihapus', 'success');
            }
        }

        function openReturnModal() {
            openModal('returnModal');
        }

        function processReturn() {
            // Implementasi proses retur
            showToast('Fitur retur dalam pengembangan', 'info');
            closeModal('returnModal');
        }

        function openReportModal() {
            openModal('reportModal');
            generateReport();
        }

        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const period = document.getElementById('reportPeriod').value;
            
            // Filter transaksi berdasarkan periode
            let filteredTransactions = filterDataByPeriod(transactions, 'reportPeriod', 'startDate', 'endDate');
            
            // Summary laporan
            const summaryGrid = document.getElementById('reportSummary');
            summaryGrid.innerHTML = '';
            
            if (reportType === 'sales') {
                // Laporan penjualan
                const totalSales = filteredTransactions.reduce((sum, t) => sum + t.total, 0);
                const totalTransactions = filteredTransactions.length;
                const avgTransaction = totalTransactions > 0 ? totalSales / totalTransactions : 0;
                
                summaryGrid.innerHTML = `
                    <div class="report-summary-item">
                        <h4>Total Penjualan</h4>
                        <p>Rp ${formatNumber(totalSales)}</p>
                    </div>
                    <div class="report-summary-item">
                        <h4>Jumlah Transaksi</h4>
                        <p>${totalTransactions}</p>
                    </div>
                    <div class="report-summary-item">
                        <h4>Rata-rata Transaksi</h4>
                        <p>Rp ${formatNumber(avgTransaction)}</p>
                    </div>
                `;
                
                // Tabel laporan penjualan
                const reportTable = document.getElementById('reportTable');
                reportTable.innerHTML = `
                    <thead>
                        <tr>
                            <th>Tanggal</th>
                            <th>ID Transaksi</th>
                            <th>Items</th>
                            <th>Total</th>
                            <th>Kasir</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredTransactions.map(t => `
                            <tr>
                                <td>${new Date(t.date).toLocaleDateString('id-ID')}</td>
                                <td>${t.id}</td>
                                <td>${t.items.length} item</td>
                                <td>Rp ${formatNumber(t.total)}</td>
                                <td>${t.cashier}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                `;
            } else if (reportType === 'products') {
                // Laporan produk terlaris
                const productSales = {};
                
                filteredTransactions.forEach(t => {
                    t.items.forEach(item => {
                        if (!productSales[item.product.id]) {
                            productSales[item.product.id] = {
                                name: item.product.name,
                                quantity: 0,
                                revenue: 0
                            };
                        }
                        productSales[item.product.id].quantity += item.quantity;
                        productSales[item.product.id].revenue += item.product.price * item.quantity;
                    });
                });
                
                const sortedProducts = Object.values(productSales).sort((a, b) => b.quantity - a.quantity);
                
                summaryGrid.innerHTML = `
                    <div class="report-summary-item">
                        <h4>Produk Terlaris</h4>
                        <p>${sortedProducts.length > 0 ? sortedProducts[0].name : '-'}</p>
                    </div>
                    <div class="report-summary-item">
                        <h4>Total Produk Terjual</h4>
                        <p>${sortedProducts.reduce((sum, p) => sum + p.quantity, 0)}</p>
                    </div>
                    <div class="report-summary-item">
                        <h4>Pendapatan Produk</h4>
                        <p>Rp ${formatNumber(sortedProducts.reduce((sum, p) => sum + p.revenue, 0))}</p>
                    </div>
                `;
                
                // Tabel laporan produk
                const reportTable = document.getElementById('reportTable');
                reportTable.innerHTML = `
                    <thead>
                        <tr>
                            <th>Produk</th>
                            <th>Terjual</th>
                            <th>Pendapatan</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sortedProducts.map(p => `
                            <tr>
                                <td>${p.name}</td>
                                <td>${p.quantity}</td>
                                <td>Rp ${formatNumber(p.revenue)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                `;
            } else if (reportType === 'donations') {
                // Laporan donasi
                const donations = filteredTransactions.filter(t => t.type === 'donation');
                const totalDonations = donations.reduce((sum, d) => sum + d.total, 0);
                
                summaryGrid.innerHTML = `
                    <div class="report-summary-item">
                        <h4>Total Donasi</h4>
                        <p>Rp ${formatNumber(totalDonations)}</p>
                    </div>
                    <div class="report-summary-item">
                        <h4>Jumlah Donasi</h4>
                        <p>${donations.length}</p>
                    </div>
                    <div class="report-summary-item">
                        <h4>Rata-rata Donasi</h4>
                        <p>Rp ${formatNumber(donations.length > 0 ? totalDonations / donations.length : 0)}</p>
                    </div>
                `;
                
                // Tabel laporan donasi
                const reportTable = document.getElementById('reportTable');
                reportTable.innerHTML = `
                    <thead>
                        <tr>
                            <th>Tanggal</th>
                            <th>Jumlah</th>
                            <th>Catatan</th>
                            <th>Kasir</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${donations.map(d => `
                            <tr>
                                <td>${new Date(d.date).toLocaleDateString('id-ID')}</td>
                                <td>Rp ${formatNumber(d.total)}</td>
                                <td>${d.note || '-'}</td>
                                <td>${d.cashier}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                `;
            }
        }

        function printReport() {
            // Implementasi cetak laporan
            showToast('Fitur cetak laporan dalam pengembangan', 'info');
        }

        function exportReport() {
            // Implementasi export laporan
            showToast('Fitur export laporan dalam pengembangan', 'info');
        }

        function openHistoryModal() {
            openModal('historyModal');
            renderHistoryTable();
        }

        function renderHistoryTable() {
            const tableBody = document.getElementById('historyTableBody');
            const searchTerm = document.getElementById('historySearch').value.toLowerCase();
            const period = document.getElementById('historyFilter').value;
            
            // Filter transaksi berdasarkan periode dan pencarian
            let filteredTransactions = filterDataByPeriod(transactions, 'historyFilter', 'historyStartDate', 'historyEndDate');
            
            if (searchTerm) {
                filteredTransactions = filteredTransactions.filter(t => 
                    t.id.toLowerCase().includes(searchTerm) ||
                    t.items.some(item => item.product.name.toLowerCase().includes(searchTerm))
                );
            }
            
            tableBody.innerHTML = '';
            
            if (filteredTransactions.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Tidak ada transaksi</td></tr>';
                return;
            }
            
            filteredTransactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(transaction.date).toLocaleDateString('id-ID')}</td>
                    <td>${transaction.id}</td>
                    <td>${transaction.items.length} item</td>
                    <td>Rp ${formatNumber(transaction.total)}</td>
                    <td>${transaction.cashier}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary view-transaction-btn" data-id="${transaction.id}">Lihat</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Event listener untuk tombol lihat transaksi
            document.querySelectorAll('.view-transaction-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const transactionId = this.getAttribute('data-id');
                    viewTransactionDetail(transactionId);
                });
            });
        }

        function viewTransactionDetail(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) return;
            
            const content = document.getElementById('transactionDetailContent');
            content.innerHTML = `
                <div class="receipt-header">
                    <div class="receipt-title">${storeInfo.name}</div>
                    <div>${storeInfo.address}</div>
                    <div>${storeInfo.phone}</div>
                </div>
                <div class="receipt-info">
                    <div><span>ID Transaksi:</span> <span>${transaction.id}</span></div>
                    <div><span>Tanggal:</span> <span>${new Date(transaction.date).toLocaleString('id-ID')}</span></div>
                    <div><span>Kasir:</span> <span>${transaction.cashier}</span></div>
                </div>
                <div id="receiptItemsContainer">
                    ${transaction.items.map(item => `
                        <div class="receipt-item">
                            <div class="receipt-item-details">
                                <div class="item-name">${item.product.name}</div>
                                <div class="item-price-calc">${item.quantity} x Rp ${formatNumber(item.product.price)}</div>
                            </div>
                            <div>Rp ${formatNumber(item.quantity * item.product.price)}</div>
                        </div>
                    `).join('')}
                </div>
                <div class="receipt-info">
                    <div><span>Subtotal:</span> <span>Rp ${formatNumber(transaction.subtotal)}</span></div>
                    <div><span>Pajak (${storeInfo.tax}%):</span> <span>Rp ${formatNumber(transaction.tax)}</span></div>
                    <div class="receipt-total"><span>TOTAL:</span> <span>Rp ${formatNumber(transaction.total)}</span></div>
                    <div><span>Bayar:</span> <span>Rp ${formatNumber(transaction.amountPaid)}</span></div>
                    <div><span>Kembali:</span> <span>Rp ${formatNumber(transaction.change)}</span></div>
                </div>
                <div class="receipt-footer">
                    ${storeInfo.receiptFooter}
                </div>
            `;
            
            // Simpan transactionId untuk cetak struk
            content.setAttribute('data-transaction-id', transactionId);
            
            closeModal('historyModal');
            openModal('transactionDetailModal');
        }

        function printHistory() {
            // Implementasi cetak histori
            showToast('Fitur cetak histori dalam pengembangan', 'info');
        }

        function openMemberModal() {
            renderMembers();
            openModal('memberModal');
        }

        function renderMembers() {
            const tableBody = document.getElementById('memberTableBody');
            tableBody.innerHTML = '';
            
            members.forEach((member, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${member.name}</td>
                    <td>${member.phone}</td>
                    <td>${member.address}</td>
                    <td>${member.points}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary edit-member-btn" data-index="${index}">Edit</button>
                        <button class="btn btn-sm btn-danger delete-member-btn" data-index="${index}">Hapus</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Event listener untuk edit dan hapus member
            document.querySelectorAll('.edit-member-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    editMember(index);
                });
            });
            
            document.querySelectorAll('.delete-member-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    deleteMember(index);
                });
            });
        }

        function addMember() {
            const nameInput = document.getElementById('newMemberName');
            const phoneInput = document.getElementById('newMemberPhone');
            const name = nameInput.value.trim();
            const phone = phoneInput.value.trim();
            
            if (!name || !phone) {
                showToast('Harap isi nama dan telepon member', 'error');
                return;
            }
            
            const newId = members.length > 0 ? Math.max(...members.map(m => m.id)) + 1 : 1;
            members.push({
                id: newId,
                name,
                phone,
                address: '',
                points: 0
            });
            
            saveDataToStorage();
            renderMembers();
            nameInput.value = '';
            phoneInput.value = '';
            showToast('Member berhasil ditambahkan', 'success');
        }

        function editMember(index) {
            const member = members[index];
            const newName = prompt('Edit nama member:', member.name);
            const newPhone = prompt('Edit telepon member:', member.phone);
            const newAddress = prompt('Edit alamat member:', member.address);
            
            if (newName && newPhone) {
                members[index].name = newName.trim();
                members[index].phone = newPhone.trim();
                members[index].address = newAddress.trim();
                saveDataToStorage();
                renderMembers();
                showToast('Member berhasil diperbarui', 'success');
            }
        }

        function deleteMember(index) {
            if (confirm('Apakah Anda yakin ingin menghapus member ini?')) {
                members.splice(index, 1);
                saveDataToStorage();
                renderMembers();
                showToast('Member berhasil dihapus', 'success');
            }
        }

        function selectMember(member) {
            selectedMember = member;
            showToast(`Member ${member.name} dipilih`, 'success');
        }

        function openStoreInfoModal() {
            const form = document.getElementById('storeInfoForm');
            form.storeName.value = storeInfo.name;
            form.storeAddress.value = storeInfo.address;
            form.storePhone.value = storeInfo.phone;
            form.storeTax.value = storeInfo.tax;
            form.receiptFooter.value = storeInfo.receiptFooter;
            
            openModal('storeInfoModal');
        }

        function saveStoreInfo() {
            const form = document.getElementById('storeInfoForm');
            storeInfo = {
                name: form.storeName.value,
                address: form.storeAddress.value,
                phone: form.storePhone.value,
                tax: parseFloat(form.storeTax.value) || 0,
                receiptFooter: form.receiptFooter.value
            };
            
            saveDataToStorage();
            document.getElementById('storeNameHeader').textContent = storeInfo.name;
            showToast('Informasi toko berhasil disimpan', 'success');
            closeModal('storeInfoModal');
        }

        function openControlPanelModal() {
            openModal('controlPanelModal');
            // Sembunyikan semua section terlebih dahulu
            document.querySelectorAll('#controlPanelModal .modal-body > div:not(.admin-grid)').forEach(section => {
                section.style.display = 'none';
            });
        }

        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const isVisible = section.style.display !== 'none';
            
            // Sembunyikan semua section terlebih dahulu
            document.querySelectorAll('#controlPanelModal .modal-body > div:not(.admin-grid)').forEach(s => {
                s.style.display = 'none';
            });
            
            // Tampilkan section yang dipilih jika sebelumnya tidak terlihat
            if (!isVisible) {
                section.style.display = 'block';
            }
        }

        function renderUsers() {
            const tableBody = document.getElementById('userTableBody');
            tableBody.innerHTML = '';
            
            users.forEach((user, index) => {
                // Jangan tampilkan user yang sedang login
                if (user.username === currentUser.username) return;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.username}</td>
                    <td>${user.role}</td>
                    <td>${user.lastLogin ? new Date(user.lastLogin).toLocaleDateString('id-ID') : '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-danger delete-user-btn" data-index="${index}">Hapus</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Event listener untuk hapus user
            document.querySelectorAll('.delete-user-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    deleteUser(index);
                });
            });
        }

        function addUser() {
            const usernameInput = document.getElementById('newUsername');
            const passwordInput = document.getElementById('newPassword');
            const roleSelect = document.getElementById('newUserRole');
            
            const username = usernameInput.value.trim();
            const password = passwordInput.value;
            const role = roleSelect.value;
            
            if (!username || !password) {
                showToast('Harap isi username dan password', 'error');
                return;
            }
            
            if (users.find(u => u.username === username)) {
                showToast('Username sudah ada', 'error');
                return;
            }
            
            users.push({
                username,
                password,
                role,
                lastLogin: null
            });
            
            saveDataToStorage();
            renderUsers();
            usernameInput.value = '';
            passwordInput.value = '';
            showToast('User berhasil ditambahkan', 'success');
        }

        function deleteUser(index) {
            if (confirm('Apakah Anda yakin ingin menghapus user ini?')) {
                users.splice(index, 1);
                saveDataToStorage();
                renderUsers();
                showToast('User berhasil dihapus', 'success');
            }
        }

        function renderKtaMembers() {
            const select = document.getElementById('ktaMemberSelect');
            select.innerHTML = '<option value="">Pilih Member</option>';
            
            members.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = `${member.name} (${member.phone})`;
                select.appendChild(option);
            });
        }

        function generateKtaCard(memberId) {
            const member = members.find(m => m.id === parseInt(memberId));
            if (!member) {
                document.getElementById('ktaCard').style.display = 'none';
                document.getElementById('printKtaCardBtn').style.display = 'none';
                return;
            }
            
            document.getElementById('ktaStoreName').textContent = storeInfo.name;
            document.getElementById('ktaStoreAddress').textContent = storeInfo.address;
            document.getElementById('ktaMemberName').textContent = member.name;
            document.getElementById('ktaMemberId').textContent = `ID: MEM-${member.id.toString().padStart(3, '0')}`;
            
            // Generate QR code sederhana (dalam implementasi nyata, gunakan library QR code)
            const qrCodeImg = document.getElementById('ktaQrCode');
            qrCodeImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=MEMBER-${member.id}`;
            
            document.getElementById('ktaCard').style.display = 'flex';
            document.getElementById('printKtaCardBtn').style.display = 'block';
        }

        function printKtaCard() {
            const printContainer = document.getElementById('print-container');
            const ktaCard = document.getElementById('ktaCard').cloneNode(true);
            
            printContainer.innerHTML = '';
            printContainer.appendChild(ktaCard);
            
            window.print();
        }

        function updateSystemInfo() {
            document.getElementById('systemProductCount').textContent = products.length;
            document.getElementById('systemTransactionCount').textContent = transactions.length;
            document.getElementById('systemMemberCount').textContent = members.length;
            document.getElementById('systemTotalSales').textContent = `Rp ${formatNumber(transactions.reduce((sum, t) => sum + t.total, 0))}`;
            document.getElementById('systemBrowser').textContent = navigator.userAgent;
            
            // Coba dapatkan lokasi
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        document.getElementById('systemLocation').textContent = `Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}`;
                    },
                    error => {
                        document.getElementById('systemLocation').textContent = 'Tidak dapat mengakses lokasi';
                    }
                );
            } else {
                document.getElementById('systemLocation').textContent = 'Geolocation tidak didukung';
            }
        }

        function downloadBackup() {
            const backupData = {
                products,
                categories,
                unitTypes, // [BARU] Sertakan jenis satuan dalam backup
                suppliers,
                members,
                users,
                transactions,
                stockHistory,
                storeInfo,
                backupDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup-supermarket-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Backup berhasil diunduh', 'success');
        }

        function restoreData(file) {
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    // Validasi data backup
                    if (!backupData.products || !backupData.categories) {
                        throw new Error('Format backup tidak valid');
                    }
                    
                    // Restore data
                    products = backupData.products || products;
                    categories = backupData.categories || categories;
                    unitTypes = backupData.unitTypes || unitTypes; // [BARU] Restore jenis satuan
                    suppliers = backupData.suppliers || suppliers;
                    members = backupData.members || members;
                    users = backupData.users || users;
                    transactions = backupData.transactions || transactions;
                    stockHistory = backupData.stockHistory || stockHistory;
                    storeInfo = backupData.storeInfo || storeInfo;
                    
                    saveDataToStorage();
                    initializeApp();
                    
                    showToast('Data berhasil dipulihkan', 'success');
                } catch (error) {
                    showToast('Gagal memulihkan data: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        function resetData() {
            if (confirm('PERINGATAN: Tindakan ini akan menghapus semua data. Apakah Anda yakin?')) {
                if (confirm('Semua data akan dihapus permanen. Lanjutkan?')) {
                    localStorage.clear();
                    initializeApp();
                    showToast('Semua data telah direset', 'success');
                }
            }
        }

        function openPaymentModal() {
            openModal('paymentModal');
            document.getElementById('amountPaid').value = '';
            document.getElementById('changeAmount').style.display = 'none';
            document.getElementById('confirmPaymentBtn').disabled = true;
        }

        function calculateChange() {
            const total = currentOrder.reduce((sum, item) => sum + (item.product.price * item.quantity), 0);
            const tax = total * (storeInfo.tax / 100);
            const grandTotal = total + tax;
            
            const amountPaid = parseFloat(document.getElementById('amountPaid').value) || 0;
            const change = amountPaid - grandTotal;
            
            const changeAmount = document.getElementById('changeAmount');
            const changeValue = document.getElementById('changeValue');
            const confirmBtn = document.getElementById('confirmPaymentBtn');
            
            if (amountPaid > 0) {
                changeAmount.style.display = 'block';
                changeValue.textContent = `Rp ${formatNumber(change)}`;
                
                if (amountPaid >= grandTotal) {
                    changeValue.style.color = 'var(--success)';
                    confirmBtn.disabled = false;
                } else {
                    changeValue.style.color = 'var(--danger)';
                    confirmBtn.disabled = true;
                }
            } else {
                changeAmount.style.display = 'none';
                confirmBtn.disabled = true;
            }
        }

        function processPayment() {
            const total = currentOrder.reduce((sum, item) => sum + (item.product.price * item.quantity), 0);
            const tax = total * (storeInfo.tax / 100);
            const grandTotal = total + tax;
            const amountPaid = parseFloat(document.getElementById('amountPaid').value);
            const change = amountPaid - grandTotal;
            const paymentMethod = document.getElementById('paymentMethod').value;
            
            if (amountPaid < grandTotal) {
                showToast('Jumlah pembayaran kurang', 'error');
                return;
            }
            
            // Kurangi stok produk
            currentOrder.forEach(item => {
                const product = products.find(p => p.id === item.product.id);
                if (product) {
                    product.stock -= item.quantity;
                    
                    // Tambahkan ke riwayat stok
                    stockHistory.push({
                        date: new Date().toISOString(),
                        productId: product.id,
                        productName: product.name,
                        change: -item.quantity,
                        newStock: product.stock,
                        type: 'penjualan',
                        user: currentUser.username
                    });
                }
            });
            
            // Buat transaksi
            const transactionId = 'T' + Date.now();
            const transaction = {
                id: transactionId,
                date: new Date().toISOString(),
                items: [...currentOrder],
                subtotal: total,
                tax: tax,
                total: grandTotal,
                amountPaid: amountPaid,
                change: change,
                paymentMethod: paymentMethod,
                cashier: currentUser.username,
                member: selectedMember,
                note: document.getElementById('orderNote').value
            };
            
            transactions.push(transaction);
            
            // Tambahkan poin untuk member jika ada
            if (selectedMember) {
                const pointsEarned = Math.floor(grandTotal / 10000); // 1 poin per Rp 10.000
                selectedMember.points += pointsEarned;
                showToast(`Member ${selectedMember.name} mendapatkan ${pointsEarned} poin`, 'success');
            }
            
            saveDataToStorage();
            
            // Tampilkan struk
            printReceipt(transaction);
            
            // Reset pesanan
            clearOrder();
            selectedMember = null;
            document.getElementById('memberSearch').value = '';
            
            showToast('Pembayaran berhasil', 'success');
            closeModal('paymentModal');
        }

        function openDonationModal() {
            openModal('donationModal');
        }

        function processDonation() {
            const amount = parseInt(document.getElementById('donationAmount').value);
            const note = document.getElementById('donationNote').value;
            
            if (!amount || amount < 1000) {
                showToast('Jumlah donasi minimal Rp 1.000', 'error');
                return;
            }
            
            // Buat transaksi donasi
            const transactionId = 'D' + Date.now();
            const transaction = {
                id: transactionId,
                date: new Date().toISOString(),
                type: 'donation',
                items: [],
                subtotal: amount,
                tax: 0,
                total: amount,
                amountPaid: amount,
                change: 0,
                paymentMethod: 'cash',
                cashier: currentUser.username,
                note: note
            };
            
            transactions.push(transaction);
            saveDataToStorage();
            
            showToast(`Donasi sebesar Rp ${formatNumber(amount)} berhasil`, 'success');
            closeModal('donationModal');
        }

        function clearOrder() {
            currentOrder = [];
            renderOrderItems();
            updateOrderSummary();
            document.getElementById('orderNote').value = '';
        }

        function printReceipt(transaction = null) {
            // Jika transaction tidak diberikan, gunakan transaction dari modal detail
            if (!transaction) {
                const content = document.getElementById('transactionDetailContent');
                const transactionId = content.getAttribute('data-transaction-id');
                transaction = transactions.find(t => t.id === transactionId);
            }
            
            if (!transaction) return;
            
            const printContainer = document.getElementById('print-container');
            printContainer.innerHTML = `
                <div id="receiptContent">
                    <div class="receipt-header">
                        <div class="receipt-title">${storeInfo.name}</div>
                        <div>${storeInfo.address}</div>
                        <div>${storeInfo.phone}</div>
                    </div>
                    <div class="receipt-info">
                        <div><span>ID Transaksi:</span> <span>${transaction.id}</span></div>
                        <div><span>Tanggal:</span> <span>${new Date(transaction.date).toLocaleString('id-ID')}</span></div>
                        <div><span>Kasir:</span> <span>${transaction.cashier}</span></div>
                    </div>
                    <div id="receiptItemsContainer">
                        ${transaction.items.map(item => `
                            <div class="receipt-item">
                                <div class="receipt-item-details">
                                    <div class="item-name">${item.product.name}</div>
                                    <div class="item-price-calc">${item.quantity} x Rp ${formatNumber(item.product.price)}</div>
                                </div>
                                <div>Rp ${formatNumber(item.quantity * item.product.price)}</div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="receipt-info">
                        <div><span>Subtotal:</span> <span>Rp ${formatNumber(transaction.subtotal)}</span></div>
                        <div><span>Pajak (${storeInfo.tax}%):</span> <span>Rp ${formatNumber(transaction.tax)}</span></div>
                        <div class="receipt-total"><span>TOTAL:</span> <span>Rp ${formatNumber(transaction.total)}</span></div>
                        <div><span>Bayar:</span> <span>Rp ${formatNumber(transaction.amountPaid)}</span></div>
                        <div><span>Kembali:</span> <span>Rp ${formatNumber(transaction.change)}</span></div>
                    </div>
                    <div class="receipt-footer">
                        ${storeInfo.receiptFooter}
                    </div>
                </div>
            `;
            
            window.print();
        }

        function switchTab(tabName) {
            // Nonaktifkan semua tab
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Aktifkan tab yang dipilih
            document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            // Load data sesuai tab
            if (tabName === 'stockOpname') {
                renderStockOpnameTable();
            } else if (tabName === 'stockHistory') {
                renderStockHistoryTable();
            }
        }

        function renderStockOpnameTable() {
            const tableBody = document.getElementById('stockOpnameTable');
            tableBody.innerHTML = '';
            
            products.forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.name}</td>
                    <td>${product.stock} ${product.unit}</td>
                    <td><input type="number" class="form-control" value="${product.stock}" min="0"></td>
                    <td>0</td>
                    <td><input type="text" class="form-control" placeholder="Keterangan"></td>
                `;
                tableBody.appendChild(row);
            });
        }

        function renderStockHistoryTable() {
            const tableBody = document.getElementById('stockHistoryTable');
            const period = document.getElementById('stockHistoryFilter').value;
            
            // Filter riwayat stok berdasarkan periode
            const filteredHistory = filterDataByPeriod(stockHistory, 'stockHistoryFilter', 'stockHistoryStartDate', 'stockHistoryEndDate');
            
            tableBody.innerHTML = '';
            
            if (filteredHistory.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Tidak ada riwayat stok</td></tr>';
                return;
            }
            
            filteredHistory.forEach(record => {
                const product = products.find(p => p.id === record.productId);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(record.date).toLocaleDateString('id-ID')}</td>
                    <td>${record.productName}</td>
                    <td>${record.change > 0 ? '+' : ''}${record.change} ${product ? product.unit : ''}</td>
                    <td>${record.newStock} ${product ? product.unit : ''}</td>
                    <td>${record.type}</td>
                    <td>${record.user}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function toggleCustomDateRange(containerId, periodValue) {
            const container = document.getElementById(containerId);
            container.style.display = periodValue === 'custom' ? 'block' : 'none';
        }

        function filterDataByPeriod(data, periodSelectId, startDateId, endDateId) {
            const period = document.getElementById(periodSelectId).value;
            const now = new Date();
            
            let startDate, endDate;
            
            switch (period) {
                case 'today':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
                    break;
                case 'yesterday':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
                    endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    break;
                case 'week':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay());
                    endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + (6 - now.getDay()) + 1);
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 1);
                    break;
                case 'year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = new Date(now.getFullYear() + 1, 0, 1);
                    break;
                case 'custom':
                    const startInput = document.getElementById(startDateId).value;
                    const endInput = document.getElementById(endDateId).value;
                    
                    if (!startInput || !endInput) {
                        return data;
                    }
                    
                    startDate = new Date(startInput);
                    endDate = new Date(endInput);
                    endDate.setDate(endDate.getDate() + 1); // Sampai akhir hari yang dipilih
                    break;
                default:
                    return data;
            }
            
            return data.filter(item => {
                const itemDate = new Date(item.date);
                return itemDate >= startDate && itemDate < endDate;
            });
        }

        function getFilterPeriodText(filterId) {
            const period = document.getElementById(filterId).value;
            const now = new Date();
            
            switch (period) {
                case 'today':
                    return `Hari Ini (${now.toLocaleDateString('id-ID')})`;
                case 'yesterday':
                    const yesterday = new Date(now);
                    yesterday.setDate(yesterday.getDate() - 1);
                    return `Kemarin (${yesterday.toLocaleDateString('id-ID')})`;
                case 'week':
                    return `Minggu Ini (${now.getDate() - now.getDay()} - ${now.getDate() + (6 - now.getDay())} ${now.toLocaleDateString('id-ID', {month: 'long'})})`;
                case 'month':
                    return `Bulan Ini (${now.toLocaleDateString('id-ID', {month: 'long', year: 'numeric'})})`;
                case 'year':
                    return `Tahun Ini (${now.getFullYear()})`;
                case 'custom':
                    const startInput = document.getElementById('smartReportStartDate').value;
                    const endInput = document.getElementById('smartReportEndDate').value;
                    if (startInput && endInput) {
                        return `${startInput} sampai ${endInput}`;
                    }
                    return 'Rentang Tanggal';
                default:
                    return 'Semua Periode';
            }
        }

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // [BARU] Fungsi untuk membuka modal Laporan Cerdas
        function openSmartReportModal() {
            openModal('smartReportModal');
            // Sembunyikan hasil laporan terlebih dahulu
            document.getElementById('smartReportSummary').style.display = 'none';
            document.getElementById('smartReportContent').style.display = 'none';
            document.getElementById('printSmartReportBtn').style.display = 'none';
            document.getElementById('exportSmartReportExcelBtn').style.display = 'none';
        }

        // [BARU] Fungsi untuk generate laporan cerdas
        function generateSmartReport() {
            const reportType = document.getElementById('smartReportType').value;
            const period = document.getElementById('smartReportPeriod').value;
            
            // Tampilkan section hasil laporan
            document.getElementById('smartReportSummary').style.display = 'block';
            document.getElementById('smartReportContent').style.display = 'block';
            document.getElementById('printSmartReportBtn').style.display = 'inline-block';
            document.getElementById('exportSmartReportExcelBtn').style.display = 'inline-block';
            
            // Filter data berdasarkan periode
            let filteredTransactions = filterDataByPeriod(transactions, 'smartReportPeriod', 'smartReportStartDate', 'smartReportEndDate');
            let filteredStockHistory = filterDataByPeriod(stockHistory, 'smartReportPeriod', 'smartReportStartDate', 'smartReportEndDate');
            
            const summaryGrid = document.getElementById('smartReportSummaryGrid');
            const reportTable = document.getElementById('smartReportTable');
            
            if (reportType === 'sales') {
                // Laporan Penjualan (Laba/Rugi)
                const totalSales = filteredTransactions.filter(t => t.type !== 'donation').reduce((sum, t) => sum + t.total, 0);
                const totalCost = calculateTotalCost(filteredTransactions);
                const profitLoss = totalSales - totalCost;
                const totalTransactions = filteredTransactions.filter(t => t.type !== 'donation').length;
                
                summaryGrid.innerHTML = `
                    <div class="report-summary-item">
                        <h4>Total Penjualan</h4>
                        <p>Rp ${formatNumber(totalSales)}</p>
                    </div>
                    <div class="report-summary-item">
                        <h4>Total Biaya</h4>
                        <p>Rp ${formatNumber(totalCost)}</p>
                    </div>
                    <div class="report-summary-item ${profitLoss >= 0 ? 'profit' : 'loss'}">
                        <h4>Laba/Rugi</h4>
                        <p>Rp ${formatNumber(profitLoss)}</p>
                    </div>
                    <div class="report-summary-item">
                        <h4>Jumlah Transaksi</h4>
                        <p>${totalTransactions}</p>
                    </div>
                `;
                
                // Tabel detail penjualan
                reportTable.innerHTML = `
                    <thead>
                        <tr>
                            <th>Tanggal</th>
                            <th>ID Transaksi</th>
                            <th>Produk</th>
                            <th>Qty</th>
                            <th>Harga Jual</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredTransactions.filter(t => t.type !== 'donation').map(t => 
                            t.items.map(item => `
                                <tr>
                                    <td>${new Date(t.date).toLocaleDateString('id-ID')}</td>
                                    <td>${t.id}</td>
                                    <td>${item.product.name}</td>
                                    <td>${item.quantity}</td>
                                    <td>Rp ${formatNumber(item.product.price)}</td>
                                    <td>Rp ${formatNumber(item.quantity * item.product.price)}</td>
                                </tr>
                            `).join('')
                        ).join('')}
                    </tbody>
                `;
                
            } else if (reportType === 'returns') {
                // Laporan Retur (dalam implementasi nyata, perlu data retur tersendiri)
                summaryGrid.innerHTML = `
                    <div class="report-summary-item">
                        <h4>Total Retur</h4>
                        <p>Rp 0</p>
                    </div>
                    <div class="report-summary-item">
                        <h4>Jumlah Retur</h4>
                        <p>0</p>
                    </div>
                `;
                
                reportTable.innerHTML = `
                    <thead>
                        <tr>
                            <th>Tanggal</th>
                            <th>ID Retur</th>
                            <th>Produk</th>
                            <th>Qty</th>
                            <th>Alasan</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="6" class="text-center">Data retur belum tersedia</td></tr>
                    </tbody>
                `;
                
            } else if (reportType === 'stock') {
                // Laporan Pasokan/Stok
                const totalStockAdditions = filteredStockHistory
                    .filter(r => r.change > 0)
                    .reduce((sum, r) => sum + r.change, 0);
                
                const totalStockValue = products.reduce((sum, p) => sum + (p.stock * (p.price * 0.7)), 0); // Asumsi harga beli 70% dari harga jual
                
                summaryGrid.innerHTML = `
                    <div class="report-summary-item">
                        <h4>Total Penambahan Stok</h4>
                        <p>${totalStockAdditions} unit</p>
                    </div>
                    <div class="report-summary-item">
                        <h4>Nilai Persediaan</h4>
                        <p>Rp ${formatNumber(totalStockValue)}</p>
                    </div>
                    <div class="report-summary-item">
                        <h4>Jumlah Produk</h4>
                        <p>${products.length}</p>
                    </div>
                `;
                
                // Tabel detail stok
                reportTable.innerHTML = `
                    <thead>
                        <tr>
                            <th>Produk</th>
                            <th>Stok</th>
                            <th>Harga Beli</th>
                            <th>Harga Jual</th>
                            <th>Nilai Persediaan</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${products.map(p => `
                            <tr>
                                <td>${p.name}</td>
                                <td>${p.stock} ${p.unit}</td>
                                <td>Rp ${formatNumber(p.price * 0.7)}</td>
                                <td>Rp ${formatNumber(p.price)}</td>
                                <td>Rp ${formatNumber(p.stock * (p.price * 0.7))}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                `;
                
            } else if (reportType === 'donations') {
                // Laporan Donasi
                const donations = filteredTransactions.filter(t => t.type === 'donation');
                const totalDonations = donations.reduce((sum, d) => sum + d.total, 0);
                
                summaryGrid.innerHTML = `
                    <div class="report-summary-item">
                        <h4>Total Donasi</h4>
                        <p>Rp ${formatNumber(totalDonations)}</p>
                    </div>
                    <div class="report-summary-item">
                        <h4>Jumlah Donasi</h4>
                        <p>${donations.length}</p>
                    </div>
                    <div class="report-summary-item">
                        <h4>Rata-rata Donasi</h4>
                        <p>Rp ${formatNumber(donations.length > 0 ? totalDonations / donations.length : 0)}</p>
                    </div>
                `;
                
                // Tabel detail donasi
                reportTable.innerHTML = `
                    <thead>
                        <tr>
                            <th>Tanggal</th>
                            <th>ID Donasi</th>
                            <th>Jumlah</th>
                            <th>Catatan</th>
                            <th>Kasir</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${donations.map(d => `
                            <tr>
                                <td>${new Date(d.date).toLocaleDateString('id-ID')}</td>
                                <td>${d.id}</td>
                                <td>Rp ${formatNumber(d.total)}</td>
                                <td>${d.note || '-'}</td>
                                <td>${d.cashier}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                `;
                
            } else if (reportType === 'members') {
                // Laporan Member
                const totalMembers = members.length;
                const totalPoints = members.reduce((sum, m) => sum + m.points, 0);
                const activeMembers = members.filter(m => m.points > 0).length;
                
                summaryGrid.innerHTML = `
                    <div class="report-summary-item">
                        <h4>Total Member</h4>
                        <p>${totalMembers}</p>
                    </div>
                    <div class="report-summary-item">
                        <h4>Member Aktif</h4>
                        <p>${activeMembers}</p>
                    </div>
                    <div class="report-summary-item">
                        <h4>Total Poin</h4>
                        <p>${totalPoints}</p>
                    </div>
                `;
                
                // Tabel detail member
                reportTable.innerHTML = `
                    <thead>
                        <tr>
                            <th>Nama</th>
                            <th>Telepon</th>
                            <th>Alamat</th>
                            <th>Poin</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${members.map(m => `
                            <tr>
                                <td>${m.name}</td>
                                <td>${m.phone}</td>
                                <td>${m.address}</td>
                                <td>${m.points}</td>
                                <td>${m.points > 0 ? 'Aktif' : 'Non-aktif'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                `;
            }
        }

        // [BARU] Fungsi untuk menghitung total biaya (asumsi harga beli 70% dari harga jual)
        function calculateTotalCost(transactions) {
            let totalCost = 0;
            transactions.forEach(t => {
                if (t.type !== 'donation') {
                    t.items.forEach(item => {
                        // Asumsi harga beli adalah 70% dari harga jual
                        const costPrice = item.product.price * 0.7;
                        totalCost += costPrice * item.quantity;
                    });
                }
            });
            return totalCost;
        }

        // [BARU] Fungsi untuk mencetak laporan cerdas dalam format PDF
        function printSmartReportPdf() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const reportType = document.getElementById('smartReportType').value;
            const reportTypeText = document.getElementById('smartReportType').options[document.getElementById('smartReportType').selectedIndex].text;
            
            // Judul laporan
            doc.setFontSize(16);
            doc.text('LAPORAN CERDAS - ' + reportTypeText.toUpperCase(), 105, 15, { align: 'center' });
            doc.setFontSize(10);
            doc.text(`Periode: ${getFilterPeriodText('smartReportPeriod')}`, 105, 22, { align: 'center' });
            doc.text(`Toko: ${storeInfo.name}`, 105, 28, { align: 'center' });
            doc.text(`Tanggal Cetak: ${new Date().toLocaleDateString('id-ID')}`, 105, 34, { align: 'center' });
            
            // Data untuk tabel
            const table = document.getElementById('smartReportTable');
            const headers = [];
            const rows = [];
            
            // Ambil header
            table.querySelectorAll('thead th').forEach(th => {
                headers.push(th.textContent);
            });
            
            // Ambil data rows
            table.querySelectorAll('tbody tr').forEach(tr => {
                const row = [];
                tr.querySelectorAll('td').forEach(td => {
                    row.push(td.textContent);
                });
                rows.push(row);
            });
            
            // Buat tabel
            doc.autoTable({
                head: [headers],
                body: rows,
                startY: 40,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [0, 123, 255] }
            });
            
            // Simpan PDF
            doc.save(`laporan-cerdas-${reportType}-${new Date().toISOString().split('T')[0]}.pdf`);
            showToast('Laporan cerdas berhasil diunduh (PDF)', 'success');
        }

        // [BARU] Fungsi untuk export laporan cerdas dalam format Excel
        function exportSmartReportExcel() {
            const reportType = document.getElementById('smartReportType').value;
            const reportTypeText = document.getElementById('smartReportType').options[document.getElementById('smartReportType').selectedIndex].text;
            
            // Data untuk Excel
            const data = [];
            const table = document.getElementById('smartReportTable');
            
            // Ambil header
            const headers = [];
            table.querySelectorAll('thead th').forEach(th => {
                headers.push(th.textContent);
            });
            data.push(headers);
            
            // Ambil data rows
            table.querySelectorAll('tbody tr').forEach(tr => {
                const row = [];
                tr.querySelectorAll('td').forEach(td => {
                    row.push(td.textContent);
                });
                data.push(row);
            });
            
            // Buat workbook
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // Tambahkan worksheet ke workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Laporan');
            
            // Simpan file
            XLSX.writeFile(wb, `laporan-cerdas-${reportType}-${new Date().toISOString().split('T')[0]}.xlsx`);
            showToast('Laporan cerdas berhasil diunduh (Excel)', 'success');
        }

        // Inisialisasi datepicker untuk filter custom
        document.addEventListener('DOMContentLoaded', function() {
            // Set nilai default untuk datepicker
            const today = new Date().toISOString().split('T')[0];
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            const oneWeekAgoStr = oneWeekAgo.toISOString().split('T')[0];
            
            document.getElementById('startDate').value = oneWeekAgoStr;
            document.getElementById('endDate').value = today;
            document.getElementById('historyStartDate').value = oneWeekAgoStr;
            document.getElementById('historyEndDate').value = today;
            document.getElementById('stockHistoryStartDate').value = oneWeekAgoStr;
            document.getElementById('stockHistoryEndDate').value = today;
            document.getElementById('smartReportStartDate').value = oneWeekAgoStr;
            document.getElementById('smartReportEndDate').value = today;
        });
    </script>
</body>
</html>
