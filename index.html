<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi UMKM Pro v4.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --accent-color: #4895ef;
            --dark-color: #1a1a2e;
            --body-bg: #f5f7fa;
            --content-bg: #ffffff;
            --text-color: #333;
            --text-muted: #6b7280;
            --border-color: #e5e7eb;
            --success-color: #10b981;
            --success-light: #d1fae5;
            --danger-color: #ef4444;
            --danger-light: #fee2e2;
            --warning-color: #f59e0b;
            --warning-light: #fef3c7;
            --info-color: #3b82f6;
            --info-light: #dbeafe;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --rounded: 0.5rem;
            --rounded-lg: 0.75rem;
            --transition: all 0.3s ease;
        }

        body.dark-mode {
            --dark-color: #ffffff;
            --body-bg: #111827;
            --content-bg: #1f2937;
            --text-color: #f9fafb;
            --text-muted: #9ca3af;
            --border-color: #374151;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: var(--body-bg); color: var(--text-color); line-height: 1.6; overflow-x: hidden; min-height: 100vh; transition: var(--transition); }

        /* --- Splash Screen --- */
        #splashScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; transition: opacity 1s ease-out; }
        .splash-logo { font-size: 5rem; color: white; margin-bottom: 2rem; animation: pulse 2s infinite, float 3s ease-in-out infinite; }
        .splash-title { font-size: 2.5rem; font-weight: 700; color: white; margin-bottom: 1rem; text-align: center; }
        .splash-subtitle { font-size: 1.2rem; color: rgba(255, 255, 255, 0.9); margin-bottom: 3rem; text-align: center; }
        .splash-credits { position: absolute; bottom: 2rem; color: rgba(255, 255, 255, 0.7); font-size: 0.9rem; text-align: center; line-height: 1.5; }
        .splash-credits strong { color: white; font-weight: 600; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-20px); } }

        /* --- Login --- */
        #loginModal { background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; }
        .login-container { max-width: 400px; width: 90%; background: var(--content-bg); border-radius: var(--rounded-lg); padding: 40px; box-shadow: var(--shadow-xl); position: relative; }
        .login-title { text-align: center; margin-bottom: 30px; color: var(--primary-color); font-size: 1.8rem; font-weight: 600; }
        .form-floating { position: relative; margin-bottom: 20px; }
        .form-floating input { width: 100%; padding: 15px; border: 1px solid var(--border-color); border-radius: var(--rounded); font-size: 1rem; background-color: var(--body-bg); color: var(--text-color); }
        .form-floating input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2); }
        .form-floating label { position: absolute; top: 15px; left: 15px; color: var(--text-muted); transition: var(--transition); pointer-events: none; background-color: var(--body-bg); padding: 0 5px; }
        .form-floating input:focus + label, .form-floating input:not(:placeholder-shown) + label { top: -10px; left: 10px; font-size: 0.8rem; color: var(--primary-color); }
        .captcha-box { padding: 10px 15px; background-color: var(--body-bg); border: 1px solid var(--border-color); border-radius: var(--rounded); font-size: 1.5rem; letter-spacing: 5px; text-decoration: line-through; color: var(--text-color); user-select: none; text-align: center; }

        /* --- Main App Layout --- */
        .app-layout { display: flex; min-height: 100vh; }
        #sidebar { width: 250px; background: var(--content-bg); padding: 20px; display: flex; flex-direction: column; transition: var(--transition); box-shadow: var(--shadow); }
        .sidebar-header { text-align: center; margin-bottom: 30px; }
        .sidebar-header .logo { font-size: 2rem; color: var(--primary-color); margin-bottom: 10px; }
        .sidebar-header h2 { font-size: 1.2rem; color: var(--text-color); }
        .sidebar-nav a { display: flex; align-items: center; gap: 15px; padding: 12px 15px; margin-bottom: 8px; border-radius: var(--rounded); color: var(--text-muted); text-decoration: none; transition: var(--transition); }
        .sidebar-nav a:hover, .sidebar-nav a.active { background-color: var(--primary-color); color: white; }
        .sidebar-nav a i { width: 20px; text-align: center; }
        .sidebar-footer { margin-top: auto; text-align: center; font-size: 0.8rem; color: var(--text-muted); }
        
        #main-content { flex: 1; padding: 30px; overflow-y: auto; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s ease; }
        .page-header { margin-bottom: 25px; }
        .page-header h1 { font-size: 2rem; font-weight: 600; color: var(--text-color); }
        
        /* --- General Components --- */
        .btn { padding: 12px 20px; background-color: var(--primary-color); color: white; border: none; border-radius: var(--rounded); cursor: pointer; font-size: 1rem; transition: var(--transition); font-weight: 500; display: inline-flex; align-items: center; gap: 8px; }
        .btn:hover { filter: brightness(1.1); transform: translateY(-2px); box-shadow: var(--shadow); }
        .btn-success { background-color: var(--success-color); }
        .btn-danger { background-color: var(--danger-color); }
        .btn-info { background-color: var(--info-color); }
        .btn-warning { background-color: var(--warning-color); }
        .btn-secondary { background-color: var(--text-muted); }
        .btn-sm { padding: 8px 12px; font-size: 0.85rem; }
        .card { background: var(--content-bg); padding: 25px; border-radius: var(--rounded-lg); box-shadow: var(--shadow-sm); margin-bottom: 20px; border: 1px solid var(--border-color); }
        .card-header { padding-bottom: 15px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-size: 1.2rem; font-weight: 600; color: var(--text-color); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-muted); }
        .form-control { width: 100%; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: var(--rounded); font-size: 1rem; background-color: var(--body-bg); color: var(--text-color); transition: var(--transition); }
        .form-control:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2); }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { background-color: var(--body-bg); font-weight: 600; }

        /* --- Modals, Toasts, Dialogs --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 1050; justify-content: center; align-items: center; animation: fadeIn 0.3s ease; }
        .modal-content { background-color: var(--content-bg); border-radius: var(--rounded-lg); width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow-xl); animation: modalFadeIn 0.3s; display: flex; flex-direction: column; }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 1.2rem; font-weight: 600; }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); }
        .modal-body { padding: 20px; flex-grow: 1; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 10px; }
        .toast { position: fixed; top: 20px; right: 20px; padding: 15px 20px; border-radius: var(--rounded); box-shadow: var(--shadow-xl); z-index: 1100; display: flex; align-items: center; transform: translateX(200%); transition: transform 0.3s ease; max-width: 350px; color: white; }
        .toast.show { transform: translateX(0); }
        .confirmation-dialog { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1200; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .confirmation-content { background-color: var(--content-bg); padding: 25px; border-radius: var(--rounded-lg); max-width: 400px; width: 90%; text-align: center; }
        .confirmation-buttons { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }

        /* --- Page Specific --- */
        #dashboard-summary .report-card { text-align: center; }
        .report-card-title { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 10px; }
        .report-card-value { font-size: 1.8rem; font-weight: 600; }
        .report-card-value.income { color: var(--success-color); }
        .report-card-value.expense { color: var(--danger-color); }
        .report-card-value.profit { color: var(--primary-color); }
        .transaction-item, .debt-card, .note-card, .product-card, .contact-card { border-left: 4px solid; padding: 15px; margin-bottom: 15px; background: var(--body-bg); border-radius: var(--rounded); }
        .transaction-item.income { border-color: var(--success-color); }
        .transaction-item.expense { border-color: var(--danger-color); }
        .debt-card { border-color: var(--danger-color); }
        .debt-card.paid { border-color: var(--success-color); }
        .note-card { border-color: var(--info-color); }
        .item-actions { display: flex; gap: 8px; margin-top: 10px; }
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }
        .empty-state i { font-size: 3rem; margin-bottom: 15px; }
        .print-area { display: none; } /* for printing reports */

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes modalFadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Print Styles --- */
        @media print {
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .print-area h1 { margin-bottom: 20px; }
            .print-area table { width: 100%; border-collapse: collapse; }
            .print-area th, .print-area td { border: 1px solid #ddd; padding: 8px; }
        }
    </style>
</head>
<body>
    <div id="splashScreen">
        <div class="splash-logo"><i class="fas fa-store"></i></div>
        <h1 class="splash-title">Aplikasi UMKM Pro</h1>
        <p class="splash-subtitle">Solusi Digital Lengkap untuk Usaha Anda</p>
        <div class="splash-credits">
            Dibuat oleh <strong>Lentera Karya Situbondo</strong><br>
            Developer: <strong>www.aplikasiusaha.com</strong> | WhatsApp: <strong>085647709114</strong><br>
            <small>Versi 4.0.0 | © 2025</small>
        </div>
    </div>

    <div id="loginModal" class="modal">
        <div class="login-container">
            <h2 class="login-title">Masuk ke Aplikasi</h2>
            <form id="loginForm">
                <div class="form-floating">
                    <input type="text" id="username" placeholder=" " required value="admin">
                    <label for="username">Username</label>
                </div>
                <div class="form-floating">
                    <input type="password" id="password" placeholder=" " required>
                    <label for="password">Password</label>
                </div>
                <div class="captcha-container">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <div id="captchaBox" class="captcha-box"></div>
                        <button type="button" id="refreshCaptcha" class="btn btn-secondary btn-sm" title="Refresh"><i class="fas fa-sync-alt"></i></button>
                    </div>
                    <input type="text" id="captchaInput" class="form-control" placeholder="Masukkan captcha" required autocomplete="off" style="margin-top: 10px;">
                </div>
                <button type="submit" class="btn" style="width: 100%;">Login</button>
            </form>
        </div>
    </div>
    
    <div class="app-layout" id="mainApp" style="display: none;">
        <nav id="sidebar">
            <div class="sidebar-header">
                <div class="logo"><i class="fas fa-store"></i></div>
                <h2 id="businessNameSidebar">UMKM Pro</h2>
                <p style="font-size: 0.8rem; color: var(--text-muted);">Pengguna: <span id="loggedInUser"></span></p>
            </div>
            <div class="sidebar-nav">
                <a href="#" class="nav-link active" data-page="dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                <a href="#" class="nav-link" data-page="transactions"><i class="fas fa-book"></i> Buku Kas</a>
                <a href="#" class="nav-link" data-page="debts"><i class="fas fa-hand-holding-usd"></i> Hutang Piutang</a>
                <a href="#" class="nav-link" data-page="products"><i class="fas fa-box-open"></i> Produk & Stok</a>
                <a href="#" class="nav-link" data-page="contacts"><i class="fas fa-address-book"></i> Kontak</a>
                <a href="#" class="nav-link" data-page="notes"><i class="fas fa-sticky-note"></i> Catatan</a>
                <a href="#" class="nav-link" data-page="reports"><i class="fas fa-chart-pie"></i> Laporan</a>
                <a href="#" class="nav-link" data-page="settings"><i class="fas fa-cog"></i> Pengaturan</a>
            </div>
            <div class="sidebar-footer">
                <a href="#" id="logoutBtn" style="color: var(--danger-color); text-decoration: none;"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
        </nav>

        <main id="main-content">
            <div id="dashboard" class="page active">
                <div class="page-header">
                    <h1 id="welcomeMessage">Selamat Datang, Admin!</h1>
                    <p id="currentDate" style="color: var(--text-muted);"></p>
                </div>
                <div class="grid-container" id="dashboard-summary">
                    <div class="card">
                        <div class="report-card-title">Total Pemasukan (Bulan Ini)</div>
                        <div class="report-card-value income" id="totalIncome">Rp 0</div>
                    </div>
                    <div class="card">
                        <div class="report-card-title">Total Pengeluaran (Bulan Ini)</div>
                        <div class="report-card-value expense" id="totalExpense">Rp 0</div>
                    </div>
                    <div class="card">
                        <div class="report-card-title">Laba Bersih (Bulan Ini)</div>
                        <div class="report-card-value profit" id="netProfit">Rp 0</div>
                    </div>
                    <div class="card">
                        <div class="report-card-title">Piutang Belum Lunas</div>
                        <div class="report-card-value" id="totalReceivables">Rp 0</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">Grafik Keuangan 7 Hari Terakhir</div>
                    <canvas id="financeChart"></canvas>
                </div>
            </div>

            <div id="transactions" class="page">
                <div class="page-header"><h1>Buku Kas</h1></div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Daftar Transaksi</h3>
                        <button class="btn btn-success" id="addTransactionBtn"><i class="fas fa-plus"></i> Tambah Transaksi</button>
                    </div>
                    <div id="transactionsList"></div>
                </div>
            </div>

            <div id="debts" class="page">
                <div class="page-header"><h1>Hutang Piutang</h1></div>
                 <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Daftar Hutang & Piutang</h3>
                        <button class="btn btn-success" id="addDebtBtn"><i class="fas fa-plus"></i> Tambah Data</button>
                    </div>
                    <div id="debtsList"></div>
                </div>
            </div>

            <div id="products" class="page">
                <div class="page-header"><h1>Produk & Stok</h1></div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Daftar Produk</h3>
                        <button class="btn btn-success" id="addProductBtn"><i class="fas fa-plus"></i> Tambah Produk</button>
                    </div>
                    <div class="grid-container" id="productsList"></div>
                </div>
            </div>

            <div id="contacts" class="page">
                <div class="page-header"><h1>Kontak</h1></div>
                 <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Daftar Kontak</h3>
                        <button class="btn btn-success" id="addContactBtn"><i class="fas fa-plus"></i> Tambah Kontak</button>
                    </div>
                    <div id="contactsList"></div>
                </div>
            </div>

            <div id="notes" class="page">
                <div class="page-header"><h1>Catatan</h1></div>
                 <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Daftar Catatan</h3>
                        <button class="btn btn-success" id="addNoteBtn"><i class="fas fa-plus"></i> Tambah Catatan</button>
                    </div>
                    <div class="grid-container" id="notesList"></div>
                </div>
            </div>

            <div id="reports" class="page">
                <div class="page-header"><h1>Laporan Keuangan</h1></div>
                <div class="card">
                    <div class="card-title">Generate Laporan Laba Rugi</div>
                    <div class="form-group" style="display:flex; gap: 15px; align-items: center;">
                        <div>
                            <label for="startDate">Dari Tanggal</label>
                            <input type="date" id="startDate" class="form-control">
                        </div>
                        <div>
                            <label for="endDate">Sampai Tanggal</label>
                            <input type="date" id="endDate" class="form-control">
                        </div>
                    </div>
                    <button class="btn btn-info" id="generateReportBtn"><i class="fas fa-cogs"></i> Generate</button>
                    <button class="btn btn-secondary" id="printReportBtn" style="display: none;"><i class="fas fa-print"></i> Cetak</button>
                </div>
                <div class="card" id="reportResult" style="display: none;"></div>
            </div>

            <div id="settings" class="page">
                 <div class="page-header"><h1>Pengaturan</h1></div>
                 <div class="grid-container">
                    <div class="card">
                        <h3 class="card-title">Pengaturan Umum</h3>
                        <div class="form-group">
                            <label for="businessNameSetting">Nama UMKM</label>
                            <input type="text" id="businessNameSetting" class="form-control">
                        </div>
                        <div class="form-group">
                             <label>Tampilan</label>
                             <button id="toggleDarkMode" class="btn btn-secondary"><i class="fas fa-moon"></i> Ganti Mode</button>
                        </div>
                        <button id="saveSettingsBtn" class="btn btn-success">Simpan Pengaturan</button>
                    </div>
                     <div class="card">
                        <h3 class="card-title">Keamanan</h3>
                        <div class="form-group">
                            <label for="changePassword">Password Baru</label>
                            <input type="password" id="changePassword" class="form-control" placeholder="Masukkan password baru">
                        </div>
                        <button id="savePasswordBtn" class="btn btn-warning">Ganti Password</button>
                    </div>
                     <div class="card">
                        <h3 class="card-title">Data</h3>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                            <button id="backupDataBtn" class="btn btn-info"><i class="fas fa-download"></i> Backup Data (.prodata)</button>
                            <button id="restoreDataBtn" class="btn btn-warning"><i class="fas fa-upload"></i> Restore Data</button>
                            <input type="file" id="restoreFileInput" style="display: none;" accept=".prodata">
                            <button id="exportCsvBtn" class="btn btn-success"><i class="fas fa-file-csv"></i> Ekspor Transaksi (.csv)</button>
                            <button id="clearDataBtn" class="btn btn-danger"><i class="fas fa-trash-alt"></i> Hapus Semua Data</button>
                        </div>
                    </div>
                 </div>
            </div>
        </main>
    </div>
    
    <div id="toast" class="toast"><i id="toast-icon"></i> <span id="toast-message"></span></div>
    <div id="confirmationDialog" class="confirmation-dialog" style="display: none;">
        <div class="confirmation-content">
            <h4 id="confirmationMessage"></h4>
            <div class="confirmation-buttons">
                <button id="confirmCancel" class="btn btn-secondary">Batal</button>
                <button id="confirmOk" class="btn btn-danger">Ya</button>
            </div>
        </div>
    </div>
    
    <div id="formModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle"></h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                </div>
            <div class="modal-footer">
                <button class="btn btn-secondary close-modal">Batal</button>
                <button class="btn btn-success" id="saveBtn">Simpan</button>
            </div>
        </div>
    </div>
    
    <div id="printReportArea" class="print-area"></div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/locale/id.js"></script>
    <script>
    // This is a very large script, so it will be written here directly.
    document.addEventListener('DOMContentLoaded', function() {

    // --- APPLICATION STATE & CONFIG ---
    const App = {
        
        // --- DATA ---
        data: {
            notes: [],
            debts: [],
            transactions: [],
            products: [],
            contacts: [],
            settings: {},
            currentUser: null,
            captchaText: ''
        },

        // --- STORAGE KEYS ---
        STORAGE_KEYS: {
            DATA: 'umkm_pro_v4_data'
        },

        // --- UI ELEMENTS ---
        elements: {
            // Add references to frequently used DOM elements here
        },

        // --- CHART INSTANCE ---
        financeChart: null,

        // --- INITIALIZATION ---
        init() {
            moment.locale('id');
            this.loadData();
            
            if (!this.data.currentUser) {
                this.showLogin();
            } else {
                this.startApp();
            }

            setTimeout(() => {
                const splash = document.getElementById('splashScreen');
                if (splash) {
                    splash.style.opacity = '0';
                    setTimeout(() => splash.style.display = 'none', 1000);
                }
            }, 2000);
            
            this.addEventListeners();
        },

        // --- DATA MANAGEMENT ---
        loadData() {
            const savedData = localStorage.getItem(this.STORAGE_KEYS.DATA);
            if (savedData) {
                const parsedData = JSON.parse(savedData);
                // Merge saved data with defaults to ensure new features work
                this.data = {
                    ...{ // Defaults
                        notes: [], debts: [], transactions: [], products: [], contacts: [],
                        settings: { businessName: "UMKM Saya", darkMode: false },
                        currentUser: null
                    },
                    ...parsedData
                };
            } else {
                 // First time load: Set default password
                this.data.settings = { businessName: "UMKM Saya", password: "admin", darkMode: false };
                this.saveData();
            }
        },

        saveData() {
            localStorage.setItem(this.STORAGE_KEYS.DATA, JSON.stringify(this.data));
        },
        
        // --- UI & RENDERING ---
        
        refreshUI() {
            if (!this.data.currentUser) return;
            
            const currentPage = document.querySelector('.nav-link.active').dataset.page;
            
            // Update common elements
            document.getElementById('businessNameSidebar').textContent = this.data.settings.businessName || "UMKM Pro";
            document.getElementById('loggedInUser').textContent = this.data.currentUser.username;
            document.body.classList.toggle('dark-mode', this.data.settings.darkMode);

            this.navigateTo(currentPage, true); // force re-render
        },

        showLogin() {
            document.getElementById('loginModal').style.display = 'flex';
            this.generateCaptcha();
        },

        startApp() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('mainApp').style.display = 'flex';
            this.refreshUI();
        },
        
        navigateTo(pageId, forceRefresh = false) {
             if (!forceRefresh && document.getElementById(pageId)?.classList.contains('active')) return;

            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');

            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.querySelector(`.nav-link[data-page="${pageId}"]`).classList.add('active');

            // Call render function for the specific page
            const renderFunction = `render${pageId.charAt(0).toUpperCase() + pageId.slice(1)}`;
            if (typeof this[renderFunction] === 'function') {
                this[renderFunction]();
            }
        },

        // --- RENDER FUNCTIONS FOR EACH PAGE ---

        renderDashboard() {
            document.getElementById('welcomeMessage').textContent = `Selamat Datang, ${this.data.currentUser.username}!`;
            document.getElementById('currentDate').textContent = moment().format('dddd, D MMMM YYYY');
            
            // Calculate metrics
            const startOfMonth = moment().startOf('month');
            const endOfMonth = moment().endOf('month');
            
            const monthlyIncome = this.data.transactions
                .filter(t => t.type === 'income' && moment(t.date).isBetween(startOfMonth, endOfMonth))
                .reduce((sum, t) => sum + t.amount, 0);
                
            const monthlyExpense = this.data.transactions
                .filter(t => t.type === 'expense' && moment(t.date).isBetween(startOfMonth, endOfMonth))
                .reduce((sum, t) => sum + t.amount, 0);

            const unpaidReceivables = this.data.debts
                .filter(d => d.type === 'receivable' && d.status === 'unpaid')
                .reduce((sum, d) => sum + d.amount, 0);

            document.getElementById('totalIncome').textContent = this.formatCurrency(monthlyIncome);
            document.getElementById('totalExpense').textContent = this.formatCurrency(monthlyExpense);
            document.getElementById('netProfit').textContent = this.formatCurrency(monthlyIncome - monthlyExpense);
            document.getElementById('totalReceivables').textContent = this.formatCurrency(unpaidReceivables);
            
            // Render chart
            this.renderFinanceChart();
        },

        renderFinanceChart() {
            const ctx = document.getElementById('financeChart').getContext('2d');
            const labels = [];
            const incomeData = [];
            const expenseData = [];

            for (let i = 6; i >= 0; i--) {
                const date = moment().subtract(i, 'days');
                labels.push(date.format('DD/MM'));
                
                const dayIncome = this.data.transactions
                    .filter(t => t.type === 'income' && moment(t.date).isSame(date, 'day'))
                    .reduce((sum, t) => sum + t.amount, 0);
                incomeData.push(dayIncome);
                
                const dayExpense = this.data.transactions
                    .filter(t => t.type === 'expense' && moment(t.date).isSame(date, 'day'))
                    .reduce((sum, t) => sum + t.amount, 0);
                expenseData.push(dayExpense);
            }

            if (this.financeChart) {
                this.financeChart.destroy();
            }

            this.financeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Pemasukan', data: incomeData, borderColor: 'rgba(16, 185, 129, 1)', backgroundColor: 'rgba(16, 185, 129, 0.2)', fill: true, tension: 0.3 },
                        { label: 'Pengeluaran', data: expenseData, borderColor: 'rgba(239, 68, 68, 1)', backgroundColor: 'rgba(239, 68, 68, 0.2)', fill: true, tension: 0.3 }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        },
        
        renderTransactions() {
            const list = document.getElementById('transactionsList');
            list.innerHTML = '';
            if (this.data.transactions.length === 0) {
                list.innerHTML = `<div class="empty-state"><i class="fas fa-book"></i><p>Belum ada transaksi</p></div>`;
                return;
            }
            // Sort by date descending
            const sorted = [...this.data.transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
            sorted.forEach(t => {
                const item = document.createElement('div');
                item.className = `transaction-item ${t.type}`;
                item.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <strong>${t.description}</strong>
                            <div style="font-size: 0.9rem; color: var(--text-muted);">${moment(t.date).format('LL')} | Kategori: ${t.category || '-'}</div>
                        </div>
                        <strong style="font-size: 1.1rem;">${this.formatCurrency(t.amount)}</strong>
                    </div>
                    <div class="item-actions">
                         <button class="btn btn-sm btn-info edit-item" data-id="${t.id}" data-type="transaction"><i class="fas fa-edit"></i> Edit</button>
                         <button class="btn btn-sm btn-danger delete-item" data-id="${t.id}" data-type="transaction"><i class="fas fa-trash"></i> Hapus</button>
                    </div>`;
                list.appendChild(item);
            });
        },

        renderDebts() {
             const list = document.getElementById('debtsList');
             list.innerHTML = '';
             if (this.data.debts.length === 0) {
                list.innerHTML = `<div class="empty-state"><i class="fas fa-hand-holding-usd"></i><p>Tidak ada data hutang/piutang</p></div>`;
                return;
            }
             const sorted = [...this.data.debts].sort((a, b) => new Date(b.dueDate) - new Date(a.dueDate));
             sorted.forEach(d => {
                 const card = document.createElement('div');
                 card.className = `debt-card ${d.status}`;
                 card.innerHTML = `
                     <strong>${d.type === 'debt' ? 'Hutang ke' : 'Piutang dari'} ${d.person}</strong>
                     <div>Jumlah: <strong>${this.formatCurrency(d.amount)}</strong></div>
                     <div style="font-size: 0.9rem; color: var(--text-muted);">Jatuh Tempo: ${moment(d.dueDate).format('LL')}</div>
                     <span style="background-color: ${d.status === 'paid' ? 'var(--success-light)' : 'var(--danger-light)'}; color: ${d.status === 'paid' ? 'var(--success-color)' : 'var(--danger-color)'}; padding: 3px 8px; border-radius: 12px; font-size: 0.8rem;">${d.status === 'paid' ? 'Lunas' : 'Belum Lunas'}</span>
                     <div class="item-actions">
                         <button class="btn btn-sm btn-info edit-item" data-id="${d.id}" data-type="debt"><i class="fas fa-edit"></i> Edit</button>
                         <button class="btn btn-sm btn-danger delete-item" data-id="${d.id}" data-type="debt"><i class="fas fa-trash"></i> Hapus</button>
                     </div>
                 `;
                 list.appendChild(card);
             });
        },
        
        renderProducts() {
            const list = document.getElementById('productsList');
            list.innerHTML = '';
             if (this.data.products.length === 0) {
                list.innerHTML = `<div class="empty-state" style="grid-column: 1 / -1;"><i class="fas fa-box-open"></i><p>Belum ada produk</p></div>`;
                return;
            }
            this.data.products.forEach(p => {
                const card = document.createElement('div');
                card.className = 'card product-card';
                card.innerHTML = `
                    <h4 style="color: var(--primary-color);">${p.name}</h4>
                    <div>Stok: <strong>${p.stock}</strong></div>
                    <div>Harga Beli: ${this.formatCurrency(p.purchasePrice)}</div>
                    <div>Harga Jual: ${this.formatCurrency(p.sellPrice)}</div>
                    <div class="item-actions">
                        <button class="btn btn-sm btn-success sell-product" data-id="${p.id}"><i class="fas fa-shopping-cart"></i> Jual</button>
                        <button class="btn btn-sm btn-info edit-item" data-id="${p.id}" data-type="product"><i class="fas fa-edit"></i> Edit</button>
                        <button class="btn btn-sm btn-danger delete-item" data-id="${p.id}" data-type="product"><i class="fas fa-trash"></i> Hapus</button>
                    </div>
                `;
                list.appendChild(card);
            });
        },
        
        renderContacts() {
            const list = document.getElementById('contactsList');
            list.innerHTML = '';
             if (this.data.contacts.length === 0) {
                list.innerHTML = `<div class="empty-state"><i class="fas fa-address-book"></i><p>Belum ada kontak</p></div>`;
                return;
            }
            this.data.contacts.forEach(c => {
                const card = document.createElement('div');
                card.className = 'contact-card';
                card.innerHTML = `
                    <strong>${c.name}</strong>
                    <div><i class="fas fa-phone" style="margin-right: 5px; color: var(--text-muted);"></i> ${c.phone || '-'}</div>
                    <div><i class="fas fa-info-circle" style="margin-right: 5px; color: var(--text-muted);"></i> ${c.info || '-'}</div>
                    <div class="item-actions">
                         <button class="btn btn-sm btn-info edit-item" data-id="${c.id}" data-type="contact"><i class="fas fa-edit"></i> Edit</button>
                         <button class="btn btn-sm btn-danger delete-item" data-id="${c.id}" data-type="contact"><i class="fas fa-trash"></i> Hapus</button>
                    </div>
                `;
                list.appendChild(card);
            });
        },
        
        renderNotes() {
            const list = document.getElementById('notesList');
            list.innerHTML = '';
            if (this.data.notes.length === 0) {
                list.innerHTML = `<div class="empty-state" style="grid-column: 1 / -1;"><i class="fas fa-sticky-note"></i><p>Belum ada catatan</p></div>`;
                return;
            }
            this.data.notes.forEach(n => {
                const card = document.createElement('div');
                card.className = 'card note-card';
                card.innerHTML = `
                    <strong>${n.title}</strong>
                    <p>${n.content}</p>
                    <div class="item-actions">
                        <button class="btn btn-sm btn-info edit-item" data-id="${n.id}" data-type="note"><i class="fas fa-edit"></i> Edit</button>
                        <button class="btn btn-sm btn-danger delete-item" data-id="${n.id}" data-type="note"><i class="fas fa-trash"></i> Hapus</button>
                    </div>
                `;
                list.appendChild(card);
            });
        },
        
        renderReports() {
            // This page is interactive, main rendering happens on button click
            document.getElementById('reportResult').style.display = 'none';
            document.getElementById('printReportBtn').style.display = 'none';
            document.getElementById('startDate').valueAsDate = moment().startOf('month').toDate();
            document.getElementById('endDate').valueAsDate = moment().endOf('month').toDate();
        },
        
        renderSettings() {
            document.getElementById('businessNameSetting').value = this.data.settings.businessName || '';
            document.getElementById('changePassword').value = '';
        },
        
        // --- EVENT LISTENERS ---
        addEventListeners() {
            // Login
            document.getElementById('loginForm').addEventListener('submit', this.handleLogin.bind(this));
            document.getElementById('refreshCaptcha').addEventListener('click', this.generateCaptcha.bind(this));
            document.getElementById('logoutBtn').addEventListener('click', this.handleLogout.bind(this));
            
            // Navigation
            document.querySelector('.sidebar-nav').addEventListener('click', e => {
                if(e.target.closest('.nav-link')) {
                    e.preventDefault();
                    this.navigateTo(e.target.closest('.nav-link').dataset.page);
                }
            });

            // "Add" buttons
            document.getElementById('addTransactionBtn')?.addEventListener('click', () => this.openForm('transaction'));
            document.getElementById('addDebtBtn')?.addEventListener('click', () => this.openForm('debt'));
            document.getElementById('addProductBtn')?.addEventListener('click', () => this.openForm('product'));
            document.getElementById('addContactBtn')?.addEventListener('click', () => this.openForm('contact'));
            document.getElementById('addNoteBtn')?.addEventListener('click', () => this.openForm('note'));

            // Modal actions
            document.getElementById('saveBtn').addEventListener('click', this.handleSave.bind(this));
            document.querySelectorAll('.modal-close, .close-modal').forEach(el => el.addEventListener('click', () => document.getElementById('formModal').style.display = 'none'));
            
            // Item actions (edit, delete, sell) - using event delegation
            document.getElementById('mainApp').addEventListener('click', e => {
                const editBtn = e.target.closest('.edit-item');
                const deleteBtn = e.target.closest('.delete-item');
                const sellBtn = e.target.closest('.sell-product');
                if (editBtn) this.openForm(editBtn.dataset.type, editBtn.dataset.id);
                if (deleteBtn) this.handleDelete(deleteBtn.dataset.type, deleteBtn.dataset.id);
                if (sellBtn) this.handleSellProduct(sellBtn.dataset.id);
            });
            
            // Reports
            document.getElementById('generateReportBtn').addEventListener('click', this.generateReport.bind(this));
            document.getElementById('printReportBtn').addEventListener('click', this.printReport.bind(this));

            // Settings
            document.getElementById('saveSettingsBtn').addEventListener('click', this.saveSettings.bind(this));
            document.getElementById('toggleDarkMode').addEventListener('click', this.toggleDarkMode.bind(this));
            document.getElementById('savePasswordBtn').addEventListener('click', this.changePassword.bind(this));
            document.getElementById('backupDataBtn').addEventListener('click', this.backupData.bind(this));
            document.getElementById('restoreDataBtn').addEventListener('click', () => document.getElementById('restoreFileInput').click());
            document.getElementById('restoreFileInput').addEventListener('change', this.restoreData.bind(this));
            document.getElementById('exportCsvBtn').addEventListener('click', this.exportToCSV.bind(this));
            document.getElementById('clearDataBtn').addEventListener('click', this.clearAllData.bind(this));
        },
        
        // --- HANDLERS & LOGIC ---
        
        handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const captcha = document.getElementById('captchaInput').value.toUpperCase();
            
            if (captcha !== this.data.captchaText) {
                this.showToast('Captcha tidak sesuai', 'error');
                this.generateCaptcha();
                return;
            }
            
            if (username.toLowerCase() === 'admin' && password === this.data.settings.password) {
                this.data.currentUser = { username: 'Admin' };
                this.saveData();
                this.startApp();
                this.showToast('Login berhasil!', 'success');
            } else {
                this.showToast('Username atau password salah', 'error');
            }
        },

        handleLogout(e) {
            e.preventDefault();
            this.showConfirmation('Anda yakin ingin logout?', (confirm) => {
                if (confirm) {
                    this.data.currentUser = null;
                    this.saveData();
                    window.location.reload();
                }
            });
        },
        
        openForm(type, id = null) {
            const modalBody = document.getElementById('modalBody');
            const modalTitle = document.getElementById('modalTitle');
            let html = '';
            let title = '';
            let currentData = null;
            
            if(id) {
                const collection = this.data[`${type}s`];
                currentData = collection.find(item => item.id === id);
            }

            switch(type) {
                case 'transaction':
                    title = id ? 'Edit Transaksi' : 'Tambah Transaksi';
                    html = `
                        <input type="hidden" id="formId" value="${id || ''}">
                        <input type="hidden" id="formType" value="transaction">
                        <div class="form-group">
                            <label>Jenis</label>
                            <select id="transactionType" class="form-control">
                                <option value="income" ${currentData?.type === 'income' ? 'selected' : ''}>Pemasukan</option>
                                <option value="expense" ${currentData?.type === 'expense' ? 'selected' : ''}>Pengeluaran</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Tanggal</label>
                            <input type="date" id="transactionDate" class="form-control" value="${currentData ? moment(currentData.date).format('YYYY-MM-DD') : moment().format('YYYY-MM-DD')}">
                        </div>
                        <div class="form-group">
                            <label>Deskripsi</label>
                            <input type="text" id="transactionDesc" class="form-control" placeholder="cth: Penjualan Produk A" value="${currentData?.description || ''}">
                        </div>
                        <div class="form-group">
                            <label>Jumlah</label>
                            <input type="number" id="transactionAmount" class="form-control" placeholder="cth: 50000" value="${currentData?.amount || ''}">
                        </div>
                         <div class="form-group">
                            <label>Kategori</label>
                            <input type="text" id="transactionCategory" class="form-control" placeholder="cth: Penjualan, Bahan Baku" value="${currentData?.category || ''}">
                        </div>
                    `;
                    break;
                case 'debt':
                     title = id ? 'Edit Hutang/Piutang' : 'Tambah Hutang/Piutang';
                    html = `
                        <input type="hidden" id="formId" value="${id || ''}">
                        <input type="hidden" id="formType" value="debt">
                         <div class="form-group">
                            <label>Jenis</label>
                            <select id="debtType" class="form-control">
                                <option value="debt" ${currentData?.type === 'debt' ? 'selected' : ''}>Hutang (Saya berhutang)</option>
                                <option value="receivable" ${currentData?.type === 'receivable' ? 'selected' : ''}>Piutang (Orang lain berhutang)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Nama</label>
                            <input type="text" id="debtPerson" class="form-control" placeholder="Nama orang/supplier" value="${currentData?.person || ''}">
                        </div>
                         <div class="form-group">
                            <label>Jumlah</label>
                            <input type="number" id="debtAmount" class="form-control" placeholder="cth: 100000" value="${currentData?.amount || ''}">
                        </div>
                         <div class="form-group">
                            <label>Tanggal Jatuh Tempo</label>
                            <input type="date" id="debtDueDate" class="form-control" value="${currentData?.dueDate || ''}">
                        </div>
                         <div class="form-group">
                            <label>Status</label>
                            <select id="debtStatus" class="form-control">
                                <option value="unpaid" ${currentData?.status === 'unpaid' ? 'selected' : ''}>Belum Lunas</option>
                                <option value="paid" ${currentData?.status === 'paid' ? 'selected' : ''}>Lunas</option>
                            </select>
                        </div>
                    `;
                    break;
                 case 'product':
                    title = id ? 'Edit Produk' : 'Tambah Produk';
                    html = `
                        <input type="hidden" id="formId" value="${id || ''}">
                        <input type="hidden" id="formType" value="product">
                        <div class="form-group">
                            <label>Nama Produk</label>
                            <input type="text" id="productName" class="form-control" value="${currentData?.name || ''}">
                        </div>
                        <div class="form-group">
                            <label>Stok Awal</label>
                            <input type="number" id="productStock" class="form-control" value="${currentData?.stock || 0}">
                        </div>
                        <div class="form-group">
                            <label>Harga Beli (Modal)</label>
                            <input type="number" id="productPurchasePrice" class="form-control" value="${currentData?.purchasePrice || 0}">
                        </div>
                        <div class="form-group">
                            <label>Harga Jual</label>
                            <input type="number" id="productSellPrice" class="form-control" value="${currentData?.sellPrice || 0}">
                        </div>
                    `;
                    break;
                case 'contact':
                    title = id ? 'Edit Kontak' : 'Tambah Kontak';
                    html = `
                         <input type="hidden" id="formId" value="${id || ''}">
                         <input type="hidden" id="formType" value="contact">
                        <div class="form-group">
                            <label>Nama</label>
                            <input type="text" id="contactName" class="form-control" value="${currentData?.name || ''}">
                        </div>
                         <div class="form-group">
                            <label>No. Telepon</label>
                            <input type="tel" id="contactPhone" class="form-control" value="${currentData?.phone || ''}">
                        </div>
                         <div class="form-group">
                            <label>Keterangan</label>
                            <textarea id="contactInfo" class="form-control" rows="3">${currentData?.info || ''}</textarea>
                        </div>
                    `;
                    break;
                case 'note':
                    title = id ? 'Edit Catatan' : 'Tambah Catatan';
                     html = `
                         <input type="hidden" id="formId" value="${id || ''}">
                         <input type="hidden" id="formType" value="note">
                        <div class="form-group">
                            <label>Judul</label>
                            <input type="text" id="noteTitle" class="form-control" value="${currentData?.title || ''}">
                        </div>
                        <div class="form-group">
                            <label>Isi Catatan</label>
                            <textarea id="noteContent" class="form-control" rows="5">${currentData?.content || ''}</textarea>
                        </div>
                    `;
                    break;
            }
            
            modalTitle.textContent = title;
            modalBody.innerHTML = html;
            document.getElementById('formModal').style.display = 'flex';
        },
        
        handleSave() {
            const id = document.getElementById('formId').value;
            const type = document.getElementById('formType').value;
            const collection = this.data[`${type}s`];
            let newData = {};

            switch(type) {
                case 'transaction':
                    newData = {
                        type: document.getElementById('transactionType').value,
                        date: document.getElementById('transactionDate').value,
                        description: document.getElementById('transactionDesc').value,
                        amount: parseFloat(document.getElementById('transactionAmount').value),
                        category: document.getElementById('transactionCategory').value
                    };
                    break;
                case 'debt':
                     newData = {
                        type: document.getElementById('debtType').value,
                        person: document.getElementById('debtPerson').value,
                        amount: parseFloat(document.getElementById('debtAmount').value),
                        dueDate: document.getElementById('debtDueDate').value,
                        status: document.getElementById('debtStatus').value,
                    };
                    break;
                case 'product':
                     newData = {
                        name: document.getElementById('productName').value,
                        stock: parseInt(document.getElementById('productStock').value),
                        purchasePrice: parseFloat(document.getElementById('productPurchasePrice').value),
                        sellPrice: parseFloat(document.getElementById('productSellPrice').value),
                    };
                    break;
                 case 'contact':
                     newData = {
                        name: document.getElementById('contactName').value,
                        phone: document.getElementById('contactPhone').value,
                        info: document.getElementById('contactInfo').value
                    };
                    break;
                case 'note':
                     newData = {
                        title: document.getElementById('noteTitle').value,
                        content: document.getElementById('noteContent').value
                    };
                    break;
            }

            if(id) { // Update existing
                const index = collection.findIndex(item => item.id === id);
                collection[index] = { ...collection[index], ...newData };
            } else { // Create new
                newData.id = type.charAt(0).toUpperCase() + Date.now();
                collection.unshift(newData);
            }

            this.saveData();
            this.refreshUI();
            document.getElementById('formModal').style.display = 'none';
            this.showToast('Data berhasil disimpan!', 'success');
        },
        
        handleDelete(type, id) {
             this.showConfirmation('Anda yakin ingin menghapus data ini?', (confirm) => {
                if (confirm) {
                    this.data[`${type}s`] = this.data[`${type}s`].filter(item => item.id !== id);
                    this.saveData();
                    this.refreshUI();
                    this.showToast('Data berhasil dihapus!', 'success');
                }
            });
        },
        
        handleSellProduct(id) {
            const product = this.data.products.find(p => p.id === id);
            if (!product || product.stock <= 0) {
                this.showToast('Stok produk habis!', 'warning');
                return;
            }

            this.showConfirmation(`Jual 1 item "${product.name}"? Stok akan berkurang.`, (confirm) => {
                if(confirm) {
                    product.stock--;
                    this.data.transactions.unshift({
                        id: 'T' + Date.now(),
                        type: 'income',
                        date: moment().format('YYYY-MM-DD'),
                        description: `Penjualan ${product.name}`,
                        amount: product.sellPrice,
                        category: 'Penjualan Produk'
                    });
                    this.saveData();
                    this.refreshUI();
                    this.showToast('Produk berhasil dijual!', 'success');
                }
            });
        },
        
        generateReport() {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            const resultDiv = document.getElementById('reportResult');
            
            const filtered = this.data.transactions.filter(t => moment(t.date).isBetween(start, end, null, '[]'));
            const income = filtered.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expense = filtered.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const profit = income - expense;

            let html = `
                <h3>Laporan Laba Rugi</h3>
                <p>Periode: ${moment(start).format('LL')} - ${moment(end).format('LL')}</p>
                <hr style="margin: 15px 0;">
                <p>Total Pemasukan: <strong style="color: var(--success-color);">${this.formatCurrency(income)}</strong></p>
                <p>Total Pengeluaran: <strong style="color: var(--danger-color);">${this.formatCurrency(expense)}</strong></p>
                <h4>Laba Bersih: <strong style="color: ${profit >= 0 ? 'var(--primary-color)' : 'var(--danger-color)'};">${this.formatCurrency(profit)}</strong></h4>
                <br>
                <h4>Detail Transaksi:</h4>
                 <table>
                    <thead><tr><th>Tanggal</th><th>Deskripsi</th><th>Jenis</th><th>Jumlah</th></tr></thead>
                    <tbody>
                        ${filtered.map(t => `
                            <tr>
                                <td>${moment(t.date).format('DD/MM/YY')}</td>
                                <td>${t.description}</td>
                                <td>${t.type === 'income' ? 'Pemasukan' : 'Pengeluaran'}</td>
                                <td style="text-align: right;">${this.formatCurrency(t.amount)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            resultDiv.innerHTML = html;
            resultDiv.style.display = 'block';
            document.getElementById('printReportBtn').style.display = 'inline-block';
            
            document.getElementById('printReportArea').innerHTML = `<h1>Laporan Keuangan ${this.data.settings.businessName}</h1>` + html;
        },
        
        printReport() {
            window.print();
        },
        
        saveSettings() {
            this.data.settings.businessName = document.getElementById('businessNameSetting').value;
            this.saveData();
            this.refreshUI();
            this.showToast('Pengaturan disimpan!', 'success');
        },

        toggleDarkMode() {
            this.data.settings.darkMode = !this.data.settings.darkMode;
            document.body.classList.toggle('dark-mode', this.data.settings.darkMode);
            this.saveData();
            // Chart needs to be re-rendered with new colors if needed
            this.renderFinanceChart(); 
        },

        changePassword() {
            const newPassword = document.getElementById('changePassword').value;
            if (newPassword.length < 4) {
                this.showToast('Password minimal 4 karakter', 'error');
                return;
            }
            this.data.settings.password = newPassword;
            this.saveData();
            document.getElementById('changePassword').value = '';
            this.showToast('Password berhasil diganti!', 'success');
        },

        backupData() {
            const dataStr = btoa(JSON.stringify(this.data));
            const blob = new Blob([dataStr], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `UMKM_Pro_Backup_${moment().format('YYYYMMDD')}.prodata`;
            a.click();
            URL.revokeObjectURL(url);
            this.showToast('Backup data berhasil diunduh.', 'success');
        },

        restoreData(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const restoredData = JSON.parse(atob(event.target.result));
                    if (restoredData.settings && restoredData.currentUser !== undefined) {
                        // Keep current user logged in
                        const currentUser = this.data.currentUser;
                        this.data = restoredData;
                        this.data.currentUser = currentUser;
                        this.saveData();
                        this.refreshUI();
                        this.showToast('Data berhasil dipulihkan!', 'success');
                    } else { throw new Error('Invalid file'); }
                } catch (err) {
                    this.showToast('Gagal membaca file backup. File tidak valid.', 'error');
                }
            };
            reader.readAsText(file);
        },
        
        exportToCSV() {
            let csvContent = "data:text/csv;charset=utf-8,Tanggal,Deskripsi,Kategori,Jenis,Jumlah\n";
            this.data.transactions.forEach(t => {
                const row = [moment(t.date).format('YYYY-MM-DD'), t.description, t.category, t.type, t.amount].join(',');
                csvContent += row + "\n";
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `Laporan_Transaksi_${moment().format('YYYYMMDD')}.csv`);
            document.body.appendChild(link);
            link.click();
            link.remove();
            this.showToast('Data transaksi diekspor ke CSV.', 'success');
        },

        clearAllData() {
            this.showConfirmation('PERINGATAN: Semua data (transaksi, produk, dll) akan dihapus permanen. Lanjutkan?', (confirm) => {
                if (confirm) {
                    // Reset all data arrays but keep settings and user
                    this.data.notes = [];
                    this.data.debts = [];
                    this.data.transactions = [];
                    this.data.products = [];
                    this.data.contacts = [];
                    this.saveData();
                    this.refreshUI();
                    this.showToast('Semua data telah dihapus.', 'success');
                }
            });
        },
        
        // --- UTILITIES ---
        generateCaptcha() {
            const chars = 'ABCDEFGHIJKLMNPQRSTUVWXYZ123456789';
            this.data.captchaText = '';
            for (let i = 0; i < 5; i++) {
                this.data.captchaText += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('captchaBox').textContent = this.data.captchaText;
        },
        
        showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            toast.className = 'toast show'; // Reset classes
            
            let iconClass = 'fas fa-info-circle';
            if (type === 'success') { toast.style.backgroundColor = 'var(--success-color)'; iconClass = 'fas fa-check-circle'; }
            if (type === 'error') { toast.style.backgroundColor = 'var(--danger-color)'; iconClass = 'fas fa-times-circle'; }
            if (type === 'warning') { toast.style.backgroundColor = 'var(--warning-color)'; iconClass = 'fas fa-exclamation-triangle'; }
            
            icon.className = iconClass;
            document.getElementById('toast-message').textContent = message;
            setTimeout(() => toast.classList.remove('show'), 3000);
        },

        showConfirmation(message, callback) {
            const dialog = document.getElementById('confirmationDialog');
            document.getElementById('confirmationMessage').textContent = message;
            dialog.style.display = 'flex';
            
            const okHandler = () => {
                dialog.style.display = 'none';
                callback(true);
                removeListeners();
            };
            const cancelHandler = () => {
                dialog.style.display = 'none';
                callback(false);
                removeListeners();
            };
            
            const confirmOk = document.getElementById('confirmOk');
            const confirmCancel = document.getElementById('confirmCancel');
            
            const removeListeners = () => {
                confirmOk.removeEventListener('click', okHandler);
                confirmCancel.removeEventListener('click', cancelHandler);
            };
            
            confirmOk.addEventListener('click', okHandler);
            confirmCancel.addEventListener('click', cancelHandler);
        },
        
        formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount || 0);
        }
    };

    // --- START THE APP ---
    App.init();

});
    </script>
</body>
</html>
